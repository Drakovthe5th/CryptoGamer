<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ğŸ™Œ CryptoGameMiner</title>

  <!-- Monetag SDK for rewarded ads -->
  <script src="//libtl.com/sdk.js" data-zone="9644715" data-sdk="show_9644715"></script>

  <!-- Telegram WebApp API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* ==== ROOT VARIABLES ==== */
    :root {
      --bg-dark: #0d0d0d;
      --text-light: #f5f5f5;
      --primary-yellow: #ffcc00;
      --secondary-gray: #1a1a1a;
      --accent-green: #00e676;
      --gradient-purple: linear-gradient(135deg,#3f51b5,#9c27b0);
      --texture: url('data:image/png;base64,iVBORw0K...'); /* you can replace with real texture */
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
    body {
      background: var(--bg-dark) var(--texture) fixed;
      color: var(--text-light);
      min-height: 100vh;
      padding-bottom: 70px;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 12px;
    }
    /* ==== HEADER ==== */
    .app-header {
      display:flex; justify-content:space-between; align-items:center;
      padding:16px; background: var(--secondary-gray);
      border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.5);
    }
    .profile-btn {
      background: var(--gradient-purple);
      padding:8px 12px; border:none; border-radius:20px;
      color:#fff; font-weight:600; cursor:pointer;
      display:flex; align-items:center; gap:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.4);
      transition:transform .2s;
    }
    .profile-btn:hover { transform:scale(1.05) }
    .balance-display {
      background: var(--accent-green); padding:8px 16px;
      border-radius:20px; font-weight:600; color:#000;
      box-shadow:0 2px 8px rgba(0,0,0,.4);
    }
    /* ==== PAGES ==== */
    .page { display:none; padding:16px; animation:fadeIn .3s ease-in; }
    .page.active { display:block; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    /* ==== SECTION ==== */
    .section {
      background: var(--secondary-gray);
      border-radius:12px; padding:16px;
      margin-bottom:16px;
      box-shadow: inset 0 0 10px rgba(0,0,0,.3);
    }
    .section-title {
      font-size:1.3rem; margin-bottom:12px;
      background: var(--gradient-purple);
      -webkit-background-clip: text; color: transparent;
    }
    /* ==== BUTTONS ==== */
    .btn {
      background: var(--primary-yellow);
      color: #000; border:none; border-radius:8px;
      padding:12px; font-weight:700; font-size:1rem;
      width:100%; cursor:pointer; margin:8px 0;
      box-shadow:0 3px 8px rgba(0,0,0,.4);
      transition:transform .2s, box-shadow .2s;
    }
    .btn:hover {
      transform:translateY(-2px);
      box-shadow:0 6px 12px rgba(0,0,0,.5);
    }
    .btn-secondary {
      background:transparent; color:var(--primary-yellow);
      border:2px solid var(--primary-yellow);
    }
    /* ==== CLICK AREA ==== */
    .click-area {
      background: #111; border:3px dashed var(--primary-yellow);
      height:160px; border-radius:12px;
      display:flex;justify-content:center;align-items:center;
      cursor:pointer; transition:background .2s;
    }
    .click-area:hover { background:#222 }
    .click-text { color:var(--primary-yellow); font-size:1.6rem; font-weight:800; }
    /* ==== NAVIGATION ==== */
    .nav-bar {
      position:fixed; bottom:0; left:0; right:0;
      background: var(--secondary-gray); display:flex;
      justify-content:space-around; padding:10px 0;
      box-shadow:0 -3px 12px rgba(0,0,0,.5);
    }
    .nav-btn {
      background:none; border:none; color:var(--text-light);
      display:flex; flex-direction:column; align-items:center;
      font-size:0.8rem; cursor:pointer; transition:color .2s;
    }
    .nav-btn.active { color:var(--primary-yellow); }
    /* ==== REFERRAL BOX ==== */
    .referral-box {
      background: var(--gradient-purple); padding:16px;
      border-radius:12px; text-align:center; color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.5);
    }
    .referral-link {
      background: #000; color:var(--primary-yellow);
      padding:8px; border-radius:6px; margin:12px 0;
      display:block; word-break:break-all;
    }
    /* ==== FORMS ==== */
    input, select {
      width:100%; padding:10px; margin-top:6px; border:none;
      border-radius:6px; background:#222; color:#fff;
    }
    /* ==== SECURITY ALERT ==== */
    .security-alert {
      background-color: #ff4d4d;
      color: white;
      padding: 8px;
      text-align: center;
      border-radius: 4px;
      margin: 10px auto;
      max-width: 480px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Security Alert -->
    <div class="security-alert" id="security-alert">
      Suspicious activity detected! Account temporarily restricted.
    </div>

    <!-- HEADER -->
    <header class="app-header">
      <button class="profile-btn" onclick="showPage('profile')">
        <span>ğŸ‘¤</span><span id="profile-username">User123</span>
      </button>
      <div class="balance-display"><span id="balance">0.00</span> TON</div>
    </header>

    <div class="game-grid">
      <!-- Spin Game -->
      <div class="game-card" onclick="launchGame('spin')">
          <div class="game-icon" style="background-image: url('/games/spin/static/icon.png')"></div>
          <div class="game-name">TON Spin Wheel</div>
      </div>
      
      <!-- Clicker Game -->
      <div class="game-card" onclick="launchGame('clicker')">
          <div class="game-icon" style="background-image: url('/games/clicker/static/icon.png')"></div>
          <div class="game-name">TON Clicker Miner</div>
      </div>
      
        <!-- Other games... -->
    </div>

    <script>
      
      function launchGame(gameName) {
          Telegram.WebApp.showPopup({
              title: `Play ${gameName.replace(/^\w/, c => c.toUpperCase())}`,
              message: 'Earn TON coins while playing!',
              buttons: [{
                  id: 'play',
                  type: 'default',
                  text: 'Play Now'
              }]
          }, (btnId) => {
              if (btnId === 'play') {
                  window.location.href = `/games/${gameName}`;
              }
          });
      }
  </script>

    <!-- HOME -->
    <div id="home-page" class="page active">
      <div class="section">
        <h2 class="section-title">Daily Bonus</h2>
        <p>Grab your daily reward and keep the fun rolling!</p>
        <button class="btn" onclick="claimDailyBonus()">ğŸ Claim 0.05 TON</button>
      </div>
      <div class="section">
        <h2 class="section-title">Click & Earn</h2>
        <div class="click-area" onclick="earnFromClick()">
          <div class="click-text">CLICK TO EARN</div>
        </div>
        <p class="text-center">Clicks today: <span id="click-count">0</span>/100</p>
      </div>
      <div class="section">
        <h2 class="section-title">Featured Games</h2>
        <button class="btn" onclick="showPage('games')">ğŸ® Trivia Quiz</button>
        <button class="btn" onclick="showPage('games')">ğŸ¡ Spin Wheel</button>
      </div>
    </div>

    <!-- WATCH -->
    <div id="watch-page" class="page">
      <div class="section">
        <h2 class="section-title">Watch & Earn</h2>
        <p>Watch video ads and boost your TON balance.</p>
        <button class="btn" onclick="rewardedInterstitial()">â–¶ï¸ Watch & Earn 0.1 TON</button>
      </div>
      <div class="section" style="padding:0;overflow:hidden;">
        <!-- A-ADS Banner -->
        <div id="frame" style="width:100%;height:200px;">
          <iframe data-aa="2405512" src="//acceptable.a-ads.com/2405512"
                  style="border:0;width:100%;height:100%;"></iframe>
          <a style="display:block;text-align:right;font-size:10px;color:#888;"
             href="https://aads.com/campaigns/new/?source_id=2405512">
            Advertise here
          </a>
        </div>
      </div>
    </div>

    <!-- WALLET -->
    <div id="wallet-page" class="page">
      <div class="section">
        <h2 class="section-title">Wallet</h2>
        <p class="text-center" style="font-size:2rem;"><span id="wallet-balance">0.00</span> TON</p>
        <div style="display:flex;gap:8px;">
          <button class="btn-secondary btn" onclick="showPage('otc')">ğŸ“¥ Receive</button>
          <button class="btn-secondary btn" onclick="showPage('otc')">ğŸ“¤ Send</button>
          <button class="btn-secondary btn" onclick="showPage('otc')">ğŸ’± Sell</button>
        </div>
      </div>
      <div class="section">
        <h2 class="section-title">Staking</h2>
        <p>Earn <span style="color:var(--accent-green)">8.5% APY</span> on 5+ TON</p>
        <button class="btn" onclick="stake()">ğŸ’° Stake Now</button>
      </div>
    </div>

    <div id="balance" class="balance-skeleton">
      <div class="skeleton-loader"></div>
    </div>

    <div id="global-spinner" class="spinner-overlay">
      <div class="spinner"></div>
    </div>

    <!-- GAMES -->
    <div id="games-page" class="page">
      <div class="section">
        <h2 class="section-title">Games</h2>
        <button class="btn" onclick="playGame('trivia')">â“ Trivia</button>
        <button class="btn" onclick="playGame('spin')">ğŸ¡ Spin</button>
        <button class="btn" onclick="playGame('click')">ğŸ–±ï¸ Click</button>
        <button class="btn" onclick="playGame('trex')">ğŸ² Trex Runner</button>
      </div>
    </div>

    <!-- QUESTS -->
    <div id="quests-page" class="page">
      <div class="section">
        <h2 class="section-title">Daily Quests</h2>
        <div class="quest-item"><span>âœ… Claim bonus</span><button class="btn-secondary btn" disabled>Done</button></div>
        <div class="quest-item"><span>â³ Watch 3 ads (<span id="quest-ads">0</span>/3)</span><button class="btn btn-secondary" onclick="rewardedInterstitial()">Watch</button></div>
        <div class="quest-item"><span>â³ Invite friend (<span id="quest-invite">0</span>/1)</span><button class="btn" onclick="showPage('referrals')">Invite</button></div>
      </div>
      <div class="section">
        <h2 class="section-title">Missions</h2>
        <button class="btn" onclick="shareMission()">ğŸ“± Share & Earn</button>
      </div>
    </div>

    <!-- OTC DESK -->
    <div id="otc-page" class="page">
      <div class="section">
        <h2 class="section-title">OTC Exchange</h2>
        <label>Amount (TON)</label><input type="number" id="otc-amount" placeholder="0.00" />
        <label>Currency</label><select id="otc-currency"><option>USDT</option><option>KES</option><option>USD</option></select>
        <button class="btn" onclick="swapTon()">ğŸ’± Swap TON</button>
      </div>
      <div class="section">
        <h2 class="section-title">Rates</h2>
        <p>1 TON = $5.82 USD</p>
        <p>1 TON = 750 KES</p>
      </div>
    </div>

    <!-- REFERRALS -->
    <div id="referrals-page" class="page">
      <div class="referral-box">
        <h2>Invite & Earn</h2>
        <p>20% of friend's earnings</p>
        <div class="referral-link" id="ref-link">https://t.me/CryptoGameMinerBot?start=ref-xyz</div>
        <button class="btn" onclick="copyReferralLink()">ğŸ“‹ Copy Link</button>
      </div>
      <div class="section">
        <h2 class="section-title">Your Referrals</h2>
        <p>Invited: <span id="ref-count">0</span></p>
        <p>Earned: <span id="ref-earnings">0.00</span> TON</p>
        <ul style="margin-top:8px;padding-left:20px;list-style-type:disc;color:var(--text-light);">
          <li>3 â†’ 0.01 TON</li>
          <li>10 â†’ 0.03 TON</li>
          <li>50 â†’ 0.20 TON</li>
          <li>100 â†’ 0.50 TON</li>
        </ul>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="profile-page" class="page">
      <div class="section">
        <h2 class="section-title">Profile</h2>
        <p><strong>Username:</strong> <span id="profile-name">User123</span></p>
        <p><strong>Balance:</strong> <span id="profile-balance">0.00</span> TON</p>
      </div>
      <div class="section">
        <h2 class="section-title">Achievements</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <div class="btn-secondary btn">ğŸ† Streak</div>
          <div class="btn-secondary btn">â­ First Win</div>
          <div class="btn-secondary btn">ğŸ’ Top Earner</div>
        </div>
      </div>
      <div class="section">
        <h2 class="section-title">Info & Settings</h2>
        <button class="btn-secondary btn" onclick="showHelp()">â“ Help</button>
        <button class="btn-secondary btn" onclick="showAbout()">ğŸ“œ About</button>
        <button class="btn-secondary btn" onclick="showTerms()">ğŸ“„ Terms</button>
        <button class="btn-secondary btn" onclick="showPrivacy()">ğŸ”’ Privacy</button>
      </div>
    </div>

  </div>

  <!-- NAV -->
  <div class="nav-bar">
    <button class="nav-btn active" onclick="showPage('home')">ğŸ <br/>Home</button>
    <button class="nav-btn" onclick="showPage('watch')">ğŸ“º<br/>Watch</button>
    <button class="nav-btn" onclick="showPage('wallet')">ğŸ’°<br/>Wallet</button>
    <button class="nav-btn" onclick="showPage('games')">ğŸ®<br/>Games</button>
    <button class="nav-btn" onclick="showPage('quests')">ğŸ“<br/>Quests</button>
    <button class="nav-btn" onclick="showPage('otc')">ğŸ’±<br/>OTC</button>
    <button class="nav-btn" onclick="showPage('referrals')">ğŸ‘¥<br/>Referrals</button>
  </div>

  <script>
    
    // Global state
    const SECURITY_CHECK_INTERVAL = 30000; // 30 seconds
    const tg = window.Telegram.WebApp;
    let userData = {
      id: null,
      username: 'Guest',
      balance: 0,
      clicks: 0,
      referrals: 0,
      refEarnings: 0,
      bonusClaimed: false,
      lastSecurityCheck: 0
    };
    let securityTimer = null;

    // API helper with security headers
    async function apiRequest(endpoint, method = 'GET', body = null) {
      const headers = {
        'Content-Type': 'application/json',
        'X-Telegram-Init-Data': tg.initData,
        'X-Security-Token': generateSecurityToken()
      };
      
      try {
        const response = await fetch(endpoint, {
          method,
          headers,
          body: body ? JSON.stringify(body) : null,
          credentials: 'include'
        });
        
        // Handle security flags
        if (response.status === 403) {
          document.getElementById('security-alert').style.display = 'block';
          tg.showAlert('Security restriction applied. Contact support.');
          return null;
        }
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'API request failed');
        }
        
        return await response.json();
      } catch (error) {
        tg.showAlert(error.message || 'Request failed');
        throw error;
      }
    }

    // Generate security token based on time and user ID
    function generateSecurityToken() {
      const now = Math.floor(Date.now() / 1000);
      const tokenData = `${userData.id || 'anon'}:${now}`;
      return btoa(tokenData);
    }

    // Security monitoring
    function startSecurityMonitoring() {
      securityTimer = setInterval(async () => {
        try {
          const response = await apiRequest('/api/security/check');
          if (response && response.restricted) {
            document.getElementById('security-alert').style.display = 'block';
          }
        } catch (error) {
          console.error('Security check failed:', error);
        }
      }, SECURITY_CHECK_INTERVAL);
    }

    // Navigation
    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(id + '-page').classList.add('active');
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      ['home', 'watch', 'wallet', 'games', 'quests', 'otc', 'referrals'].forEach((pg, i) => {
        if (pg === id) document.querySelectorAll('.nav-btn')[i].classList.add('active');
      });
    }

    // UI update
    function updateUI() {
      document.querySelectorAll('#balance').forEach(el => el.textContent = userData.balance.toFixed(2));
      document.getElementById('wallet-balance').textContent = userData.balance.toFixed(2);
      document.getElementById('click-count').textContent = userData.clicks;
      document.querySelectorAll('#profile-name, #profile-username').forEach(el => {
        el.textContent = userData.username;
      });
      document.getElementById('ref-count').textContent = userData.referrals;
      document.getElementById('ref-earnings').textContent = userData.refEarnings.toFixed(2);
      document.querySelectorAll('#profile-balance').forEach(el => {
        el.textContent = userData.balance.toFixed(2);
      });
    }

    // Load user data from backend
    async function loadUserData() {
      try {
        const response = await apiRequest('/api/user/secure-data');
        if (response.token) {
          // Verify JWT server-side
          const userData = parseJwt(response.token);
          document.querySelectorAll('#balance').forEach(el => {
            el.textContent = `Balance: ${userData.balance.toFixed(6)} TON`;
          });
          // Store in session instead of global object
          sessionStorage.setItem('userData', JSON.stringify({
            id: userData.id,
            username: userData.username,
            balance: userData.balance
          }));
        }
      } catch (error) {
        console.error('Secure data load failed:', error);
      }
    }

    // Claim daily bonus with security check
    async function claimDailyBonus() {
      try {
        const response = await apiRequest('/api/security/check');
        if (response && response.restricted) {
          tg.showAlert('Account restricted. Cannot claim bonus.');
          return;
        }
        
        const result = await apiRequest('/api/quests/claim_bonus', 'POST', {
          user_id: userData.id
        });
        
        if (result && result.success) {
          userData.balance = result.new_balance;
          userData.bonusClaimed = true;
          updateUI();
          tg.showPopup({
            title: 'Bonus Claimed!', 
            message: '+0.05 TON added to your balance',
            buttons: [{id: 'ok', type: 'ok'}]
          });
        }
      } catch (error) {
        console.error('Claim bonus failed:', error);
      }
    }

    // Earn from click with security check
    async function earnFromClick() {
      try {
        const response = await apiRequest('/api/security/check');
        if (response && response.restricted) {
          tg.showAlert('Account restricted. Cannot earn from clicks.');
          return;
        }
        
        if (userData.clicks >= 100) {
          return tg.showPopup({
            title: 'Limit Reached!',
            message: 'Try again tomorrow',
            buttons: [{id: 'ok', type: 'ok'}]
          });
        }
        
        const result = await apiRequest('/api/quests/record_click', 'POST', {
          user_id: userData.id
        });
        
        if (result) {
          userData.clicks = result.clicks;
          userData.balance = result.balance;
          updateUI();
          
          // Visual feedback
          const clickArea = document.querySelector('.click-area');
          clickArea.style.transform = 'scale(0.95)';
          setTimeout(() => clickArea.style.transform = 'scale(1)', 120);
        }
      } catch (error) {
        console.error('Click failed:', error);
      }
    }

    // Watch ad and get rewarded with security
    async function rewardedInterstitial() {
      try {
        const response = await apiRequest('/api/security/check');
        if (response && response.restricted) {
          tg.showAlert('Account restricted. Cannot watch ads.');
          return;
        }
        
        // Show ad using Monetag SDK
        await show_9644715();
        
        // Record ad view and get reward
        const result = await apiRequest('/api/ads/reward', 'POST', {
          user_id: userData.id,
          ad_id: 'monetag_9644715'
        });
        
        if (result) {
          userData.balance = result.new_balance;
          updateUI();
          
          tg.showPopup({
            title: 'Ad Watched!', 
            message: `+${result.reward.toFixed(2)} TON added to your balance`,
            buttons: [{id: 'ok', type: 'ok'}]
          });
        }
      } catch (error) {
        console.error('Ad failed:', error);
        tg.showPopup({
          title: 'Ad Error', 
          message: 'Failed to show ad. Please try again.',
          buttons: [{id: 'ok', type: 'ok'}]
        });
      }
    }

    // Wallet stubs
    function receive() { 
      try {
        tg?.showInvoice && tg.showInvoice(); 
      } catch (e) {
        console.error('Receive failed:', e);
      }
    }
    
    function send() { 
      try {
        tg?.sendData && tg.sendData('send'); 
      } catch (e) {
        console.error('Send failed:', e);
      }
    }
    
    function stake() { 
      try {
        tg?.showPopup({
          title: 'Stake', 
          message: 'Stake 5 TON @8.5% APY',
          buttons: [{id: 'ok', type: 'ok'}]
        }); 
      } catch (e) {
        console.error('Stake failed:', e);
      }
    }

    // Games
    function playGame(type) {
      try {
        const labels = {
          trivia: 'Trivia Quiz',
          spin: 'Spin Wheel',
          click: 'Click Game',
          trex: 'Trex Runner'
        };
        tg?.showPopup({
          title: 'Game Launching', 
          message: `Starting ${labels[type] || 'Game'}`,
          buttons: [{id: 'ok', type: 'ok'}]
        });
      } catch (e) {
        console.error('Game launch failed:', e);
      }
    }

    // Quests
    function shareMission() {
      try {
        tg?.showPopup({
          title: 'Share', 
          message: 'Thanks for sharing!',
          buttons: [{id: 'ok', type: 'ok'}]
        });
      } catch (e) {
        console.error('Share failed:', e);
      }
    }

    // OTC
    function swapTon() {
      try {
        const amt = +document.getElementById('otc-amount').value || 0;
        const cur = document.getElementById('otc-currency').value;
        tg?.showPopup({
          title: 'Swapped', 
          message: `${amt} TON â†’ ${cur}`,
          buttons: [{id: 'ok', type: 'ok'}]
        });
      } catch (e) {
        console.error('Swap failed:', e);
      }
    }

    // Referrals
    function copyReferralLink() {
      try {
        navigator.clipboard.writeText(document.getElementById('ref-link').textContent);
        tg?.showPopup({
          title: 'Copied', 
          message: 'Referral link copied',
          buttons: [{id: 'ok', type: 'ok'}]
        });
      } catch (e) {
        console.error('Copy failed:', e);
      }
    }

    // Profile Info
    function showHelp() { 
      tg?.showPopup({
        title: 'Help', 
        message: 'support@cryptogamer.com',
        buttons: [{id: 'ok', type: 'ok'}]
      }); 
    }
    
    function showAbout() { 
      tg?.showPopup({
        title: 'About', 
        message: 'CryptoGameMiner v1.0',
        buttons: [{id: 'ok', type: 'ok'}]
      }); 
    }
    
    function showTerms() { 
      tg?.showPopup({
        title: 'TOS', 
        message: 'Our terms...',
        buttons: [{id: 'ok', type: 'ok'}]
      }); 
    }
    
    function showPrivacy() { 
      tg?.showPopup({
        title: 'Privacy', 
        message: 'Our policy...',
        buttons: [{id: 'ok', type: 'ok'}]
      }); 
    }

    function showSpinner() {
      document.getElementById('global-spinner').style.display = 'flex';
    }

    function hideSpinner() {
      document.getElementById('global-spinner').style.display = 'none';
    }

    // Example usage in API calls
    async function loadUserData() {
      showSpinner();
      try {
        // API call here
      } catch (error) {
        // Handle error
      } finally {
        hideSpinner();
      }
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        tg.ready();
        tg.expand();
        
        // Get user ID from Telegram
        userData.id = tg.initDataUnsafe.user?.id;
        if (!userData.id) throw new Error('User ID missing');
        
        // Load user data from backend
        await loadUserData();
        
        // Start security monitoring
        startSecurityMonitoring();
        
        // Show welcome message
        tg.showPopup({
          title: 'Welcome!', 
          message: `Let's earn TON, ${userData.username}!`,
          buttons: [{id: 'ok', type: 'ok'}]
        });
      } catch (error) {
        console.error('Initialization failed:', error);
        tg.showAlert('Failed to initialize app. Please try again.');
      }
    });

    // Cleanup on exit
    window.addEventListener('beforeunload', () => {
      if (securityTimer) clearInterval(securityTimer);
    });
  </script>
</body>
</html>