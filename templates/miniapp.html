<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>CryptoGamer - TON Game Miner</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="/static/css/miniapp.css">
  <link rel="stylesheet" href="/static/css/main.css">
  <style>
    /* Additional styles to match miniapp-old.html functionality */
    .page { display: none; }
    .page.active { display: block; }
    .hidden { display: none; }
    .milestone { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; margin-bottom: 10px; }
    .milestone.reached { background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50; }
    .currency-option { flex: 1; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; text-align: center; cursor: pointer; border: 1px solid transparent; }
    .currency-option.active { background: rgba(255, 215, 0, 0.1); border-color: #ffd700; }
    .click-area { background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; border-radius: 15px; height: 150px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; margin: 15px 0; cursor: pointer; transition: all 0.3s; }
    .click-area:active { transform: scale(0.95); }
    @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-30px); opacity: 0; } }
    
    /* New styles for fixes */
    .quest-button { 
      background: rgba(255, 215, 0, 0.2); 
      border: 1px solid #ffd700; 
      border-radius: 8px; 
      padding: 8px 12px; 
      color: #ffd700; 
      cursor: pointer; 
      transition: all 0.3s; 
    }
    .quest-button:hover { 
      background: rgba(255, 215, 0, 0.3); 
    }
    .quest-button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    .currency-dropdown {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: white;
      border: 2px solid rgba(255,255,255,0.1);
      margin-bottom: 16px;
    }
    .loading { 
      opacity: 0.7; 
      pointer-events: none; 
    }
        /* Add these styles for shop navigation */
    .shop-container {
      padding: 15px;
    }
    .shop-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .shop-item-info {
      flex: 1;
    }
    .shop-item-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .shop-item-price {
      color: #ffd700;
    }
    .shop-item-button {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid #ffd700;
      border-radius: 5px;
      padding: 8px 12px;
      color: white;
      cursor: pointer;
    }
    .shop-item-button:hover {
      background: rgba(255, 215, 0, 0.3);
    }
    .balance-loading {
      opacity: 0.7;
      font-style: italic;
    }

  </style>
</head>
<body>
  <!-- Background animation elements -->
  <div class="bg-animation">
    <div class="ball ball-1"></div>
    <div class="ball ball-2"></div>
    <div class="ball ball-3"></div>
    <div class="ball ball-4"></div>
  </div>

  <!-- Floating Shop Button -->
  <a href="/games/static/shop.html" class="shop-floating-btn">üõí</a>

  <!-- Header with profile -->
  <header class="app-header">
    <div class="profile-section">
      <div class="profile-toggle" id="profile-toggle">
        <img src="/static/images/default-avatar.png" alt="Profile" class="profile-avatar">
        <span class="username" id="username">Loading...</span>
      </div>
      <div class="balance-display">
          <span id="gc-balance">0</span> GC ‚âà
          <span id="ton-equivalent">0.000000</span> TON
      </div>
    </div>
  </header>

  <!-- Profile Menu (initially hidden) -->
  <div class="profile-menu" id="profile-menu">
    <div class="menu-header">
      <h3>User Profile</h3>
      <button class="close-menu" id="close-menu">&times;</button>
    </div>
    <div class="menu-content">
      <div class="user-info">
        <img src="/static/images/default-avatar.png" alt="Profile" class="menu-avatar">
        <div class="user-details">
          <span class="menu-username" id="menu-username">Username</span>
          <span class="menu-balance" id="menu-balance">0.000000 TON</span>
        </div>
      </div>
      
      <div class="profile-stats" style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; margin: 16px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span>Current Balance:</span>
          <span style="color: #4CAF50; font-weight: bold;"><span id="profile-balance">0.000000</span> TON</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span>Total Earned:</span>
          <span style="color: #ffd700; font-weight: bold;"><span id="profile-total-earned">0.000000</span> TON</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span>Account Level:</span>
          <span style="color: #888;" id="account-level">Beginner</span>
        </div>
      </div>
      
      <div class="menu-items">
        <a href="#" class="menu-item" data-page="achievements">
          <span class="icon">üèÜ</span>
          <span>Achievements</span>
        </a>
        <a href="#" class="menu-item" data-page="support">
          <span class="icon">‚ùì</span>
          <span>Help & Support</span>
        </a>
        <a href="#" class="menu-item" data-page="invite">
          <span class="icon">üë•</span>
          <span>Invite Friends</span>
        </a>
        <a href="#" class="menu-item" data-page="about">
          <span class="icon">‚ÑπÔ∏è</span>
          <span>About CryptoGamer</span>
        </a>
        <a href="#" class="menu-item" data-page="terms">
          <span class="icon">üìÑ</span>
          <span>Terms of Service</span>
        </a>
        <a href="#" class="menu-item" data-page="privacy">
          <span class="icon">üîí</span>
          <span>Privacy Policy</span>
        </a>
        <a href="#" class="menu-item" onclick="logout()">
          <span class="icon">üö™</span>
          <span>Logout</span>
        </a>
      </div>
    </div>
  </div>

  <button class="back-button" onclick="history.back()">‚Üê</button>

  <!-- Main content area -->
  <main class="main-content">
    <!-- Home Page -->
    <section id="home-page" class="page active">
      <!-- Daily Bonus Popup -->
      <div class="daily-bonus-popup" id="daily-bonus-popup">
        <div class="bonus-content">
          <h3>üéÅ Daily Bonus</h3>
          <p>Claim your 0.05 TON daily reward!</p>
          <button class="claim-bonus" id="claim-bonus">Claim Now</button>
        </div>
      </div>
      
      <!-- Click & Earn Section -->
      <div class="click-game-preview">
        <h3>‚ö° Click & Earn</h3>
        <div class="click-area" onclick="handleClickEarn()">
          <div class="click-text">TAP TO EARN</div>
        </div>
        <p style="text-align: center;">
          Clicks today: <span id="click-count" style="color: #ffd700; font-weight: bold;">0</span>/100
        </p>
      </div>
      
      <!-- Featured Games -->
      <div class="home-section">
        <h2 class="section-title">üéÆ Featured Games</h2>
        <div class="game-grid">
          <div class="game-card" data-game-id="trivia">
            <div class="game-icon">‚ùì</div>
            <div class="game-name">Crypto Trivia</div>
          </div>
          <div class="game-card" data-game-id="spin">
            <div class="game-icon">üé°</div>
            <div class="game-name">Lucky Spin</div>
          </div>
          <div class="game-card" data-game-id="clicker">
            <div class="game-icon">üñ±Ô∏è</div>
            <div class="game-name">TON Clicker</div>
          </div>
          <div class="game-card" data-game-id="trex">
            <div class="game-icon">ü¶ñ</div>
            <div class="game-name">T-Rex Runner</div>
          </div>
        </div>
      </div>
      
      <!-- Ad Space -->
      <div class="home-section">
        <div class="ad-slot" id="home-ad-slot" style="height: 120px;">
          <!-- Ad content will be loaded here -->
        </div>
      </div>
    </section>

    <!-- Watch Page -->
    <section id="watch-page" class="page">
      <div class="page-header">
        <h2>üì∫ Watch & Earn</h2>
        <p>Watch video ads and earn TON coins instantly!</p>
        <button class="btn btn-primary" style="width: 100%; margin: 15px 0;" onclick="watchAd()">
          ‚ñ∂Ô∏è Watch Ad & Earn TON
        </button>
        <div style="padding: 12px; background: rgba(255,204,0,0.1); border-radius: 8px;">
          <small style="color: #ffcc00;">üí° Tip: Weekend ads give 20% bonus!</small>
        </div>

        <div class="ad-slot" id="watch-ad-1" style="height: 200px; margin: 15px 0;"></div>
        <div class="ad-slot" id="watch-ad-2" style="height: 200px; margin: 15px 0;"></div>
        <div class="ad-slot" id="watch-ad-3" style="height: 200px; margin: 15px 0;"></div>
      </div>
    </section>

    <!-- Wallet Page -->
    <section id="wallet-page" class="page">
      <div class="page-header">
        <h2>üí∞ Your Wallet</h2>
      </div>
      
      <div class="home-section">
        <div style="text-align: center; margin: 20px 0;">
          <div style="font-size: 1.5rem; color: #4CAF50;">
            <span id="wallet-gc-balance">0</span> GC
          </div>
          <div style="color: #888; margin-top: 8px;">
            ‚âà <span id="wallet-ton-equivalent">0.00</span> TON
          </div>
          <div style="color: #666; margin-top: 4px; font-size: 0.8rem;">
            200,000 GC = 100 TON
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px;">
          <button class="btn btn-primary" onclick="showWithdrawalForm()">
            üì§ Withdraw
          </button>
          <button class="btn btn-primary" onclick="connectWallet()">
            üîó Connect Wallet
          </button>
        </div>
      </div>

      <!-- Withdrawal Form -->
      <div class="home-section" id="withdrawal-form" style="display: none;">
        <h3 style="margin-bottom: 16px; color: #ffd700;">Withdraw TON</h3>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">TON Wallet Address</label>
          <input type="text" id="withdraw-address" placeholder="EQxxxxx..." style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); color: white; border: 2px solid rgba(255,255,255,0.1);" />
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Amount (TON)</label>
          <input type="number" id="withdraw-amount" placeholder="0.000000" step="0.000001" min="0.1" style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); color: white; border: 2px solid rgba(255,255,255,0.1);" />
          <small style="color: #888;">Minimum withdrawal: 0.1 TON</small>
        </div>
        
        <div style="display: flex; gap: 8px;">
          <button class="btn" style="background: rgba(255,255,255,0.1); flex: 1;" onclick="hideWithdrawalForm()">Cancel</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="processWithdrawal()">Withdraw</button>
        </div>
      </div>

      <!-- Stats Section -->
      <div class="home-section">
        <h2 class="section-title">üìä Stats</h2>
        <div class="game-grid">
          <div class="game-card">
            <div class="stat-value" id="total-earned">0.000000</div>
            <div class="stat-label">Total Earned</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="games-played">0</div>
            <div class="stat-label">Games Played</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="ads-watched">0</div>
            <div class="stat-label">Ads Watched</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="referrals-count">0</div>
            <div class="stat-label">Referrals</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Games Page -->
    <section id="games-page" class="page">
      <div class="page-header">
        <h2>üéÆ All Games</h2>
        <p style="margin-bottom: 20px; color: #ccc;">
          Play games, earn TON coins, and climb the leaderboards!
        </p>
        
        <div class="game-grid">
          <div class="game-card" data-game-id="trivia">
            <div class="game-icon">‚ùì</div>
            <div class="game-name">Crypto Trivia</div>
            <small style="color: #888;">Test your knowledge</small>
          </div>
          
          <div class="game-card" data-game-id="spin">
            <div class="game-icon">üé°</div>
            <div class="game-name">Lucky Spin</div>
            <small style="color: #888;">Spin to win big</small>
          </div>
          
          <div class="game-card" data-game-id="clicker">
            <div class="game-icon">üñ±Ô∏è</div>
            <div class="game-name">TON Clicker</div>
            <small style="color: #888;">Click for rewards</small>
          </div>
          
          <div class="game-card" data-game-id="trex">
            <div class="game-icon">ü¶ñ</div>
            <div class="game-name">T-Rex Runner</div>
            <small style="color: #888;">Endless runner</small>
          </div>
          
          <div class="game-card" data-game-id="edge-surf">
            <div class="game-icon">üèÑ</div>
            <div class="game-name">Edge Surf</div>
            <small style="color: #888;">Surf the web</small>
          </div>
          
          <div class="game-card" style="opacity: 0.6;">
            <div class="game-icon">üé≤</div>
            <div class="game-name">More Games</div>
            <small style="color: #888;">Coming soon</small>
          </div>
        </div>
      </div>
    </section>

    <!-- Quests Page -->
    <section id="quests-page" class="page">
      <div class="page-header">
        <h2>üìù Daily Quests</h2>
        <p style="margin-bottom: 16px; color: #ccc;">
          Complete daily tasks to earn bonus rewards!
        </p>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">‚úÖ Claim Daily Bonus</div>
            <small style="color: #888;">Reward: 0.05 TON</small>
          </div>
          <button class="quest-button" id="quest-bonus-btn">Claim</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üì∫ Watch 3 Ads</div>
            <small style="color: #888;">Progress: <span id="quest-ads">0</span>/3 | Reward: 0.009 TON</small>
          </div>
          <button class="quest-button" onclick="showPage('watch')">Watch</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üéÆ Play 2 Games</div>
            <small style="color: #888;">Progress: <span id="quest-games">0</span>/2 | Reward: 0.006 TON</small>
          </div>
          <button class="quest-button" onclick="showPage('games')">Play</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üë• Invite 1 Friend</div>
            <small style="color: #888;">Progress: <span id="quest-invite">0</span>/1 | Reward: 0.05 TON</small>
          </div>
          <button class="quest-button" onclick="showPage('referrals')">Invite</button>
        </div>
      </div>

      <div class="home-section">
        <h2 class="section-title">üèÜ Weekly Challenges</h2>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üî• 7-Day Streak</div>
            <small style="color: #888;">Login daily for a week | Reward: 0.5 TON</small>
          </div>
          <div style="color: #ffd700; font-weight: bold;" id="daily-streak">0/7</div>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üíØ Score 1000+ Points</div>
            <small style="color: #888;">In any game | Reward: 0.1 TON</small>
          </div>
          <div style="color: #888;" id="high-score">0/1000</div>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üì± Share App</div>
            <small style="color: #888;">Share with 5 friends | Reward: 0.25 TON</small>
          </div>
          <button class="quest-button" id="share-app-btn">Share</button>
        </div>
      </div>
    </section>

    <!-- OTC Desk Page -->
    <section id="otc-page" class="page">
      <div class="page-header">
        <h2>üí± OTC Exchange</h2>
        <p style="margin-bottom: 20px; color: #ccc;">
          Trade your TON for fiat currencies instantly!
        </p>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Amount (TON)</label>
          <input type="number" id="otc-amount" placeholder="0.000000" step="0.000001" min="0.1" style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); color: white; border: 2px solid rgba(255,255,255,0.1);" />
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Currency</label>
          <select class="currency-dropdown" id="otc-currency">
            <option value="USDT">USDT</option>
            <option value="USD">USD</option>
            <option value="KES">KES</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        
        <div id="conversion-preview" style="background: rgba(255,204,0,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;">
          <div style="color: #ffd700; font-weight: 600;">Conversion Preview:</div>
          <div id="conversion-text"></div>
          <small style="color: #888;" id="fee-text">Fee: 3% (min $1.00)</small>
        </div>
        
        <button class="btn btn-primary" id="swap-ton-btn" style="width: 100%;">
          üí± Swap TON for Cash
        </button>
      </div>

      <div class="home-section">
        <h2 class="section-title">üíπ Current Rates</h2>
        <div class="game-grid">
          <div class="game-card">
            <div class="stat-value" id="rate-usd">$6.80</div>
            <div class="stat-label">1 TON = USD</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="rate-kes">950</div>
            <div class="stat-label">1 TON = KES</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="rate-eur">‚Ç¨6.20</div>
            <div class="stat-label">1 TON = EUR</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="rate-usdt">6.75</div>
            <div class="stat-label">1 TON = USDT</div>
          </div>
        </div>
        <small style="color: #888; display: block; text-align: center; margin-top: 12px;">
          ‚è∞ Rates updated every 5 minutes
        </small>
      </div>
    </section>

    <!-- Referrals Page -->
    <section id="referrals-page" class="page">
      <div class="page-header">
        <h2>üë• Invite & Earn</h2>
        <p style="margin: 12px 0;">Earn 20% of your friends' earnings forever!</p>
        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin: 15px 0; word-break: break-all;" id="ref-link">
          https://t.me/CryptoGameMinerBot?start=ref-xyz123
        </div>
        <button class="btn btn-primary" id="copy-ref-btn" style="width: 100%;">
          üìã Copy Invite Link
        </button>
      </div>

      <div class="home-section">
        <h2 class="section-title">üìä Your Referral Stats</h2>
        <div class="game-grid">
          <div class="game-card">
            <div class="stat-value" id="ref-count">0</div>
            <div class="stat-label">Friends Invited</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="ref-earnings">0.000000</div>
            <div class="stat-label">Total Earned (TON)</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="ref-active">0</div>
            <div class="stat-label">Active This Week</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="ref-level">1</div>
            <div class="stat-label">Referrer Level</div>
          </div>
        </div>
      </div>

      <div class="home-section">
        <h2 class="section-title">üéØ Referral Milestones</h2>
        
        <div class="milestone">
          <span>ü•â 3 referrals ‚Üí Bonus 0.01 TON</span>
          <span style="color: #4CAF50;" id="milestone-3">0/3</span>
        </div>
        <div class="milestone">
          <span>ü•à 10 referrals ‚Üí Bonus 0.05 TON</span>
          <span style="color: #888;" id="milestone-10">0/10</span>
        </div>
        <div class="milestone">
          <span>ü•á 50 referrals ‚Üí Bonus 0.25 TON</span>
          <span style="color: #888;" id="milestone-50">0/50</span>
        </div>
        <div class="milestone">
          <span>üíé 100 referrals ‚Üí Bonus 1.0 TON</span>
          <span style="color: #888;" id="milestone-100">0/100</span>
        </div>
      </div>
    </section>


  <!-- Shop Page Section -->
    <section id="shop-page" class="page">
      <div class="page-header">
        <h2>üõí Game Shop</h2>
        <p>Enhance your gaming experience with powerful items!</p>
      </div>
      
      <div class="shop-container">
        <div style="text-align: center; margin: 20px 0;">
          <div class="coins-display" id="miniapp-gc-balance">
            <span class="balance-loading" id="balance-loading">Loading balance...</span>
            <span id="balance-value" style="display: none;"></span>
          </div>
        </div>
        
        <div class="shop-items-mini">
          <div class="shop-item">
            <div class="shop-item-info">
              <div class="shop-item-name">2x Earnings Booster</div>
              <div class="shop-item-price">2000 GC</div>
            </div>
            <button class="shop-item-button" onclick="purchaseItem('global_booster', 2000)">Buy</button>
          </div>
          
          <div class="shop-item">
            <div class="shop-item-info">
              <div class="shop-item-name">Trivia Time Extender</div>
              <div class="shop-item-price">500 GC</div>
            </div>
            <button class="shop-item-button" onclick="purchaseItem('trivia_extra_time', 500)">Buy</button>
          </div>
          
          <div class="shop-item">
            <div class="shop-item-info">
              <div class="shop-item-name">Extra Spin</div>
              <div class="shop-item-price">300 GC</div>
            </div>
            <button class="shop-item-button" onclick="purchaseItem('spin_extra_spin', 300)">Buy</button>
          </div>
          
          <div class="shop-item">
            <div class="shop-item-info">
              <div class="shop-item-name">Auto-Clicker</div>
              <div class="shop-item-price">1000 GC</div>
            </div>
            <button class="shop-item-button" onclick="purchaseItem('clicker_auto_upgrade', 1000)">Buy</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Navigation Bar -->
<nav class="bottom-nav">
    <a href="#home" class="nav-item active" data-page="home">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Home</span>
    </a>
    <a href="#watch" class="nav-item" data-page="watch">
        <span class="nav-icon">üì∫</span>
        <span class="nav-label">Watch</span>
    </a>
    <a href="#wallet" class="nav-item" data-page="wallet">
        <span class="nav-icon">üí∞</span>
        <span class="nav-label">Wallet</span>
    </a>
    <a href="#games" class="nav-item" data-page="games">
        <span class="nav-icon">üéÆ</span>
        <span class="nav-label">Games</span>
    </a>
    <a href="#quests" class="nav-item" data-page="quests">
        <span class="nav-icon">üìã</span>
        <span class="nav-label">Quests</span>
    </a>
    <a href="#otc" class="nav-item" data-page="otc">
        <span class="nav-icon">üí±</span>
        <span class="nav-label">Trade</span>
    </a>
    <a href="#referrals" class="nav-item" data-page="referrals">
        <span class="nav-icon">üë•</span>
        <span class="nav-label">Invite</span>
    </a>

    <a href="/games/static/shop.html" class="nav-item" data-page="shop">
      <span class="nav-icon">üõí</span>
      <span class="nav-label">Shop</span>
    </a>
</nav>

  <!-- Scripts -->
  <script src="/static/js/main.js"></script>
  <script src="/static/js/miniapp.js"></script>
  <script src="/static/js/event_handlers.js"></script>
  <script src="/static/js/ad_loader.js"></script>
  <script src="/static/js/ads.js"></script>
  <script src="/static/js/staking.js"></script>
  
  <script>
    // Global variables
    let userData = null;
    let telegramUser = null;

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Telegram WebApp
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        telegramUser = Telegram.WebApp.initDataUnsafe.user;
        
        // Set username if available
        if (telegramUser) {
          document.getElementById('username').textContent = telegramUser.username || `User${telegramUser.id}`;
          document.getElementById('menu-username').textContent = telegramUser.username || `User${telegramUser.id}`;
        }
        
        // Load user data
        loadUserData();
      } else {
        // Fallback for non-Telegram environment
        document.getElementById('username').textContent = 'Guest User';
        loadUserData();
      }
      
      // Set up navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const pageId = this.getAttribute('data-page');
          if (pageId === 'shop') {
            // For shop, we'll open the external page
            window.location.href = '/games/static/shop.html';
          } else {
            showPage(pageId);
          }
          
          // Update active state
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          this.classList.add('active');
        });
      });
      
      // Set up game cards
      document.querySelectorAll('.game-card').forEach(card => {
        card.addEventListener('click', function() {
          const gameId = this.getAttribute('data-game-id');
          if (gameId) {
            launchGame(gameId);
          }
        });
      });
      
      // Set up OTC amount input
      const otcAmountInput = document.getElementById('otc-amount');
      if (otcAmountInput) {
        otcAmountInput.addEventListener('input', updateConversionPreview);
      }
      
      // Set up OTC currency dropdown
      const otcCurrencySelect = document.getElementById('otc-currency');
      if (otcCurrencySelect) {
        otcCurrencySelect.addEventListener('change', updateConversionPreview);
      }
      
      // Set up copy referral link button
      const copyRefBtn = document.getElementById('copy-ref-btn');
      if (copyRefBtn) {
        copyRefBtn.addEventListener('click', function() {
          const refLink = document.getElementById('ref-link').textContent;
          navigator.clipboard.writeText(refLink).then(() => {
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Copied!',
                message: 'Referral link copied to clipboard',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert('Referral link copied to clipboard');
            }
          });
        });
      }
      
      // Set up claim bonus button
      const claimBonusBtn = document.getElementById('claim-bonus');
      if (claimBonusBtn) {
        claimBonusBtn.addEventListener('click', claimDailyBonus);
      }
      
      // Set up quest bonus button
      const questBonusBtn = document.getElementById('quest-bonus-btn');
      if (questBonusBtn) {
        questBonusBtn.addEventListener('click', claimDailyBonusFromQuests);
      }
      
      // Set up swap TON button
      const swapTonBtn = document.getElementById('swap-ton-btn');
      if (swapTonBtn) {
        swapTonBtn.addEventListener('click', swapTonForCash);
      }
      
      // Check if user has already claimed bonus today
      checkBonusStatus();
    });
    
    // Function to show a specific page
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      const pageElement = document.getElementById(`${pageId}-page`);
      if (pageElement) {
        pageElement.classList.add('active');
      }
    }
    
    // Function to load user data from backend
    async function loadUserData() {
      try {
        const userId = telegramUser ? telegramUser.id : 'demo';
        const response = await fetch('/api/user/data', {
          method: 'GET',
          headers: {
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          }
        });
        
        if (response.ok) {
          userData = await response.json();
          updateUIWithUserData(userData);
        } else {
          console.error('Failed to load user data');
        }
      } catch (error) {
        console.error('Error loading user data:', error);
      }
    }
    
    // Function to update UI with user data
    function updateUIWithUserData(data) {
      if (data.success) {
        // Update balances
        currentBalance = data.game_coins || 0;
        
        document.getElementById('gc-balance').textContent = currentBalance;
        document.getElementById('ton-equivalent').textContent = (currentBalance / 2000).toFixed(6);
        document.getElementById('wallet-gc-balance').textContent = currentBalance;
        document.getElementById('wallet-ton-equivalent').textContent = (currentBalance / 2000).toFixed(2);
        document.getElementById('profile-balance').textContent = (currentBalance / 2000).toFixed(6);
        document.getElementById('menu-balance').textContent = (currentBalance / 2000).toFixed(6) + ' TON';
        
        // Update shop balance display
        document.getElementById('balance-loading').style.display = 'none';
        document.getElementById('balance-value').style.display = 'inline';
        document.getElementById('balance-value').textContent = `${currentBalance} GC`;
        
        // Update stats
        document.getElementById('click-count').textContent = data.clicks_today || 0;
        document.getElementById('total-earned').textContent = (data.total_earned || 0).toFixed(6);
        document.getElementById('games-played').textContent = data.games_played || 0;
        document.getElementById('ads-watched').textContent = data.ads_watched || 0;
        document.getElementById('referrals-count').textContent = data.referrals || 0;
        
        // Update referral stats
        document.getElementById('ref-count').textContent = data.referrals || 0;
        document.getElementById('ref-earnings').textContent = (data.ref_earnings || 0).toFixed(6);
        
        // Update quest progress
        document.getElementById('quest-ads').textContent = data.ads_today || 0;
        document.getElementById('quest-games').textContent = data.games_today || 0;
        document.getElementById('quest-invite').textContent = data.referrals_today || 0;
        
        // Check if bonus was already claimed today
        if (data.bonus_claimed) {
          document.getElementById('daily-bonus-popup').style.display = 'none';
          document.getElementById('quest-bonus-btn').disabled = true;
          document.getElementById('quest-bonus-btn').textContent = 'Claimed';
        }
      }
    }
    
    // Function to handle click earning
    async function handleClickEarn() {
      const clickCount = parseInt(document.getElementById('click-count').textContent);
      if (clickCount >= 100) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showPopup({
            title: 'Limit Reached',
            message: 'You have reached the daily click limit. Try again tomorrow!',
            buttons: [{type: 'ok'}]
          });
        } else {
          alert('You have reached the daily click limit. Try again tomorrow!');
        }
        return;
      }
      
      try {
        const response = await fetch('/api/quests/record_click', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({ user_id: telegramUser ? telegramUser.id : 'demo' })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          // Update click count
          document.getElementById('click-count').textContent = result.clicks;
          
          // Update balance
          document.getElementById('gc-balance').textContent = result.game_coins;
          document.getElementById('ton-equivalent').textContent = (result.game_coins / 2000).toFixed(6);
          document.getElementById('wallet-gc-balance').textContent = result.game_coins;
          document.getElementById('wallet-ton-equivalent').textContent = (result.game_coins / 2000).toFixed(2);
          document.getElementById('profile-balance').textContent = (result.game_coins / 2000).toFixed(6);
          
          // Add visual feedback
          const clickArea = document.querySelector('.click-area');
          clickArea.style.transform = 'scale(0.95)';
          setTimeout(() => {
            clickArea.style.transform = 'scale(1)';
          }, 100);
          
          // Show earned amount
          const earnedElement = document.createElement('div');
          earnedElement.textContent = '+0.0001 TON';
          earnedElement.style.position = 'absolute';
          earnedElement.style.color = '#ffd700';
          earnedElement.style.fontWeight = 'bold';
          earnedElement.style.animation = 'floatUp 1s forwards';
          clickArea.appendChild(earnedElement);
          
          setTimeout(() => {
            earnedElement.remove();
          }, 1000);
        } else {
          console.error('Failed to record click');
        }
      } catch (error) {
        console.error('Error recording click:', error);
      }
    }

        // Function to purchase an item
    async function purchaseItem(itemId, price) {
      if (currentBalance < price) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showPopup({
            title: 'Insufficient Funds',
            message: `You need ${price} GC to purchase this item`,
            buttons: [{type: 'ok'}]
          });
        } else {
          alert(`You need ${price} GC to purchase this item`);
        }
        return;
      }
      
      try {
        const response = await fetch('/api/shop/purchase', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({
            user_id: telegramUser ? telegramUser.id : 'demo',
            item_id: itemId,
            price: price
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // Update balance
            currentBalance = result.new_gc_balance;
            document.getElementById('gc-balance').textContent = currentBalance;
            document.getElementById('balance-value').textContent = `${currentBalance} GC`;
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Purchase Successful',
                message: `You've purchased ${result.item_name}!`,
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(`You've purchased ${result.item_name}!`);
            }
            
            // Reload user data to ensure everything is in sync
            loadUserData();
          } else {
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Purchase Failed',
                message: result.error || 'Purchase failed',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(result.error || 'Purchase failed');
            }
          }
        } else {
          console.error('Failed to purchase item');
        }
      } catch (error) {
        console.error('Error purchasing item:', error);
      }
    }
    
    // Function to claim daily bonus
    async function claimDailyBonus() {
      try {
        const response = await fetch('/api/quests/claim_bonus', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({ user_id: telegramUser ? telegramUser.id : 'demo' })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            // Hide the popup
            document.getElementById('daily-bonus-popup').style.display = 'none';
            
            // Update balance
            document.getElementById('gc-balance').textContent = result.game_coins;
            document.getElementById('ton-equivalent').textContent = (result.game_coins / 2000).toFixed(6);
            document.getElementById('wallet-gc-balance').textContent = result.game_coins;
            document.getElementById('wallet-ton-equivalent').textContent = (result.game_coins / 2000).toFixed(2);
            document.getElementById('profile-balance').textContent = (result.game_coins / 2000).toFixed(6);
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Bonus Claimed!',
                message: '0.05 TON has been added to your balance',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert('Bonus Claimed! 0.05 TON has been added to your balance');
            }
          } else {
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Already Claimed',
                message: 'You have already claimed your bonus today',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert('You have already claimed your bonus today');
            }
          }
        } else {
          console.error('Failed to claim bonus');
        }
      } catch (error) {
        console.error('Error claiming bonus:', error);
      }
    }
    
    // Function to claim daily bonus from quests page
    async function claimDailyBonusFromQuests() {
      await claimDailyBonus();
      
      // Update quest button
      document.getElementById('quest-bonus-btn').disabled = true;
      document.getElementById('quest-bonus-btn').textContent = 'Claimed';
    }
    
    // Function to check bonus status
    async function checkBonusStatus() {
      try {
        const response = await fetch('/api/user/data', {
          method: 'GET',
          headers: {
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.bonus_claimed) {
            document.getElementById('daily-bonus-popup').style.display = 'none';
            document.getElementById('quest-bonus-btn').disabled = true;
            document.getElementById('quest-bonus-btn').textContent = 'Claimed';
          }
        }
      } catch (error) {
        console.error('Error checking bonus status:', error);
      }
    }
    
    // Function to watch an ad
    async function watchAd() {
      try {
        const response = await fetch('/api/ads/reward', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({ 
            user_id: telegramUser ? telegramUser.id : 'demo',
            ad_id: 'miniapp_ad_' + Date.now()
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            // Update balance
            document.getElementById('gc-balance').textContent = result.game_coins;
            document.getElementById('ton-equivalent').textContent = (result.game_coins / 2000).toFixed(6);
            document.getElementById('wallet-gc-balance').textContent = result.game_coins;
            document.getElementById('wallet-ton-equivalent').textContent = (result.game_coins / 2000).toFixed(2);
            document.getElementById('profile-balance').textContent = (result.game_coins / 2000).toFixed(6);
            
            // Update ads watched count
            const adsWatched = parseInt(document.getElementById('ads-watched').textContent);
            document.getElementById('ads-watched').textContent = adsWatched + 1;
            
            // Update quest progress
            const questAds = parseInt(document.getElementById('quest-ads').textContent);
            document.getElementById('quest-ads').textContent = questAds + 1;
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Ad Completed',
                message: `You earned ${result.reward} TON!`,
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(`Ad Completed! You earned ${result.reward} TON!`);
            }
          }
        } else {
          console.error('Failed to process ad reward');
        }
      } catch (error) {
        console.error('Error watching ad:', error);
      }
    }
    
    // Function to launch a game
    async function launchGame(gameId) {
      try {
        const response = await fetch(`/api/games/launch/${gameId}?user_id=${telegramUser ? telegramUser.id : 'demo'}`, {
          headers: {
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            window.location.href = result.url;
          } else {
            console.error('Failed to launch game:', result.error);
          }
        } else {
          console.error('Failed to launch game');
        }
      } catch (error) {
        console.error('Error launching game:', error);
      }
    }
    
    // Function to show withdrawal form
    function showWithdrawalForm() {
      document.getElementById('withdrawal-form').style.display = 'block';
    }
    
    // Function to hide withdrawal form
    function hideWithdrawalForm() {
      document.getElementById('withdrawal-form').style.display = 'none';
    }
    
    // Function to process withdrawal
    async function processWithdrawal() {
      const address = document.getElementById('withdraw-address').value;
      const amount = parseFloat(document.getElementById('withdraw-amount').value);
      
      if (!address) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showPopup({
            title: 'Error',
            message: 'Please enter a wallet address',
            buttons: [{type: 'ok'}]
          });
        } else {
          alert('Please enter a wallet address');
        }
        return;
      }
      
      if (!amount || amount < 0.1) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showPopup({
            title: 'Error',
            message: 'Minimum withdrawal is 0.1 TON',
            buttons: [{type: 'ok'}]
          });
        } else {
          alert('Minimum withdrawal is 0.1 TON');
        }
        return;
      }
      
      try {
        const response = await fetch('/api/withdraw/gc', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({
            user_id: telegramUser ? telegramUser.id : 'demo',
            amount: amount * 2000, // Convert TON to GC
            address: address
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            // Update balance
            document.getElementById('gc-balance').textContent = result.new_gc_balance;
            document.getElementById('ton-equivalent').textContent = (result.new_gc_balance / 2000).toFixed(6);
            document.getElementById('wallet-gc-balance').textContent = result.new_gc_balance;
            document.getElementById('wallet-ton-equivalent').textContent = (result.new_gc_balance / 2000).toFixed(2);
            document.getElementById('profile-balance').textContent = (result.new_gc_balance / 2000).toFixed(6);
            
            hideWithdrawalForm();
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Withdrawal Processing',
                message: 'Your withdrawal is being processed. It may take up to 24 hours.',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert('Withdrawal request submitted. It may take up to 24 hours to process.');
            }
          } else {
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Error',
                message: result.error || 'Withdrawal failed',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(result.error || 'Withdrawal failed');
            }
          }
        } else {
          console.error('Failed to process withdrawal');
        }
      } catch (error) {
        console.error('Error processing withdrawal:', error);
      }
    }
    
    // Function to connect wallet using Telegram's native wallet
    function connectWallet() {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.openInvoice('invoice_url_here', function(status) {
          if (status === 'paid') {
            Telegram.WebApp.showPopup({
              title: 'Wallet Connected',
              message: 'Your Telegram wallet has been successfully connected!',
              buttons: [{type: 'ok'}]
            });
          }
        });
      } else {
        alert('Please open this app in Telegram to connect your wallet');
      }
    }
    
    // Function to update OTC conversion preview
    function updateConversionPreview() {
      const amount = parseFloat(document.getElementById('otc-amount').value) || 0;
      const currency = document.getElementById('otc-currency').value;
      
      if (amount > 0) {
        const rates = {
          'USDT': 6.75,
          'USD': 6.80,
          'KES': 950,
          'EUR': 6.20
        };
        
        const converted = (amount * rates[currency]).toFixed(2);
        const fee = Math.max(amount * 0.03, 1).toFixed(2);
        
        document.getElementById('conversion-text').textContent = 
          `${amount} TON = ${converted} ${currency}`;
        document.getElementById('fee-text').textContent = `Fee: 3% ($${fee})`;
        document.getElementById('conversion-preview').style.display = 'block';
      } else {
        document.getElementById('conversion-preview').style.display = 'none';
      }
    }
    
    // Function to swap TON for cash
    async function swapTonForCash() {
      const amount = parseFloat(document.getElementById('otc-amount').value) || 0;
      const currency = document.getElementById('otc-currency').value;
      
      if (amount <= 0) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showPopup({
            title: 'Error',
            message: 'Please enter a valid amount',
            buttons: [{type: 'ok'}]
          });
        } else {
          alert('Please enter a valid amount');
        }
        return;
      }
      
      try {
        const response = await fetch('/api/otc/swap', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({
            user_id: telegramUser ? telegramUser.id : 'demo',
            amount: amount,
            currency: currency
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            // Update balance
            document.getElementById('gc-balance').textContent = result.new_gc_balance;
            document.getElementById('ton-equivalent').textContent = (result.new_gc_balance / 2000).toFixed(6);
            document.getElementById('wallet-gc-balance').textContent = result.new_gc_balance;
            document.getElementById('wallet-ton-equivalent').textContent = (result.new_gc_balance / 2000).toFixed(2);
            document.getElementById('profile-balance').textContent = (result.new_gc_balance / 2000).toFixed(6);
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Swap Successful',
                message: `Your TON has been converted to ${currency}`,
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(`Your TON has been converted to ${currency}`);
            }
          } else {
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Error',
                message: result.error || 'Swap failed',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(result.error || 'Swap failed');
            }
          }
        } else {
          console.error('Failed to process swap');
        }
      } catch (error) {
        console.error('Error processing swap:', error);
      }
    }
    
    // Function to logout
    function logout() {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.showPopup({
          title: 'Logout',
          message: 'Are you sure you want to logout?',
          buttons: [
            {id: 'cancel', type: 'cancel', text: 'Cancel'},
            {id: 'logout', type: 'destructive', text: 'Logout'}
          ]
        }, function(buttonId) {
          if (buttonId === 'logout') {
            // Clear local data
            localStorage.clear();
            // Close the WebApp
            Telegram.WebApp.close();
          }
        });
      } else {
        if (confirm('Are you sure you want to logout?')) {
          localStorage.clear();
          window.location.reload();
        }
      }
    }
  </script>
</body>
</html>