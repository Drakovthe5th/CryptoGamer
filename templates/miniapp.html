<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CryptoGamer - Telegram Mini App</title>
    
    <!-- CRITICAL: Telegram Web App SDK - MUST BE FIRST -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Telegram Web Events Script -->
    <script src="/static/js/telegram-web-events.js"></script>

    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CryptoGamer">
    
    <!-- Preload critical assets -->
    <link rel="preload" href="/static/css/main.css" as="style">
    <link rel="preload" href="/static/js/main.js" as="script">
    
    <!-- GLOBAL ASSETS from /static/ folder -->
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/x-icon" href="/static/assets/favicon.ico">
    <link rel="apple-touch-icon" href="/static/assets/apple-touch-icon.png">
    
    <!-- GLOBAL CSS FILES (Root /static/ folder) -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/miniapp.css">
    <link rel="stylesheet" href="/static/css/admin.css">
    
    <!-- EXTERNAL CDN LINKS with local fallbacks -->
    <!-- Socket.IO for Real-time Communication -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        // Fallback for Socket.IO
        if (typeof io === 'undefined') {
            document.write('<script src="/static/js/socket.io.fallback.js"><\/script>');
        }
    </script>
    
    <!-- Chart.js for Statistics and Analytics -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Fallback for Chart.js
        if (typeof Chart === 'undefined') {
            document.write('<script src="/static/js/chartjs.fallback.js"><\/script>');
        }
    </script>
    
    <!-- GAME-SPECIFIC CSS (from games/game-assets/ - Loaded Dynamically) -->
    <!-- These are disabled by default and enabled when game loads -->
    <link rel="preload" href="/game-assets/clicker/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'" disabled>
    <link rel="preload" href="/game-assets/trivia/trivia.css" as="style" onload="this.onload=null;this.rel='stylesheet'" disabled>
    <link rel="preload" href="/game-assets/trex/trex.css" as="style" onload="this.onload=null;this.rel='stylesheet'" disabled>
    <link rel="preload" href="/game-assets/spin/spin.css" as="style" onload="this.onload=null;this.rel='stylesheet'" disabled>
    <link rel="preload" href="/game-assets/edge-surf/interface.css" as="style" onload="this.onload=null;this.rel='stylesheet'" disabled>
    <link rel="preload" href="/game-assets/sabotage/sabotage.css" as="style" onload="this.onload=null;this.rel='stylesheet'" disabled>
    <link rel="preload" href="/game-assets/poker/poker.css" as="style" onload="this.onload=null;this.rel='stylesheet'" disabled>
    <link rel="preload" href="/game-assets/chess/chess.css" as="style" onload="this.onload=null;this.rel='stylesheet'" disabled>
    <link rel="preload" href="/game-assets/pool/pool.css" as="style" onload="this.onload=null;this.rel='stylesheet'" disabled>
    <link rel="preload" href="/game-assets/mini-royal/mini-royal.css" as="style" onload="this.onload=null;this.rel='stylesheet'" disabled>
    
    <!-- Static Paths Configuration -->
    <script src="/static/js/static_paths.js"></script>

  <style>
    :root {
    --tg-theme-bg-color: var(--tg-theme-bg-color, #ffffff);
    --tg-theme-text-color: var(--tg-theme-text-color, #000000);
    --tg-theme-hint-color: var(--tg-theme-hint-color, #999999);
    --tg-theme-link-color: var(--tg-theme-link-color, #3390ec);
    --tg-theme-button-color: var(--tg-theme-button-color, #3390ec);
    --tg-theme-button-text-color: var(--tg-theme-button-text-color, #ffffff);
    }

      /* Premium badge style */
    .premium-badge {
      background: linear-gradient(135deg, #ffd700, #ffb700);
      color: #000;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: bold;
      margin-left: 8px;
    }
    
    /* Limit indicators */
    .limit-indicator {
      font-size: 0.8rem;
      color: #888;
      margin-top: 4px;
    }
    
    .premium-feature {
      position: relative;
    }
    
    .premium-feature::after {
      content: "‚≠ê";
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 0.8rem;
    }
    
    /* Suggestion popup */
    .suggestion-popup {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 215, 0, 0.9);
      color: #000;
      padding: 12px 16px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .suggestion-close {
      position: absolute;
      top: 5px;
      right: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    /* Additional styles to match miniapp-old.html functionality */
    .page { display: none; }
    .page.active { display: block; }
    .hidden { display: none; }
    .milestone { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; margin-bottom: 10px; }
    .milestone.reached { background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50; }
    .currency-option { flex: 1; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; text-align: center; cursor: pointer; border: 1px solid transparent; }
    .currency-option.active { background: rgba(255, 215, 0, 0.1); border-color: #ffd700; }
    .click-area { background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; border-radius: 15px; height: 150px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; margin: 15px 0; cursor: pointer; transition: all 0.3s; }
    .click-area:active { transform: scale(0.95); }
    @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-30px); opacity: 0; } }
    
    /* New styles for fixes */
    .quest-button { 
      background: rgba(255, 215, 0, 0.2); 
      border: 1px solid #ffd700; 
      border-radius: 8px; 
      padding: 8px 12px; 
      color: #ffd700; 
      cursor: pointer; 
      transition: all 0.3s; 
    }
    .quest-button:hover { 
      background: rgba(255, 215, 0, 0.3); 
    }
    .quest-button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    .currency-dropdown {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: white;
      border: 2px solid rgba(255,255,255,0.1);
      margin-bottom: 16px;
    }
    .loading { 
      opacity: 0.7; 
      pointer-events: none; 
    }
        /* Add these styles for shop navigation */
    .shop-container {
      padding: 15px;
    }
    .shop-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .shop-item-info {
      flex: 1;
    }
    .shop-item-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .shop-item-price {
      color: #ffd700;
    }
    .shop-item-button {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid #ffd700;
      border-radius: 5px;
      padding: 8px 12px;
      color: white;
      cursor: pointer;
    }
    .shop-item-button:hover {
      background: rgba(255, 215, 0, 0.3);
    }
    .balance-loading {
      opacity: 0.7;
      font-style: italic;
    }
    .stars-price {
      display: block;
      font-size: 0.8rem;
      color: #ffcc00;
      margin-top: 4px;
    }
    
    /* Bot list styles for attachment menu */
    .bot-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .bot-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }
    .bot-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
      background: rgba(255, 215, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    .bot-info {
      flex: 1;
    }
    .bot-name {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .bot-description {
      font-size: 0.8rem;
      color: #888;
    }
    .bot-action {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid #ffd700;
      border-radius: 5px;
      padding: 8px 12px;
      color: white;
      cursor: pointer;
    }
    
    /* Game card styles */
    .game-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    
    .game-card:hover {
      border-color: #ffd700;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
      transform: translateY(-3px);
    }
    
    .game-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      background: rgba(255, 215, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-right: 15px;
      flex-shrink: 0;
    }
    
    .game-info {
      flex: 1;
    }
    
    .game-name {
      font-weight: bold;
      margin-bottom: 5px;
      color: #fff;
    }
    
    .game-description {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 8px;
    }
    
    .game-stats {
      display: flex;
      gap: 12px;
      font-size: 0.75rem;
      color: #666;
    }
    
    .stat {
      display: flex;
      align-items: center;
    }
    
    .play-btn {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid #ffd700;
      border-radius: 8px;
      padding: 8px 16px;
      color: #ffd700;
      cursor: pointer;
      white-space: nowrap;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .play-btn:hover {
      background: rgba(255, 215, 0, 0.3);
    }
    
    .premium-game {
      position: relative;
      overflow: hidden;
    }
    
    .premium-game::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #ffd700, transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    .game-category {
      margin: 20px 0 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 215, 0, 0.3);
      color: #ffd700;
      font-weight: bold;
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 80%;
      text-align: center;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    /* Game container */
    .game-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--tg-theme-bg-color, #0a0a1a);
      z-index: 1000;
      overflow: auto;
    }
    
    .game-header {
      display: flex;
      align-items: center;
      padding: 15px;
      background: rgba(20, 20, 40, 0.9);
      border-bottom: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .game-header .back-button {
      background: none;
      border: none;
      color: #ffd700;
      font-size: 1.5rem;
      cursor: pointer;
      margin-right: 15px;
    }
    
    .game-header h3 {
      margin: 0;
      color: white;
    }
    
    #game-frame {
      width: 100%;
      height: calc(100% - 60px);
      border: none;
    }

    /* Legal Modal Styles */
    .legal-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(10, 10, 10, 0.98);
      z-index: 1001;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
    }
    
    .modal-content {
      background: rgba(26, 26, 26, 0.9);
      border-radius: 10px;
      padding: 30px;
      margin: 20px auto;
      max-width: 800px;
      width: 100%;
      color: #e0e0e0;
      line-height: 1.6;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #333;
    }
    
    .modal-header h2 {
      color: #ffcc00;
      margin: 0;
      font-size: 1.8rem;
    }
    
    .close-modal {
      background: none;
      border: none;
      color: #ffcc00;
      font-size: 24px;
      cursor: pointer;
    }
    
    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
      padding-right: 10px;
    }
    
    .modal-body h1 {
      color: #ffcc00;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }
    
    .modal-body h2 {
      color: #ffcc00;
      margin: 25px 0 15px;
      font-size: 1.4rem;
    }
    
    .modal-body h3 {
      color: #ffcc00;
      margin: 20px 0 10px;
    }
    
    .modal-body p {
      margin-bottom: 15px;
    }
    
    .modal-body ul, .modal-body ol {
      margin-left: 20px;
      margin-bottom: 20px;
    }
    
    .modal-body li {
      margin-bottom: 8px;
    }
    
    .highlight {
      color: #ffcc00;
      font-weight: bold;
    }
    
    /* Scrollbar styling */
    .modal-body::-webkit-scrollbar {
      width: 8px;
    }
    
    .modal-body::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }
    
    .modal-body::-webkit-scrollbar-thumb {
      background: #ffcc00;
      border-radius: 10px;
    }

  </style>
</head>
<body>

  <!-- Loading Screen with enhanced feedback -->
  <div id="loading-screen" class="loading-screen">
      <div class="loader">
          <div class="spinner"></div>
          <p>Loading CryptoGamer...</p>
          <p class="loading-details" id="loading-details">Initializing</p>
          <button id="retry-button" style="display: none; margin-top: 20px;" onclick="window.location.reload()">
              Retry Loading
          </button>
      </div>
  </div>

  <!-- Background animation elements -->
  <div class="bg-animation">
    <div class="ball ball-1"></div>
    <div class="ball ball-2"></div>
    <div class="ball ball-3"></div>
    <div class="ball ball-4"></div>
    <div class="ball ball-5"></div>
    <div class="ball ball-6"></div>
    <div class="ball ball-7"></div>
  </div>

  <!-- Floating Shop Button -->
  <a href="/shop" class="shop-floating-btn">üõí</a>

  <!-- Header with profile -->
  <header class="app-header">
    <div class="profile-section">
      <div class="profile-toggle" id="profile-toggle">
        <img src="/static/assets/gamer.png" alt="Profile" class="profile-avatar">
        <span class="username" id="username">Loading...</span>
        <span class="premium-badge" id="premium-badge" style="display: none;">PREMIUM</span>
      </div>
      <div class="balance-display">
          <span id="gc-balance">0</span> GC ‚âà
          <span id="ton-equivalent">0.000000</span> TON
      </div>
    </div>
  </header>

  <!-- Profile Menu (initially hidden) -->
  <div class="profile-menu" id="profile-menu">
    <div class="menu-header">
      <h3>User Profile</h3>
      <button class="close-menu" id="close-menu">&times;</button>
    </div>
    <div class="menu-content">
      <div class="user-info">
        <img src="/static/assets/gamer.png" alt="Profile" class="menu-avatar">
        <div class="user-details">
          <span class="menu-username" id="menu-username">Username</span>
          <span class="premium-badge" id="menu-premium-badge" style="display: none;">PREMIUM</span>
          <span class="menu-balance" id="menu-balance">0.000000 TON</span>
        </div>
      </div>
      
      <div class="profile-stats" style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; margin: 16px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span>Current Balance:</span>
          <span style="color: #4CAF50; font-weight: bold;"><span id="profile-balance">0.000000</span> TON</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span>Total Earned:</span>
          <span style="color: #ffd700; font-weight: bold;"><span id="profile-total-earned">0.000000</span> TON</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span>Account Level:</span>
          <span style="color: #888;" id="account-level">Beginner</span>
        </div>
        <div class="limit-indicator" id="upload-limit-indicator" style="display: none;">
          Max upload: <span id="upload-limit-value">2</span> MB
        </div>
      </div>
      
      <div class="menu-items">
        <a href="#" class="menu-item" data-page="achievements">
          <span class="icon">üèÜ</span>
          <span>Achievements</span>
        </a>
        <a href="#" class="menu-item" data-page="support">
          <span class="icon">‚ùì</span>
          <span>Help & Support</span>
        </a>
        <a href="#" class="menu-item" data-page="invite">
          <span class="icon">üë•</span>
          <span>Invite Friends</span>
        </a>
        <a href="#" class="menu-item" onclick="showLegalContent('about')">
          <span class="icon">‚ÑπÔ∏è</span>
          <span>About CryptoGamer</span>
        </a>
        <a href="#" class="menu-item" onclick="showLegalContent('terms')">
          <span class="icon">üìÑ</span>
          <span>Terms of Service</span>
        </a>
        <a href="#" class="menu-item" onclick="showLegalContent('privacy')">
          <span class="icon">üîí</span>
          <span>Privacy Policy</span>
        </a>
        <a href="#" class="menu-item" onclick="showLegalContent('disclaimer')">
          <span class="icon">‚ö†Ô∏è</span>
          <span>Disclaimer</span>
        </a>
        <a href="#" class="menu-item" onclick="showLegalContent('contact')">
          <span class="icon">üìû</span>
          <span>Contact Us</span>
        </a>
        <a href="#" class="menu-item" onclick="logout()">
          <span class="icon">üö™</span>
          <span>Logout</span>
        </a>
      </div>
      
      <!-- Legal content modal -->
      <div id="legal-modal" class="legal-modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="modal-title">Title</h2>
            <button class="close-modal" onclick="closeLegalModal()">&times;</button>
          </div>
          <div id="modal-body" class="modal-body">
            <!-- Content will be inserted here -->
          </div>
        </div>
      </div>
      
      <!-- Add suggestion container -->
      <div id="suggestion-container" class="suggestion-popup" style="display: none;">
        <span class="suggestion-close" onclick="dismissSuggestion()">√ó</span>
        <div id="suggestion-content"></div>
      </div>

      <!-- Add suggestion container -->
      <div id="suggestion-container" class="suggestion-popup" style="display: none;">
        <span class="suggestion-close" onclick="dismissSuggestion()">√ó</span>
        <div id="suggestion-content"></div>
      </div>
    </div>
  </div>

  <button class="back-button" onclick="history.back()">‚Üê</button>

  <!-- Main content area -->
  <main class="main-content">
    <!-- Home Page -->
    <section id="home-page" class="page active">
      <!-- Daily Bonus Popup -->
      <div class="daily-bonus-popup" id="daily-bonus-popup">
        <div class="bonus-content">
          <h3>üéÅ Daily Bonus</h3>
          <p>Claim your 0.05 TON daily reward!</p>
          <button class="claim-bonus" id="claim-bonus">Claim Now</button>
        </div>
      </div>
      
      <!-- Click & Earn Section -->
      <div class="click-game-preview">
        <h3>‚ö° Click & Earn</h3>
        <div class="click-area" onclick="handleClickEarn()">
          <div class="click-text">TAP TO EARN</div>
        </div>
        <!-- Add limit indicators to relevant sections -->
          <div class="limit-indicator" id="click-limit-indicator">
            Daily clicks: <span id="click-count">0</span>/<span id="click-limit">100</span>
          </div>
        <p style="text-align: center;">
          Clicks today: <span id="click-count" style="color: #ffd700; font-weight: bold;">0</span>/100
        </p>
      </div>
      
      <!-- Featured Games -->
      <div class="home-section">
        <h2 class="section-title">üéÆ Featured Games</h2>
        <div class="game-grid">
          <div class="game-card" data-game-id="trivia">
            <div class="game-icon">‚ùì</div>
            <div class="game-name">Crypto Trivia</div>
          </div>
          <div class="game-card" data-game-id="spin">
            <div class="game-icon">üé°</div>
            <div class="game-name">Lucky Spin</div>
          </div>
          <div class="game-card" data-game-id="clicker">
            <div class="game-icon">üñ±Ô∏è</div>
            <div class="game-name">TON Clicker</div>
          </div>
          <div class="game-card" data-game-id="trex">
            <div class="game-icon">ü¶ñ</div>
            <div class="game-name">T-Rex Runner</div>
          </div>
          <!-- Premium-only game example -->
          <div class="game-card premium-feature" data-game-id="premium-game" style="opacity: 0.7; pointer-events: none;">
            <div class="game-icon">‚≠ê</div>
            <div class="game-name">Exclusive Premium Game</div>
            <small style="color: #888;">Premium members only</small>
          </div>
        </div>
      </div>
      
      <!-- Ad Space -->
      <div class="home-section">
        <div class="ad-slot" id="home-ad-slot" style="height: 120px;">
          <!-- Ad content will be loaded here -->
        </div>
      </div>
    </section>

    <!-- Watch Page -->
    <section id="watch-page" class="page">
      <div class="page-header">
        <h2>üì∫ Watch & Earn</h2>
        <p>Watch video ads and earn TON coins instantly!</p>
        <button class="btn btn-primary" style="width: 100%; margin: 15px 0;" onclick="watchAd()">
          ‚ñ∂Ô∏è Watch Ad & Earn TON
        </button>
        <div style="padding: 12px; background: rgba(255,204,0,0.1); border-radius: 8px;">
          <small style="color: #ffcc00;">üí° Tip: Weekend ads give 20% bonus!</small>
        </div>

        <div class="ad-slot" id="watch-ad-1" style="height: 200px; margin: 15px 0;"></div>
        <div class="ad-slot" id="watch-ad-2" style="height: 200px; margin: 15px 0;"></div>
        <div class="ad-slot" id="watch-ad-3" style="height: 200px; margin: 15px 0;"></div>
      </div>
    </section>

    <!-- Wallet Page -->
    <section id="wallet-page" class="page">
      <div class="page-header">
        <h2>üí∞ Your Wallet</h2>
      </div>
      
      <div class="home-section">
        <div style="text-align: center; margin: 20px 0;">
          <div style="font-size: 1.5rem; color: #4CAF50;">
            <span id="wallet-gc-balance">0</span> GC
          </div>
          <div style="color: #888; margin-top: 8px;">
            ‚âà <span id="wallet-ton-equivalent">0.00</span> TON
          </div>
          <div style="color: #666; margin-top: 4px; font-size: 0.8rem;">
            200,000 GC = 100 TON
          </div>
        </div>
        
        <div class="wallet-section">
            <div id="wallet-disconnected" class="wallet-status">
                <p>Connect your wallet to withdraw earnings</p>
                <div id="ton-connect-button"></div>
                <button class="btn btn-primary" onclick="connectTONWallet()">
                    üîó Connect Wallet
                </button>
            </div>
            
            <div id="wallet-connected" class="wallet-status hidden">
                <p>Wallet connected: <span id="wallet-address"></span></p>
                <button class="btn" onclick="disconnectWallet()">
                    Disconnect
                </button>
            </div>
        </div>
      </div>

      <!-- Withdrawal Form -->
      <div class="home-section" id="withdrawal-form" style="display: none;">
        <h3 style="margin-bottom: 16px; color: #ffd700;">Withdraw TON</h3>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">TON Wallet Address</label>
          <input type="text" id="withdraw-address" placeholder="EQxxxxx..." style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); color: white; border: 2px solid rgba(255,255,255,0.1);" />
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Amount (TON)</label>
          <input type="number" id="withdraw-amount" placeholder="0.000000" step="0.000001" min="0.1" style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); color: white; border: 2px solid rgba(255,255,255,0.1);" />
          <small style="color: #888;">Minimum withdrawal: 0.1 TON</small>
        </div>
        
        <div style="display: flex; gap: 8px;">
          <button class="btn" style="background: rgba(255,255,255,0.1); flex: 1;" onclick="hideWithdrawalForm()">Cancel</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="processWithdrawal()">Withdraw</button>
        </div>
      </div>

      <!-- Stats Section -->
      <div class="home-section">
        <h2 class="section-title">üìä Stats</h2>
        <div class="game-grid">
          <div class="game-card">
            <div class="stat-value" id="total-earned">0.000000</div>
            <div class="stat-label">Total Earned</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="games-played">0</div>
            <div class="stat-label">Games Played</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="ads-watched">0</div>
            <div class="stat-label">Ads Watched</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="referrals-count">0</div>
            <div class="stat-label">Referrals</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Games Page -->
    <section id="games-page" class="page">
      <div class="page-header">
        <h2>üéÆ All Games</h2>
        <p style="margin-bottom: 20px; color: #ccc;">
          Play games, earn TON coins, and climb the leaderboards!
        </p>
        
        <!-- Free Games Section -->
        <h3 class="game-category">üéØ Free Games</h3>
        <div class="games-container">
          <!-- Trivia Game -->
          <div class="game-card" data-game="trivia">
            <div class="game-icon">‚ùì</div>
            <div class="game-info">
              <h3 class="game-name">Crypto Trivia</h3>
              <p class="game-description">Test your crypto knowledge and earn rewards</p>
              <div class="game-stats">
                <span class="stat">üí∞ Up to 500 GC</span>
                <span class="stat">‚è±Ô∏è 5 min</span>
              </div>
            </div>
            <button class="play-btn" onclick="launchGame('trivia')">Play</button>
          </div>
          
          <!-- Spin Game -->
          <div class="game-card" data-game="spin">
            <div class="game-icon">üé°</div>
            <div class="game-info">
              <h3 class="game-name">Lucky Spin</h3>
              <p class="game-description">Spin the wheel for instant rewards</p>
              <div class="game-stats">
                <span class="stat">üí∞ Up to 1000 GC</span>
                <span class="stat">üéØ Daily bonus</span>
              </div>
            </div>
            <button class="play-btn" onclick="launchGame('spin')">Play</button>
          </div>
          
          <!-- Clicker Game -->
          <div class="game-card" data-game="clicker">
            <div class="game-icon">üñ±Ô∏è</div>
            <div class="game-info">
              <h3 class="game-name">TON Clicker</h3>
              <p class="game-description">Click to earn and upgrade your income</p>
              <div class="game-stats">
                <span class="stat">üí∞ Passive income</span>
                <span class="stat">‚ö° Fast gameplay</span>
              </div>
            </div>
            <button class="play-btn" onclick="launchGame('clicker')">Play</button>
          </div>
          
          <!-- T-Rex Runner -->
          <div class="game-card" data-game="trex">
            <div class="game-icon">ü¶ñ</div>
            <div class="game-info">
              <h3 class="game-name">T-Rex Runner</h3>
              <p class="game-description">Classic endless runner with crypto rewards</p>
              <div class="game-stats">
                <span class="stat">üí∞ Score-based rewards</span>
                <span class="stat">üèÜ Leaderboards</span>
              </div>
            </div>
            <button class="play-btn" onclick="launchGame('trex')">Play</button>
          </div>
          
          <!-- Edge Surf -->
          <div class="game-card" data-game="edge-surf">
            <div class="game-icon">üèÑ</div>
            <div class="game-info">
              <h3 class="game-name">Edge Surf</h3>
              <p class="game-description">Surf the web and collect crypto coins</p>
              <div class="game-stats">
                <span class="stat">üí∞ Collection game</span>
                <span class="stat">üåê Browser-based</span>
              </div>
            </div>
            <button class="play-btn" onclick="launchGame('edge-surf')">Play</button>
          </div>
        </div>
        
        <!-- Premium Games Section -->
        <h3 class="game-category">‚≠ê Premium Games (Stars Betting)</h3>
        <div class="games-container">
          <!-- Sabotage Game -->
          <div class="game-card premium-game" data-game="sabotage">
            <div class="game-icon">üïµÔ∏è</div>
            <div class="game-info">
              <h3 class="game-name">Crypto Crew: Sabotage</h3>
              <p class="game-description">Social deduction game - Find the saboteurs!</p>
              <div class="game-stats">
                <span class="stat">üë• 4-6 players</span>
                <span class="stat">‚è±Ô∏è 15 min</span>
                <span class="stat">üí∞ Up to 8000 GC</span>
              </div>
            </div>
            <button class="play-btn" onclick="launchPremiumGame('sabotage')">Play</button>
          </div>

          <!-- Chess Game -->
          <div class="game-card premium-game" data-game="chess">
            <div class="game-icon">‚ôüÔ∏è</div>
            <div class="game-info">
              <h3 class="game-name">ChessMasters</h3>
              <p class="game-description">Strategic board game - Checkmate your opponent!</p>
              <div class="game-stats">
                <span class="stat">üë• 2 players</span>
                <span class="stat">‚è±Ô∏è 20 min</span>
                <span class="stat">üí∞ Up to 5000 GC</span>
              </div>
            </div>
            <button class="play-btn" onclick="launchPremiumGame('chess')">Play</button>
          </div>

          <!-- Pool Game -->
          <div class="game-card premium-game" data-game="pool">
            <div class="game-icon">üé±</div>
            <div class="game-info">
              <h3 class="game-name">8-Ball Pool</h3>
              <p class="game-description">Classic pool game - Sink the 8-ball to win!</p>
              <div class="game-stats">
                <span class="stat">üë• 2 players</span>
                <span class="stat">‚è±Ô∏è 10 min</span>
                <span class="stat">üí∞ Up to 3000 GC</span>
              </div>
            </div>
            <button class="play-btn" onclick="launchPremiumGame('pool')">Play</button>
          </div>

          <!-- Poker Game -->
          <div class="game-card premium-game" data-game="poker">
            <div class="game-icon">üÉè</div>
            <div class="game-info">
              <h3 class="game-name">Texas Hold'em Poker</h3>
              <p class="game-description">Classic poker game - Bluff your way to victory!</p>
              <div class="game-stats">
                <span class="stat">üë• 2-6 players</span>
                <span class="stat">‚è±Ô∏è 30 min</span>
                <span class="stat">üí∞ Up to 10000 GC</span>
              </div>
            </div>
            <button class="play-btn" onclick="launchPremiumGame('poker')">Play</button>
          </div>

          <!-- Mini Royal Game -->
          <div class="game-card premium-game" data-game="mini-royal">
            <div class="game-icon">üëë</div>
            <div class="game-info">
              <h3 class="game-name">Mini Royal</h3>
              <p class="game-description">Battle royale game - Be the last one standing!</p>
              <div class="game-stats">
                <span class="stat">üë• 10 players</span>
                <span class="stat">‚è±Ô∏è 5 min</span>
                <span class="stat">üí∞ Up to 15000 GC</span>
              </div>
            </div>
            <button class="play-btn" onclick="launchPremiumGame('mini-royal')">Play</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Quests Page -->
    <section id="quests-page" class="page">
      <div class="page-header">
        <h2>üìù Daily Quests</h2>
        <p style="margin-bottom: 16px; color: #ccc;">
          Complete daily tasks to earn bonus rewards!
        </p>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">‚úÖ Claim Daily Bonus</div>
            <small style="color: #888;">Reward: 0.05 TON</small>
          </div>
          <button class="quest-button" id="quest-bonus-btn">Claim</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üì∫ Watch 3 Ads</div>
            <small style="color: #888;">Progress: <span id="quest-ads">0</span>/3 | Reward: 0.009 TON</small>
          </div>
          <button class="quest-button" onclick="showPage('watch')">Watch</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üéÆ Play 2 Games</div>
            <small style="color: #888;">Progress: <span id="quest-games">0</span>/2 | Reward: 0.006 TON</small>
          </div>
          <button class="quest-button" onclick="showPage('games')">Play</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üë• Invite 1 Friend</div>
            <small style="color: #888;">Progress: <span id="quest-invite">0</span>/1 | Reward: 0.05 TON</small>
          </div>
          <button class="quest-button" onclick="showPage('referrals')">Invite</button>
        </div>
      </div>

      <div class="home-section">
        <h2 class="section-title">üèÜ Weekly Challenges</h2>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üî• 7-Day Streak</div>
            <small style="color: #888;">Login daily for a week | Reward: 0.5 TON</small>
          </div>
          <div style="color: #ffd700; font-weight: bold;" id="daily-streak">0/7</div>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üíØ Score 1000+ Points</div>
            <small style="color: #888;">In any game | Reward: 0.1 TON</small>
          </div>
          <div style="color: #888;" id="high-score">0/1000</div>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üì± Share App</div>
            <small style="color: #888;">Share with 5 friends | Reward: 0.25 TON</small>
          </div>
          <button class="quest-button" id="share-app-btn">Share</button>
        </div>
                  <!-- New Social Media Quests -->
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üì± Connect Telegram Wallet</div>
            <small style="color: #888;">Reward: 1,000 GC</small>
          </div>
          <button class="quest-button" onclick="verifyQuest('connect_telegram_wallet')">Verify</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üì∏ Follow Instagram</div>
            <small style="color: #888;">Reward: 2,000 GC</small>
          </div>
          <button class="quest-button" onclick="openSocial('instagram')">Follow</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üëç Follow Facebook</div>
            <small style="color: #888;">Reward: 2,000 GC</small>
          </div>
          <button class="quest-button" onclick="openSocial('facebook')">Follow</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üê¶ Follow Twitter</div>
            <small style="color: #888;">Reward: 2,000 GC</small>
          </div>
          <button class="quest-button" onclick="openSocial('twitter')">Follow</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üì¢ Join Telegram Channel</div>
            <small style="color: #888;">Reward: 2,000 GC</small>
          </div>
          <button class="quest-button" onclick="joinChannel()">Join</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üí¨ Post on Twitter</div>
            <small style="color: #888;">Reward: 3,000 GC</small>
          </div>
          <button class="quest-button" onclick="postOnTwitter()">Post</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üîÅ Retweet Post</div>
            <small style="color: #888;">Reward: 3,000 GC</small>
          </div>
          <button class="quest-button" onclick="retweetPost()">Retweet</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üéµ Post TikTok Video</div>
            <small style="color: #888;">Reward: 10,000 GC</small>
          </div>
          <button class="quest-button" onclick="postTikTok()">Post</button>
        </div>
        
        <!-- New Binance Quests -->
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üí± Sign up on Binance</div>
            <small style="color: #888;">Use referral code: CRYPTOGAMER | Reward: 5,000 GC</small>
          </div>
          <button class="quest-button" onclick="openBinance()">Sign Up</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üë• Invite to Binance</div>
            <small style="color: #888;">Reward: 7,000 GC</small>
          </div>
          <button class="quest-button" onclick="shareBinance()">Invite</button>
        </div>
        
        <!-- New Progression Quests -->
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">‚≠ê Reach Level 3</div>
            <small style="color: #888;">Reward: 10,000 GC</small>
          </div>
          <div style="color: #888;" id="user-level">Current: Level 1</div>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üîÑ Post, Retweet, Earn, Repeat</div>
            <small style="color: #888;">Reward: 10,000 GC</small>
          </div>
          <button class="quest-button" onclick="startSocialCycle()">Start</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üì∫ Earn 10,000 GC from Ads</div>
            <small style="color: #888;">Reward: 20,000 GC</small>
          </div>
          <div style="color: #888;" id="ad-earnings">0/10,000 GC</div>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üì∫ Earn 100,000 GC from Ads</div>
            <small style: #888;">Reward: 50,000 GC</small>
          </div>
          <div style="color: #888;" id="ad-earnings-large">0/100,000 GC</div>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üì∫ Watch 5 Ads</div>
            <small style="color: #888;">Reward: 5,000 GC</small>
          </div>
          <button class="quest-button" onclick="showPage('watch')">Watch Ads</button>
        </div>
        
        <!-- Shop Quests -->
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">üöÄ Boost Channel</div>
            <small style="color: #888;">Reward: 5,000 GC</small>
          </div>
          <button class="quest-button" onclick="showPage('shop')">Boost</button>
        </div>
        
        <div class="milestone">
          <div>
            <div style="font-weight: 600;">‚ö° Boost Earnings</div>
            <small style="color: #888;">Reward: 7,000 GC</small>
          </div>
          <button class="quest-button" onclick="showPage('shop')">Boost</button>
        </div>

      </div>
    </section>

    <!-- OTC Desk Page -->
    <section id="otc-page" class="page">
      <div class="page-header">
        <h2>üí± OTC Exchange</h2>
        <p style="margin-bottom: 20px; color: #ccc;">
          Trade your TON for fiat currencies instantly!
        </p>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Amount (TON)</label>
          <input type="number" id="otc-amount" placeholder="0.000000" step="0.000001" min="0.1" style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); color: white; border: 2px solid rgba(255,255,255,0.1);" />
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Currency</label>
          <select class="currency-dropdown" id="otc-currency">
            <option value="USDT">USDT</option>
            <option value="USD">USD</option>
            <option value="KES">KES</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        
        <div id="conversion-preview" style="background: rgba(255,204,0,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;">
          <div style="color: #ffd700; font-weight: 600;">Conversion Preview:</div>
          <div id="conference-text"></div>
          <small style="color: #888;" id="fee-text">Fee: 3% (min $1.00)</small>
        </div>
        
        <button class="btn btn-primary" id="swap-ton-btn" style="width: 100%;">
          üí± Swap TON for Cash
        </button>
      </div>

      <div class="home-section">
        <h2 class="section-title">üíπ Current Rates</h2>
        <div class="game-grid">
          <div class="game-card">
            <div class="stat-value" id="rate-usd">$6.80</div>
            <div class="stat-label">1 TON = USD</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="rate-kes">950</div>
            <div class="stat-label">1 TON = KES</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="rate-eur">‚Ç¨6.20</div>
            <div class="stat-label">1 TON = EUR</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="rate-usdt">6.75</div>
            <div class="stat-label">1 TON = USDT</div>
          </div>
        </div>
        <small style="color: #888; display: block; text-align: center; margin-top: 12px;">
          ‚è∞ Rates updated every 5 minutes
        </small>
      </div>
    </section>

    <!-- Referrals Page -->
    <section id="referrals-page" class="page">
      <div class="page-header">
        <h2>üë• Invite & Earn</h2>
        <p style="margin: 12px 0;">Earn 20% of your friends' earnings forever!</p>
        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin: 15px 0; word-break: break-all;" id="ref-link">
          https://t.me/CryptoGameMinerBot?start=ref-xyz123
        </div>
        <button class="btn btn-primary" id="copy-ref-btn" style="width: 100%;">
          üìã Copy Invite Link
        </button>
      </div>

      <div class="home-section">
        <h2 class="section-title">üìä Your Referral Stats</h2>
        <div class="game-grid">
          <div class="game-card">
            <div class="stat-value" id="ref-count">0</div>
            <div class="stat-label">Friends Invited</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="ref-earnings">0.000000</div>
            <div class="stat-label">Total Earned (TON)</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="ref-active">0</div>
            <div class="stat-label">Active This Week</div>
          </div>
          <div class="game-card">
            <div class="stat-value" id="ref-level">1</div>
            <div class="stat-label">Referrer Level</div>
          </div>
        </div>
      </div>

      <div class="home-section">
        <h2 class="section-title">üéØ Referral Milestones</h2>
        
        <div class="milestone">
          <span>ü•â 3 referrals ‚Üí Bonus 0.01 TON</span>
          <span style="color: #4CAF50;" id="milestone-3">0/3</span>
        </div>
        <div class="milestone">
          <span>ü•à 10 referrals ‚Üí Bonus 0.05 TON</span>
          <span style="color: #888;" id="milestone-10">0/10</span>
        </div>
        <div class="milestone">
          <span>ü•á 50 referrals ‚Üí Bonus 0.25 TON</span>
          <span style="color: #888;" id="milestone-50">0/50</span>
        </div>
        <div class="milestone">
          <span>üíé 100 referrals ‚Üí Bonus 1.0 TON</span>
          <span style="color: #888;" id="milestone-100">0/100</span>
        </div>
      </div>
    </section>

    <!-- Attachment Menu Page -->
    <section id="attach-menu-page" class="page">
        <div class="page-header">
            <h2>üìé Attachment Menu</h2>
            <p>Manage your mini-apps and quick access tools</p>
        </div>
        
        <div class="home-section">
            <h3>Installed Mini-Apps</h3>
            <div id="installed-bots-list" class="bot-list">
                <!-- Dynamically populated -->
            </div>
        </div>
        
        <div class="home-section">
            <h3>Available Mini-Apps</h3>
            <div id="available-bots-list" class="bot-list">
                <!-- Dynamically populated -->
            </div>
        </div>
    </section>

    <!-- Shop Page Section -->
    <section id="shop-page" class="page">
      <div class="page-header">
        <h2>üõí Game Shop</h2>
        <p>Enhance your gaming experience with powerful items!</p>
      </div>
      
      <div class="shop-container">
        <div style="text-align: center; margin: 20px 0;">
          <div class="coins-display" id="miniapp-gc-balance">
            <span class="balance-loading" id="balance-loading">Loading balance...</span>
            <span id="balance-value" style="display: none;"></span>
          </div>
        </div>
        
        <div class="shop-items-mini">
          <div class="shop-item">
            <div class="shop-item-info">
              <div class="shop-item-name">2x Earnings Booster</div>
              <div class="shop-item-price">
                <span>2000 GC</span>
                <span class="stars-price">or 200 Stars</span>
              </div>
            </div>
            <button class="shop-item-button" onclick="purchaseItem('global_booster', 2000)">Buy</button>
          </div>
          
          <div class="shop-item">
            <div class="shop-item-info">
              <div class="shop-item-name">Trivia Time Extender</div>
              <div class="shop-item-price">
                <span>500 GC</span>
                <span class="stars-price">or 50 Stars</span>
              </div>
            </div>
            <button class="shop-item-button" onclick="purchaseItem('trivia_extra_time', 500)">Buy</button>
          </div>
          
          <div class="shop-item">
            <div class="shop-item-info">
              <div class="shop-item-name">Extra Spin</div>
              <div class="shop-item-price">
                <span>300 GC</span>
                <span class="stars-price">or 30 Stars</span>
              </div>
            </div>
            <button class="shop-item-button" onclick="purchaseItem('spin_extra_spin', 300)">Buy</button>
          </div>
          
          <div class="shop-item">
            <div class="shop-item-info">
              <div class="shop-item-name">Auto-Clicker</div>
              <div class="shop-item-price">
                <span>1000 GC</span>
                <span class="stars-price">or 100 Stars</span>
              </div>
            </div>
            <button class="shop-item-button" onclick="purchaseItem('clicker_auto_upgrade', 1000)">Buy</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Game Container (initially hidden) -->
    <div id="game-container" class="game-container hidden">
      <div class="game-header">
        <button class="back-button" onclick="exitGame()">‚Üê Back</button>
        <h3 id="game-title">Game</h3>
      </div>
      <div id="game-frame"></div>
    </div>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="#" class="nav-item active" data-page="home">
      <span class="nav-icon">üè†</span>
      <span class="nav-label">Home</span>
    </a>
    <a href="#" class="nav-item" data-page="watch">
      <span class="nav-icon">üì∫</span>
      <span class="nav-label">Watch</span>
    </a>
    <a href="#" class="nav-item" data-page="games">
      <span class="nav-icon">üéÆ</span>
      <span class="nav-label">Games</span>
    </a>
    <a href="#" class="nav-item" data-page="wallet">
      <span class="nav-icon">üí∞</span>
      <span class="nav-label">Wallet</span>
    </a>
    <a href="#" class="nav-item" data-page="quests">
      <span class="nav-icon">üìã</span>
      <span class="nav-label">Quests</span>
    </a>
    <a href="#" class="nav-item" data-page="otc">
      <span class="nav-icon">üí±</span>
      <span class="nav-label">Trade</span>
    </a>
    <a href="#" class="nav-item" data-page="referrals">
      <span class="nav-icon">üë•</span>
      <span class="nav-label">Invite</span>
    </a>
    <a href="#" class="nav-item" data-page="attach-menu">
      <span class="nav-icon">üìé</span>
      <span class="nav-label">Mini-Apps</span>
    </a>
    <a href="#" class="nav-item" data-page="shop">
      <span class="nav-icon">üõí</span>
      <span class="nav-label">Shop</span>
    </a>
  </nav>

  <!-- Toast Notifications -->
  <div id="toast" class="toast"></div>

  <!-- GLOBAL JS FILES (Root /static/ folder) -->
  <script src="/static/js/main.js"></script>
  <script src="/static/js/websocket.js"></script>
  <script src="/static/js/api-client.js"></script>
  <script src="/static/js/state-manager.js"></script>
  <script src="/static/js/components.js"></script>
  <script src="/static/js/charts.js"></script>
  <script src="/static/js/staking.js"></script>
  <script src="/static/js/ads.js"></script>
  <script src="/static/js/state-manager.js"></script>

  <script>
    // Global variables
    let userData = null;
    let telegramUser = null;
    let telegramConfig = null;
    let userLimits = {};
    let pendingSuggestions = [];
    let dismissedSuggestions = [];
    let currentBalance = 0;

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Telegram WebApp
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        telegramUser = Telegram.WebApp.initDataUnsafe.user;
        
        // Set username if available
        if (telegramUser) {
          document.getElementById('username').textContent = telegramUser.username || `User${telegramUser.id}`;
          document.getElementById('menu-username').textContent = telegramUser.username || `User${telegramUser.id}`;
          
          // Show premium badge if user is premium
          if (telegramUser.is_premium) {
            document.getElementById('premium-badge').style.display = 'inline';
            document.getElementById('menu-premium-badge').style.display = 'inline';
          }
        }
        
        // Load user data
        loadUserData();
        
        // Load Telegram client configuration
        loadTelegramConfig();
      } else {
        // Fallback for non-Telegram environment
        document.getElementById('username').textContent = 'Guest User';
        loadUserData();
      }
      
      // Set up navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const pageId = this.getAttribute('data-page');
          showPage(pageId);
          
          // Update active state
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          this.classList.add('active');
        });
      });
      
      // Set up game cards
      document.querySelectorAll('.game-card').forEach(card => {
        card.addEventListener('click', function() {
          const gameId = this.getAttribute('data-game-id');
          if (gameId) {
            launchGame(gameId);
          }
        });
      });
      
      // Set up OTC amount input
      const otcAmountInput = document.getElementById('otc-amount');
      if (otcAmountInput) {
        otcAmountInput.addEventListener('input', updateConversionPreview);
      }
      
      // Set up OTC currency dropdown
      const otcCurrencySelect = document.getElementById('otc-currency');
      if (otcCurrencySelect) {
        otcCurrencySelect.addEventListener('change', updateConversionPreview);
      }
      
      // Set up copy referral link button
      const copyRefBtn = document.getElementById('copy-ref-btn');
      if (copyRefBtn) {
        copyRefBtn.addEventListener('click', function() {
          const refLink = document.getElementById('ref-link').textContent;
          navigator.clipboard.writeText(refLink).then(() => {
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Copied!',
                message: 'Referral link copied to clipboard',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert('Referral link copied to clipboard');
            }
          });
        });
      }
      
      // Set up claim bonus button
      const claimBonusBtn = document.getElementById('claim-bonus');
      if (claimBonusBtn) {
        claimBonusBtn.addEventListener('click', claimDailyBonus);
      }
      
      // Set up quest bonus button
      const questBonusBtn = document.getElementById('quest-bonus-btn');
      if (questBonusBtn) {
        questBonusBtn.addEventListener('click', claimDailyBonusFromQuests);
      }
      
      // Set up swap TON button
      const swapTonBtn = document.getElementById('swap-ton-btn');
      if (swapTonBtn) {
        swapTonBtn.addEventListener('click', swapTonForCash);
      }
      
      // Check if user has already claimed bonus today
      checkBonusStatus();
      
      // Load attachment menu data
      loadAttachmentMenuData();
      
      // Add haptic feedback to interactive elements
      document.querySelectorAll('button, .game-card, .nav-item').forEach(element => {
        element.addEventListener('click', () => {
          triggerHapticFeedback('selection_change');
        });
      });
    });
    
    // Function to trigger haptic feedback
    function triggerHapticFeedback(type) {
      if (window.Telegram && Telegram.WebApp) {
        switch(type) {
          case 'selection_change':
            Telegram.WebApp.HapticFeedback.selectionChanged();
            break;
          case 'impact':
            Telegram.WebApp.HapticFeedback.impactOccurred('light');
            break;
          case 'notification':
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            break;
        }
      }
    }
    
    // Load Telegram client configuration
    async function loadTelegramConfig() {
      try {
        const response = await fetch('/api/telegram/config', {
          headers: {
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            telegramConfig = data.config;
            userLimits = data.user_limits;
            
            // Apply configuration to UI
            applyTelegramConfig();
            
            // Check for suggestions
            checkSuggestions();
          }
        }
      } catch (error) {
        console.error('Error loading Telegram config:', error);
      }
    }
    
    // Apply Telegram configuration to UI
    function applyTelegramConfig() {
      if (!userLimits) return;
      
      // Update click limit display
      const isPremium = window.Telegram?.WebApp.initDataUnsafe.user?.is_premium || false;
      const clickLimit = isPremium ? 
        (userLimits.daily_clicks_premium || 200) : 
        (userLimits.daily_clicks || 100);
      
      document.getElementById('click-limit').textContent = clickLimit;
      
      // Update upload limit display if available
      if (userLimits.upload_size) {
        const uploadLimit = isPremium ? 
          (userLimits.upload_size_premium || 4) : 
          (userLimits.upload_size || 2);
        
        document.getElementById('upload-limit-value').textContent = uploadLimit;
        document.getElementById('upload-limit-indicator').style.display = 'block';
      }
      
      // Apply premium features if user is premium
      if (isPremium) {
        applyPremiumFeatures();
      }
      
      // Apply any other configuration-based UI changes
      applyConfigurationBasedUI();
    }
    
    // Apply premium features
    function applyPremiumFeatures() {
      // Enable premium game cards
      document.querySelectorAll('.premium-feature').forEach(el => {
        el.style.opacity = '1';
        el.style.pointerEvents = 'auto';
      });
    }
    
    // Apply configuration-based UI changes
    function applyConfigurationBasedUI() {
      // Enable/disable features based on configuration
      if (userLimits.dialog_filters_enabled === false) {
        document.querySelectorAll('[data-feature="dialog_filters"]').forEach(el => {
          el.style.display = 'none';
        });
      }
      
      // Apply theme settings if available
      if (telegramConfig?.theme_settings) {
        applyThemeSettings(telegramConfig.theme_settings);
      }
    }
    
    // Check for and display suggestions
    async function checkSuggestions() {
      try {
        const response = await fetch('/api/config/suggestions', {
          headers: {
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.suggestions.length > 0) {
            pendingSuggestions = data.suggestions;
            dismissedSuggestions = data.dismissed || [];
            
            // Show the first non-dismissed suggestion
            const suggestionToShow = pendingSuggestions.find(
              s => !dismissedSuggestions.includes(s)
            );
            
            if (suggestionToShow) {
              showSuggestion(suggestionToShow);
            }
          }
        }
      } catch (error) {
        console.error('Error checking suggestions:', error);
      }
    }
    
    // Show a suggestion to the user
    function showSuggestion(suggestion) {
      const suggestionContent = document.getElementById('suggestion-content');
      const suggestionContainer = document.getElementById('suggestion-container');
      
      // Map suggestion types to messages
      const suggestionMessages = {
        'AUTOARCHIVE_POPULAR': 'Enable auto-archive to keep your chat list organized automatically.',
        'VALIDATE_PASSWORD': 'Make sure you remember your 2-step verification password for account security.',
        'VALIDATE_PHONE_NUMBER': 'Verify your phone number is correct and accessible.',
        'NEWCOMER_TICKS': 'Learn what the checkmarks mean on your sent messages.',
        'SETUP_PASSWORD': 'Set up 2-step verification to secure your account.',
        'PREMIUM_ANNUAL': 'Get Telegram Premium with annual payments for the best value.',
        'PREMIUM_UPGRADE': 'Upgrade to annual Premium payments for better savings.',
        'PREMIUM_RESTORE': 'Your Premium subscription recently expired. Restore it now!',
        'PREMIUM_CHRISTMAS': 'Gift Premium subscriptions to friends for Christmas!',
        'PREMIUM_GRACE': 'Your Premium subscription is expiring soon. Extend it now!',
        'BIRTHDAY_SETUP': 'Set your birthday to receive special gifts on your day!',
        'STARS_SUBSCRIPTION_LOW_BALANCE': 'Your Star balance is low. Top up to maintain your subscriptions.',
        'USERPIC_SETUP': 'Add a profile picture to personalize your account.'
      };
      
      suggestionContent.textContent = suggestionMessages[suggestion] || 'You have a new suggestion!';
      suggestionContainer.style.display = 'block';
      
      // Auto-hide after 10 seconds
      setTimeout(() => {
        if (suggestionContainer.style.display !== 'none') {
          suggestionContainer.style.display = 'none';
        }
      }, 10000);
    }
    
    // Dismiss a suggestion
    async function dismissSuggestion() {
      const suggestionContainer = document.getElementById('suggestion-container');
      const currentSuggestion = pendingSuggestions[0];
      
      if (!currentSuggestion) return;
      
      try {
        const response = await fetch('/api/config/suggestions/dismiss', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({ suggestion: currentSuggestion })
        });
        
        if (response.ok) {
          dismissedSuggestions.push(currentSuggestion);
          suggestionContainer.style.display = 'none';
          
          // Show next suggestion if available
          const nextSuggestion = pendingSuggestions.find(
            s => !dismissedSuggestions.includes(s)
          );
          
          if (nextSuggestion) {
            setTimeout(() => showSuggestion(nextSuggestion), 2000);
          }
        }
      } catch (error) {
        console.error('Error dismissing suggestion:', error);
      }
    }
    
    // Function to show a specific page
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      const pageElement = document.getElementById(`${pageId}-page`);
      if (pageElement) {
        pageElement.classList.add('active');
      }
    }
    
    // Function to load user data from backend
    async function loadUserData() {
      try {
        const userId = telegramUser ? telegramUser.id : 'demo';
        const response = await fetch('/api/user/data', {
          method: 'GET',
          headers: {
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          }
        });
        
        if (response.ok) {
          userData = await response.json();
          updateUIWithUserData(userData);
        } else {
          console.error('Failed to load user data');
        }
      } catch (error) {
        console.error('Error loading user data:', error);
      }
    }
    
    // Function to update UI with user data
    function updateUIWithUserData(data) {
      if (data.success) {
        // Update balances
        currentBalance = data.game_coins || 0;
        
        document.getElementById('gc-balance').textContent = currentBalance;
        document.getElementById('ton-equivalent').textContent = (currentBalance / 2000).toFixed(6);
        document.getElementById('wallet-gc-balance').textContent = currentBalance;
        document.getElementById('wallet-ton-equivalent').textContent = (currentBalance / 2000).toFixed(2);
        document.getElementById('profile-balance').textContent = (currentBalance / 2000).toFixed(6);
        document.getElementById('menu-balance').textContent = (currentBalance / 2000).toFixed(6) + ' TON';
        
        // Update shop balance display
        document.getElementById('balance-loading').style.display = 'none';
        document.getElementById('balance-value').style.display = 'inline';
        document.getElementById('balance-value').textContent = `${currentBalance} GC`;
        
        // Update stats
        document.getElementById('click-count').textContent = data.clicks_today || 0;
        document.getElementById('total-earned').textContent = (data.total_earned || 0).toFixed(6);
        document.getElementById('games-played').textContent = data.games_played || 0;
        document.getElementById('ads-watched').textContent = data.ads_watched || 0;
        document.getElementById('referrals-count').textContent = data.referrals || 0;
        
        // Update referral stats
        document.getElementById('ref-count').textContent = data.referrals || 0;
        document.getElementById('ref-earnings').textContent = (data.ref_earnings || 0).toFixed(6);
        
        // Update quest progress
        document.getElementById('quest-ads').textContent = data.ads_today || 0;
        document.getElementById('quest-games').textContent = data.games_today || 0;
        document.getElementById('quest-invite').textContent = data.referrals_today || 0;
        
        // Check if bonus was already claimed today
        if (data.bonus_claimed) {
          document.getElementById('daily-bonus-popup').style.display = 'none';
          document.getElementById('quest-bonus-btn').disabled = true;
          document.getElementById('quest-bonus-btn').textContent = 'Claimed';
        }
        
        // Update based on user limits
        if (userLimits) {
          const isPremium = window.Telegram?.WebApp.initDataUnsafe.user?.is_premium || false;
          const maxGC = isPremium ? 
            (userLimits.max_gc_premium || 1000000) : 
            (userLimits.max_gc || 500000);
          
          if (currentBalance >= maxGC * 0.9) {
            // Show warning when approaching limit
            document.getElementById('gc-balance').style.color = '#ff6b6b';
          }
        }
      }
    }
    
    // Function to handle click earning
    async function handleClickEarn() {
      const clickCount = parseInt(document.getElementById('click-count').textContent);
      const clickLimit = parseInt(document.getElementById('click-limit').textContent);
      
      if (clickCount >= clickLimit) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showPopup({
            title: 'Limit Reached',
            message: `You have reached your daily click limit of ${clickLimit}. ${userLimits.daily_clicks_premium ? 'Get Premium for a higher limit!' : 'Try again tomorrow!'}`,
            buttons: [{type: 'ok'}]
          });
          
          // Show premium offer if not premium
          const isPremium = window.Telegram?.WebApp.initDataUnsafe.user?.is_premium || false;
          if (!isPremium && userLimits.daily_clicks_premium) {
            setTimeout(() => showPremiumOffer(), 1500);
          }
        }
        return;
      }
      
      try {
        const response = await fetch('/api/quests/record_click', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({ user_id: telegramUser ? telegramUser.id : 'demo' })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          // Update click count
          document.getElementById('click-count').textContent = result.clicks;
          
          // Update balance
          document.getElementById('gc-balance').textContent = result.game_coins;
          document.getElementById('ton-equivalent').textContent = (result.game_coins / 2000).toFixed(6);
          document.getElementById('wallet-gc-balance').textContent = result.game_coins;
          document.getElementById('wallet-ton-equivalent').textContent = (result.game_coins / 2000).toFixed(2);
          document.getElementById('profile-balance').textContent = (result.game_coins / 2000).toFixed(6);
          
          // Add visual feedback
          const clickArea = document.querySelector('.click-area');
          clickArea.style.transform = 'scale(0.95)';
          setTimeout(() => {
            clickArea.style.transform = 'scale(1)';
          }, 100);
          
          // Show earned amount
          const earnedElement = document.createElement('div');
          earnedElement.textContent = '+0.0001 TON';
          earnedElement.style.position = 'absolute';
          earnedElement.style.color = '#ffd700';
          earnedElement.style.fontWeight = 'bold';
          earnedElement.style.animation = 'floatUp 1s forwards';
          clickArea.appendChild(earnedElement);
          
          setTimeout(() => {
            earnedElement.remove();
          }, 1000);
        } else {
          console.error('Failed to record click');
        }
      } catch (error) {
        console.error('Error recording click:', error);
      }
    }

    // Show premium offer
    function showPremiumOffer() {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.showPopup({
          title: 'Get Premium',
          message: `Upgrade to Premium for ${userLimits.daily_clicks_premium} daily clicks and other exclusive features!`,
          buttons: [
            {id: 'cancel', type: 'cancel', text: 'Later'},
            {id: 'premium', type: 'default', text: 'Learn More'}
          ]
        }, (buttonId) => {
          if (buttonId === 'premium') {
            // Open premium information
            Telegram.WebApp.openLink('https://t.me/PremiumBot');
          }
        });
      }
    }

    // Apply theme settings
    function applyThemeSettings(themeSettings) {
      if (themeSettings.accent_color) {
        document.documentElement.style.setProperty('--tg-theme-button-color', themeSettings.accent_color);
        document.documentElement.style.setProperty('--tg-theme-link-color', themeSettings.accent_color);
      }
      
      if (themeSettings.background_color) {
        document.documentElement.style.setProperty('--tg-theme-bg-color', themeSettings.background_color);
      }
      
      if (themeSettings.text_color) {
        document.documentElement.style.setProperty('--tg-theme-text-color', themeSettings.text)
      }
      
      if (themeSettings.hint_color) {
        document.documentElement.style.setProperty('--tg-theme-hint-color', themeSettings.hint_color);
      }
    }

    // Function to load attachment menu data
    async function loadAttachmentMenuData() {
      try {
        const response = await fetch('/api/attachment-menu/bots', {
          headers: {
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            populateBotLists(data.installed, data.available);
          }
        }
      } catch (error) {
        console.error('Error loading attachment menu data:', error);
      }
    }
    
    // Function to populate bot lists
    function populateBotLists(installedBots, availableBots) {
      const installedList = document.getElementById('installed-bots-list');
      const availableList = document.getElementById('available-bots-list');
      
      // Clear existing content
      installedList.innerHTML = '';
      availableList.innerHTML = '';
      
      // Populate installed bots
      if (installedBots && installedBots.length > 0) {
        installedBots.forEach(bot => {
          const botElement = createBotElement(bot, true);
          installedList.appendChild(botElement);
        });
      } else {
        installedList.innerHTML = '<p style="color: #888; text-align: center;">No mini-apps installed</p>';
      }
      
      // Populate available bots
      if (availableBots && availableBots.length > 0) {
        availableBots.forEach(bot => {
          const botElement = createBotElement(bot, false);
          availableList.appendChild(botElement);
        });
      } else {
        availableList.innerHTML = '<p style="color: #888; text-align: center;">No mini-apps available</p>';
      }
    }
    
    // Function to create a bot element
    function createBotElement(bot, isInstalled) {
      const botItem = document.createElement('div');
      botItem.className = 'bot-item';
      
      botItem.innerHTML = `
        <div class="bot-icon">${bot.icon || 'ü§ñ'}</div>
        <div class="bot-info">
          <div class="bot-name">${bot.name}</div>
          <div class="bot-description">${bot.description || 'Telegram Mini-App'}</div>
        </div>
        <button class="bot-action" onclick="${isInstalled ? 'removeBot' : 'addBot'}('${bot.id}')">
          ${isInstalled ? 'Remove' : 'Add'}
        </button>
      `;
      
      return botItem;
    }
    
    // Function to add a bot to attachment menu
    async function addBot(botId) {
      try {
        const response = await fetch('/api/attachment-menu/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({ bot_id: botId })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // Reload bot lists
            loadAttachmentMenuData();
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Success',
                message: 'Mini-app added to your attachment menu',
                buttons: [{type: 'ok'}]
              });
            }
          }
        }
      } catch (error) {
        console.error('Error adding bot:', error);
      }
    }
    
    // Function to remove a bot from attachment menu
    async function removeBot(botId) {
      try {
        const response = await fetch('/api/attachment-menu/remove', {
          method: 'POST',
          headers: {
            'Content-Type: application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({ bot_id: botId })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // Reload bot lists
            loadAttachmentMenuData();
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Success',
                message: 'Mini-app removed from your attachment menu',
                buttons: [{type: 'ok'}]
              });
            }
          }
        }
    } catch (error) {
        console.error('Error removing bot:', error);
    }
    }

    // Function to purchase an item
    async function purchaseItem(itemId, price) {
      if (currentBalance < price) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showPopup({
            title: 'Insufficient Funds',
            message: `You need ${price} GC to purchase this item`,
            buttons: [{type: 'ok'}]
          });
        } else {
          alert(`You need ${price} GC to purchase this item`);
        }
        return;
      }
      
      try {
        const response = await fetch('/api/shop/purchase', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({
            user_id: telegramUser ? telegramUser.id : 'demo',
            item_id: itemId,
            price: price
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // Update balance
            currentBalance = result.new_gc_balance;
            document.getElementById('gc-balance').textContent = currentBalance;
            document.getElementById('balance-value').textContent = `${currentBalance} GC`;
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Purchase Successful',
                message: `You've purchased ${result.item_name}!`,
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(`You've purchased ${result.item_name}!`);
            }
            
            // Reload user data to ensure everything is in sync
            loadUserData();
          } else {
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Purchase Failed',
                message: result.error || 'Purchase failed',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(result.error || 'Purchase failed');
            }
          }
        } else {
          console.error('Failed to purchase item');
        }
      } catch (error) {
        console.error('Error purchasing item:', error);
      }
    }
    
    // Function to claim daily bonus
    async function claimDailyBonus() {
      try {
        const response = await fetch('/api/quests/claim_bonus', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({ user_id: telegramUser ? telegramUser.id : 'demo' })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            // Hide the popup
            document.getElementById('daily-bonus-popup').style.display = 'none';
            
            // Update balance
            document.getElementById('gc-balance').textContent = result.game_coins;
            document.getElementById('ton-equivalent').textContent = (result.game_coins / 2000).toFixed(6);
            document.getElementById('wallet-gc-balance').textContent = result.game_coins;
            document.getElementById('wallet-ton-equivalent').textContent = (result.game_coins / 2000).toFixed(2);
            document.getElementById('profile-balance').textContent = (result.game_coins / 2000).toFixed(6);
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Bonus Claimed!',
                message: '0.05 TON has been added to your balance',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert('Bonus Claimed! 0.05 TON has been added to your balance');
            }
          } else {
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Already Claimed',
                message: 'You have already claimed your bonus today',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert('You have already claimed your bonus today');
            }
          }
        } else {
          console.error('Failed to claim bonus');
        }
      } catch (error) {
        console.error('Error claiming bonus:', error);
      }
    }
    
    // Function to claim daily bonus from quests page
    async function claimDailyBonusFromQuests() {
      await claimDailyBonus();
      
      // Update quest button
      document.getElementById('quest-bonus-btn').disabled = true;
      document.getElementById('quest-bonus-btn').textContent = 'Claimed';
    }
    
    // Function to check bonus status
    async function checkBonusStatus() {
      try {
        const response = await fetch('/api/user/data', {
          method: 'GET',
          headers: {
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.bonus_claimed) {
            document.getElementById('daily-bonus-popup').style.display = 'none';
            document.getElementById('quest-bonus-btn').disabled = true;
            document.getElementById('quest-bonus-btn').textContent = 'Claimed';
          }
        }
      } catch (error) {
        console.error('Error checking bonus status:', error);
      }
    }
    
    // Function to watch an ad
    async function watchAd() {
      try {
        const response = await fetch('/api/ads/reward', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({ 
            user_id: telegramUser ? telegramUser.id : 'demo',
            ad_id: 'miniapp_ad_' + Date.now()
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            // Update balance
            document.getElementById('gc-balance').textContent = result.game_coins;
            document.getElementById('ton-equivalent').textContent = (result.game_coins / 2000).toFixed(6);
            document.getElementById('wallet-gc-balance').textContent = result.game_coins;
            document.getElementById('wallet-ton-equivalent').textContent = (result.game_coins / 2000).toFixed(2);
            document.getElementById('profile-balance').textContent = (result.game_coins / 2000).toFixed(6);
            
            // Update ads watched count
            const adsWatched = parseInt(document.getElementById('ads-watched').textContent);
            document.getElementById('ads-watched').textContent = adsWatched + 1;
            
            // Update quest progress
            const questAds = parseInt(document.getElementById('quest-ads').textContent);
            document.getElementById('quest-ads').textContent = questAds + 1;
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Ad Completed',
                message: `You earned ${result.reward} TON!`,
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(`Ad Completed! You earned ${result.reward} TON!`);
            }
          }
        } else {
          console.error('Failed to process ad reward');
        }
      } catch (error) {
        console.error('Error watching ad:', error);
      }
    }
    
    // Function to launch a game
    async function launchGame(gameId) {
      try {
        const response = await fetch(`/api/games/launch/${gameId}?user_id=${telegramUser ? telegramUser.id : 'demo'}`, {
          headers: {
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // Enable the game-specific CSS
            const gameCss = document.querySelector(`link[href="/game-assets/${gameId}/${gameId}.css"]`);
            if (gameCss) gameCss.disabled = false;
            
            // Load the game in the game container
            const gameContainer = document.getElementById('game-container');
            const gameFrame = document.getElementById('game-frame');
            
            // Hide all pages and show game container
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            gameContainer.classList.remove('hidden');
            
            // Set game title
            document.getElementById('game-title').textContent = getGameName(gameId);
            
            // Load the game HTML
            fetch(`/game-assets/${gameId}/index.html`)
              .then(response => response.text())
              .then(html => {
                gameFrame.innerHTML = html;
                
                // Load the game JS
                const script = document.createElement('script');
                script.src = `/game-assets/${gameId}/${gameId}.js`;
                document.body.appendChild(script);
              })
              .catch(error => {
                console.error('Error loading game:', error);
                showToast('Failed to load game', 'error');
                exitGame();
              });
          } else {
            console.error('Failed to launch game:', result.error);
          }
        } else {
          console.error('Failed to launch game');
        }
      } catch (error) {
        console.error('Error launching game:', error);
      }
    }
    
    // Function to launch premium games (with Stars requirement)
    function launchPremiumGame(gameId) {
      // Check if user has enough Stars
      if (!userHasPremiumAccess()) {
        showToast('Premium game requires Stars subscription', 'warning');
        showPremiumPopup();
        return;
      }
      
      // Launch the game if user has premium
      launchGame(gameId);
    }
    
    // Exit game and return to main app
    function exitGame() {
      // Hide game container and show home page
      document.getElementById('game-container').classList.add('hidden');
      document.getElementById('home-page').classList.add('active');
      
      // Disable game-specific CSS
      document.querySelectorAll('link[href^="/game-assets/"]').forEach(link => {
        link.disabled = true;
      });
      
      // Clean up game frame
      document.getElementById('game-frame').innerHTML = '';
      
      // Remove any game-specific scripts
      document.querySelectorAll('script[src^="/game-assets/"]').forEach(script => {
        script.remove();
      });
    }
    
    // Helper function to get game display name
    function getGameName(gameId) {
      const gameNames = {
        'trivia': 'Crypto Trivia',
        'spin': 'Lucky Spin',
        'clicker': 'TON Clicker',
        'trex': 'T-Rex Runner',
        'edge-surf': 'Edge Surf',
        'sabotage': 'Crypto Crew: Sabotage',
        'poker': 'Texas Hold\'em Poker',
        'chess': 'ChessMasters',
        'pool': '8-Ball Pool',
        'mini-royal': 'Mini Royal'
      };
      
      return gameNames[gameId] || gameId;
    }
    
    // Check if user has premium access
    function userHasPremiumAccess() {
      // This would check the user's subscription status
      return false; // Placeholder - implement actual check
    }
    
    // Show premium subscription popup
    function showPremiumPopup() {
      showToast('Premium features require Stars subscription', 'info');
      // Implement actual premium popup logic
    }
    
    // Show toast notification
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Function to show withdrawal form
    function showWithdrawalForm() {
      document.getElementById('withdrawal-form').style.display = 'block';
    }
    
    // Function to hide withdrawal form
    function hideWithdrawalForm() {
      document.getElementById('withdrawal-form').style.display = 'none';
    }
    
    // Function to process withdrawal
    async function processWithdrawal() {
      const address = document.getElementById('withdraw-address').value;
      const amount = parseFloat(document.getElementById('withdraw-amount').value);
      
      if (!address) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showPopup({
            title: 'Error',
            message: 'Please enter a wallet address',
            buttons: [{type: 'ok'}]
          });
        } else {
          alert('Please enter a wallet address');
        }
        return;
      }
      
      if (!amount || amount < 0.1) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showPopup({
            title: 'Error',
            message: 'Minimum withdrawal is 0.1 TON',
            buttons: [{type: 'ok'}]
          });
        } else {
          alert('Minimum withdrawal is 0.1 TON');
        }
        return;
      }
      
      try {
        const response = await fetch('/api/withdraw/gc', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({
            user_id: telegramUser ? telegramUser.id : 'demo',
            amount: amount * 2000, // Convert TON to GC
            address: address
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            // Update balance
            document.getElementById('gc-balance').textContent = result.new_gc_balance;
            document.getElementById('ton-equivalent').textContent = (result.new_gc_balance / 2000).toFixed(6);
            document.getElementById('wallet-gc-balance').textContent = result.new_gc_balance;
            document.getElementById('wallet-ton-equivalent').textContent = (result.new_gc_balance / 2000).toFixed(2);
            document.getElementById('profile-balance').textContent = (result.new_gc_balance / 2000).toFixed(6);
            
            hideWithdrawalForm();
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Withdrawal Processing',
                message: 'Your withdrawal is being processed. It may take up to 24 hours.',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert('Withdrawal request submitted. It may take up to 24 hours to process.');
            }
          } else {
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Error',
                message: result.error || 'Withdrawal failed',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(result.error || 'Withdrawal failed');
            }
          }
        } else {
          console.error('Failed to process withdrawal');
        }
      } catch (error) {
        console.error('Error processing withdrawal:', error);
      }
    }
    
    // Function to connect wallet using Telegram's native wallet
    function connectWallet() {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.openInvoice('invoice_url_here', function(status) {
          if (status === 'paid') {
            Telegram.WebApp.showPopup({
              title: 'Wallet Connected',
              message: 'Your Telegram wallet has been successfully connected!',
              buttons: [{type: 'ok'}]
            });
          }
        });
      } else {
        alert('Please open this app in Telegram to connect your wallet');
      }
    }
    
    // Function to update OTC conversion preview
    function updateConversionPreview() {
      const amount = parseFloat(document.getElementById('otc-amount').value) || 0;
      const currency = document.getElementById('otc-currency').value;
      
      if (amount > 0) {
        const rates = {
          'USDT': 6.75,
          'USD': 6.80,
          'KES': 950,
          'EUR': 6.20
        };
        
        const converted = (amount * rates[currency]).toFixed(2);
        const fee = Math.max(amount * 0.03, 1).toFixed(2);
        
        document.getElementById('conversion-text').textContent = 
          `${amount} TON = ${converted} ${currency}`;
        document.getElementById('fee-text').textContent = `Fee: 3% ($${fee})`;
        document.getElementById('conversion-preview').style.display = 'block';
      } else {
        document.getElementById('conversion-preview').style.display = 'none';
      }
    }
    
    // Function to swap TON for cash
    async function swapTonForCash() {
      const amount = parseFloat(document.getElementById('otc-amount').value) || 0;
      const currency = document.getElementById('otc-currency').value;
      
      if (amount <= 0) {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.showPopup({
            title: 'Error',
            message: 'Please enter a valid amount',
            buttons: [{type: 'ok'}]
          });
        } else {
          alert('Please enter a valid amount');
        }
        return;
      }
      
      try {
        const response = await fetch('/api/otc/swap', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-InitData': window.Telegram ? Telegram.WebApp.initData : ''
          },
          body: JSON.stringify({
            user_id: telegramUser ? telegramUser.id : 'demo',
            amount: amount,
            currency: currency
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            // Update balance
            document.getElementById('gc-balance').textContent = result.new_gc_balance;
            document.getElementById('ton-equivalent').textContent = (result.new_gc_balance / 2000).toFixed(6);
            document.getElementById('wallet-gc-balance').textContent = result.new_gc_balance;
            document.getElementById('wallet-ton-equivalent').textContent = (result.new_gc_balance / 2000).toFixed(2);
            document.getElementById('profile-balance').textContent = (result.new_gc_balance / 2000).toFixed(6);
            
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Swap Successful',
                message: `Your TON has been converted to ${currency}`,
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(`Your TON has been converted to ${currency}`);
            }
          } else {
            if (window.Telegram && Telegram.WebApp) {
              Telegram.WebApp.showPopup({
                title: 'Error',
                message: result.error || 'Swap failed',
                buttons: [{type: 'ok'}]
              });
            } else {
              alert(result.error || 'Swap failed');
            }
          }
        } else {
          console.error('Failed to process swap');
        }
        } catch (error) {
        console.error('Error processing swap:', error);
      };
    }
    
    // Function to logout
    function logout() {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.showPopup({
          title: 'Logout',
          message: 'Are you sure you want to logout?',
          buttons: [
            {id: 'cancel', type: 'cancel', text: 'Cancel'},
            {id: 'logout', type: 'destructive', text: 'Logout'}
          ]
        }, function(buttonId) {
          if (buttonId === 'logout') {
            // Clear local data
            localStorage.clear();
            // Close the WebApp
            Telegram.WebApp.close();
          }
        });
      } else {
        if (confirm('Are you sure you want to logout?')) {
          localStorage.clear();
          window.location.reload();
        }
        
      }
    }

    <!-- Fallback scripts for missing functionality -->
    // Create minimal versions of missing APIs if needed
    if (typeof window.API === 'undefined') {
        window.API = {
            call: async function(endpoint, options = {}) {
                try {
                    const response = await fetch(endpoint, {
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Telegram-Hash': window.Telegram ? Telegram.WebApp.initData : ''
                        },
                        ...options
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API call failed:', error);
                    throw error;
                }
            }
        };
    }

    // Legal content templates
    const legalContent = {
      about: {
        title: "About CryptoGamer",
        content: `
          <h1>About CryptoGamer</h1>
          <p>Welcome to <span class="highlight">CryptoGamer</span>, the ultimate gaming platform on Telegram where you can play exciting games, earn TON cryptocurrency, and bet with Telegram Stars!</p>
          
          <h2>Our Mission</h2>
          <p>Our mission is to create a fun and rewarding gaming ecosystem that leverages blockchain technology to provide real value to our players. We believe that your time spent gaming should be both entertaining and financially rewarding.</p>
          
          <h2>What We Offer</h2>
          <ul>
            <li><span class="highlight">Free Games:</span> Trivia, Spin, Clicker, T-Rex, and Edge Surf</li>
            <li><span class="highlight">Premium Games:</span> Poker, Chess, Crypto Crew: Sabotage, Pool, and Mini Royal</li>
            <li><span class="highlight">Earn TON:</span> Get rewarded with TON cryptocurrency for playing games</li>
            <li><span class="highlight">Telegram Stars:</span> Bet Stars against friends in competitive matches</li>
            <li><span class="highlight">Daily Bonuses:</span> Claim daily rewards just for logging in</li>
            <li><span class="highlight">Referral Program:</span> Earn more by inviting friends</li>
          </ul>
          
          <h2>How It Works</h2>
          <p>Play our free games to earn game coins, which can be converted to TON cryptocurrency upon reaching the withdrawal threshold. For premium games, use Telegram Stars to bet against other players and win big!</p>
          
          <p><span class="highlight">Conversion Rate:</span> 200,000 game coins = 100 TON</p>
          
          <h2>Our Team</h2>
          <p>CryptoGamer is developed by a team of passionate gamers and blockchain experts who are dedicated to creating the best gaming experience on Telegram. We're constantly working to add new games and features to keep the platform fresh and exciting.</p>
        `
      },
      terms: {
        title: "Terms of Service",
        content: `
          <h1>Terms of Service</h1>
          <p>Last Updated: [Date]</p>
          
          <p>Welcome to CryptoGamer! These Terms of Service govern your use of our mini-app on Telegram. By accessing or using CryptoGamer, you agree to be bound by these Terms.</p>
          
          <h2>1. Account Registration</h2>
          <p>You must have a Telegram account to use our services. You are responsible for maintaining the security of your Telegram account and any activities that occur under your account.</p>
          
          <h2>2. Eligibility</h2>
          <p>You must be at least 18 years old to use CryptoGamer. By using our services, you represent that you are at least 18 years of age.</p>
          
          <h2>3. Game Rules and Fair Play</h2>
          <p>All users are expected to play fairly. Any form of cheating, exploiting bugs, or using unauthorized third-party software will result in immediate termination of your account and forfeiture of any earned rewards.</p>
          
          <h2>4. Rewards and Withdrawals</h2>
          <p>Game coins earned through gameplay can be converted to TON cryptocurrency upon reaching the withdrawal threshold of 200,000 game coins. CryptoGamer reserves the right to modify conversion rates and withdrawal thresholds with prior notice.</p>
          
          <h2>5. Premium Games and Betting</h2>
          <p>Premium games require Telegram Stars to play. By participating in these games, you acknowledge that you understand the risks involved with betting and that outcomes are determined by skill and chance.</p>
          
          <h2>6. Intellectual Property</h2>
          <p>All games, content, and trademarks on CryptoGamer are the property of CryptoGamer and are protected by intellectual property laws. You may not copy, distribute, or create derivative works without our explicit permission.</p>
          
          <h2>7. Termination</h2>
          <p>We reserve the right to suspend or terminate your account at our discretion if you violate these Terms or engage in any fraudulent or harmful activities.</p>
          
          <h2>8. Changes to Terms</h2>
          <p>We may update these Terms from time to time. Continued use of CryptoGamer after changes constitutes acceptance of the new Terms.</p>
        `
      },
      privacy: {
        title: "Privacy Policy",
        content: `
          <h1>Privacy Policy</h1>
          <p>Last Updated: [Date]</p>
          
          <p>At CryptoGamer, we value your privacy. This Privacy Policy explains how we collect, use, and protect your information.</p>
          
          <h2>1. Information We Collect</h2>
          <p>We collect information from your Telegram account, including your username, first name, last name, and user ID. We also collect data about your gameplay, rewards, and transactions.</p>
          
          <h2>2. How We Use Your Information</h2>
          <p>We use your information to:</p>
          <ul>
            <li>Provide and improve our gaming services</li>
            <li>Process rewards and withdrawals</li>
            <li>Personalize your gaming experience</li>
            <li>Detect and prevent fraud</li>
            <li>Communicate with you about updates and promotions</li>
          </ul>
          
          <h2>3. Data Sharing</h2>
          <p>We do not sell your personal information. We may share limited information with:</p>
          <ul>
            <li>Payment processors for transaction completion</li>
            <li>Legal authorities when required by law</li>
            <li>Service providers who assist in our operations</li>
          </ul>
          
          <h2>4. Data Security</h2>
          <p>We implement industry-standard security measures to protect your data. However, no method of electronic transmission or storage is 100% secure.</p>
          
          <h2>5. Third-Party Links</h2>
          <p>Our mini-app may contain links to third-party services. We are not responsible for the privacy practices of these third parties.</p>
          
          <h2>6. Children's Privacy</h2>
          <p>CryptoGamer is not intended for users under 18 years of age. We do not knowingly collect information from children.</p>
          
          <h2>7. Changes to Privacy Policy</h2>
          <p>We may update this Privacy Policy periodically. We will notify users of significant changes through our platform.</p>
        `
      },
      disclaimer: {
        title: "Disclaimer",
        content: `
          <h1>Disclaimer</h1>
          
          <h2>Financial Disclaimer</h2>
          <p>CryptoGamer provides entertainment services. While you can earn cryptocurrency through gameplay, we do not guarantee any specific earnings. The value of cryptocurrencies like TON can fluctuate significantly.</p>
          
          <h2>No Investment Advice</h2>
          <p>Nothing on CryptoGamer constitutes financial or investment advice. You are solely responsible for any financial decisions you make.</p>
          
          <h2>Gambling Disclaimer</h2>
          <p>Premium games involving Telegram Stars may be considered gambling in some jurisdictions. You are responsible for complying with your local laws regarding online betting and gambling.</p>
          
          <h2>Limitation of Liability</h2>
          <p>CryptoGamer is not liable for any losses or damages resulting from your use of our platform, including but not limited to loss of funds, data breaches, or gameplay interruptions.</p>
          
          <h2>Technical Issues</h2>
          <p>We are not responsible for rewards lost due to technical issues, including server outages, wallet connection problems, or Telegram API failures.</p>
        `
      },
      contact: {
        title: "Contact Us",
        content: `
          <h1>Contact Us</h1>
          
          <p>If you have any questions about these terms, policies, or CryptoGamer in general, please contact us through one of the following methods:</p>
          
          <h2>Telegram Support</h2>
          <p>For the fastest response, please message our support bot: <span class="highlight">@CryptoGamerSupportBot</span></p>
          
          <h2>Email</h2>
          <p>You can email us at: <span class="highlight">support@cryptogamer.com</span></p>
          
          <h2>Response Time</h2>
          <p>We strive to respond to all inquiries within 24-48 hours. For technical issues, please include your Telegram username and a detailed description of the problem.</p>
          
          <h2>Bug Reports</h2>
          <p>If you've found a bug or exploit, please report it immediately to our support team. Responsible disclosure is appreciated and may be rewarded.</p>
        `
      }
    };

    // Function to show legal content
    function showLegalContent(type) {
      const modal = document.getElementById('legal-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      
      if (legalContent[type]) {
        title.textContent = legalContent[type].title;
        body.innerHTML = legalContent[type].content;
        modal.style.display = 'flex';
        
        // Close profile menu if open
        document.getElementById('profile-menu').style.display = 'none';
      }
    }

    // Function to close legal modal
    function closeLegalModal() {
      document.getElementById('legal-modal').style.display = 'none';
    }

    // Close modal when clicking outside content
    document.getElementById('legal-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeLegalModal();
      }
    });

    // Add keyboard escape functionality
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeLegalModal();
      }
    });

  </script>
</body>
</html>