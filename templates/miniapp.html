<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ® CryptoGameMiner</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* All CSS from miniapp.html */
    :root {
      --bg-dark: #0d0d0d;
      --text-light: #f5f5f5;
      --primary-yellow: #ffcc00;
      --secondary-gray: #1a1a1a;
      --accent-green: #00e676;
      --gradient-purple: linear-gradient(135deg,#3f51b5,#9c27b0);
      --shadow-light: 0 2px 8px rgba(0,0,0,0.3);
      --shadow-heavy: 0 4px 12px rgba(0,0,0,0.5);
    }

    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }

    body {
      background: var(--bg-dark);
      color: var(--text-light);
      min-height: 100vh;
      padding-bottom: 80px;
      overflow-x: hidden;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 12px;
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--secondary-gray);
      border-top: 4px solid var(--primary-yellow);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .app-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      padding: 16px; 
      background: var(--secondary-gray);
      border-radius: 12px; 
      box-shadow: var(--shadow-heavy);
      margin-bottom: 16px;
    }

    .profile-btn {
      background: var(--gradient-purple);
      padding: 8px 12px; 
      border: none; 
      border-radius: 20px;
      color: #fff; 
      font-weight: 600; 
      cursor: pointer;
      display: flex; 
      align-items: center; 
      gap: 6px;
      box-shadow: var(--shadow-light);
      transition: transform 0.2s ease;
    }

    .profile-btn:hover, .profile-btn:active { 
      transform: scale(1.05); 
    }

    .balance-display {
      background: var(--accent-green); 
      padding: 8px 16px;
      border-radius: 20px; 
      font-weight: 700; 
      color: #000;
      box-shadow: var(--shadow-light);
      font-size: 1.1rem;
    }

    .security-alert {
      background: linear-gradient(135deg, #ff4444, #cc0000);
      color: white;
      padding: 12px;
      text-align: center;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
      font-weight: 600;
      box-shadow: var(--shadow-heavy);
    }

    .page { 
      display: none; 
      padding: 8px 0; 
      animation: fadeIn 0.3s ease-in; 
    }

    .page.active { 
      display: block; 
    }

    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    .section {
      background: var(--secondary-gray);
      border-radius: 12px; 
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-heavy);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .section-title {
      font-size: 1.4rem; 
      margin-bottom: 12px;
      background: var(--gradient-purple);
      -webkit-background-clip: text; 
      background-clip: text;
      color: transparent;
      font-weight: 700;
    }

    .btn {
      background: var(--primary-yellow);
      color: #000; 
      border: none; 
      border-radius: 10px;
      padding: 14px 20px; 
      font-weight: 700; 
      font-size: 1rem;
      width: 100%; 
      cursor: pointer; 
      margin: 8px 0;
      box-shadow: var(--shadow-light);
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn:hover, .btn:active {
      transform: translateY(-2px);
      box-shadow: var(--shadow-heavy);
      background: #ffdd33;
    }

    .btn:disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
      transform: none;
      box-shadow: var(--shadow-light);
    }

    .btn-secondary {
      background: transparent; 
      color: var(--primary-yellow);
      border: 2px solid var(--primary-yellow);
    }

    .btn-secondary:hover, .btn-secondary:active {
      background: var(--primary-yellow);
      color: #000;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
      width: auto;
      display: inline-block;
    }

    .click-area {
      background: linear-gradient(135deg, #111, #222);
      border: 3px dashed var(--primary-yellow);
      height: 180px; 
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer; 
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .click-area::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,204,0,0.2), transparent);
      transition: left 0.5s;
    }

    .click-area:hover::before {
      left: 100%;
    }

    .click-area:hover { 
      background: linear-gradient(135deg, #222, #333);
      transform: scale(1.02);
    }

    .click-area:active {
      transform: scale(0.98);
    }

    .click-text { 
      color: var(--primary-yellow); 
      font-size: 1.8rem; 
      font-weight: 800; 
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      z-index: 1;
    }

    .game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }

    .game-card {
      background: var(--secondary-gray);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .game-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-heavy);
      border-color: var(--primary-yellow);
    }

    .game-icon {
      width: 60px;
      height: 60px;
      background: var(--gradient-purple);
      border-radius: 50%;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .game-name {
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .nav-bar {
      position: fixed; 
      bottom: 0; 
      left: 0; 
      right: 0;
      background: var(--secondary-gray); 
      display: flex;
      justify-content: space-around; 
      padding: 12px 8px 20px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.5);
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .nav-btn {
      background: none; 
      border: none; 
      color: #888;
      display: flex; 
      flex-direction: column; 
      align-items: center;
      font-size: 0.75rem; 
      cursor: pointer; 
      transition: all 0.2s ease;
      padding: 8px 4px;
      border-radius: 8px;
      min-width: 50px;
    }

    .nav-btn.active { 
      color: var(--primary-yellow);
      background: rgba(255,204,0,0.1);
    }

    .nav-btn:hover:not(.active) {
      color: #ccc;
    }

    .nav-icon {
      font-size: 1.2rem;
      margin-bottom: 4px;
    }

    .quest-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .quest-item:last-child {
      border-bottom: none;
    }

    .referral-box {
      background: var(--gradient-purple); 
      padding: 20px;
      border-radius: 12px; 
      text-align: center; 
      color: #fff;
      box-shadow: var(--shadow-heavy);
      margin-bottom: 16px;
    }

    .referral-link {
      background: rgba(0,0,0,0.3); 
      color: var(--primary-yellow);
      padding: 12px; 
      border-radius: 8px; 
      margin: 12px 0;
      display: block; 
      word-break: break-all;
      font-family: monospace;
      font-size: 0.9rem;
      border: 1px solid rgba(255,204,0,0.3);
    }

    input, select {
      width: 100%; 
      padding: 12px; 
      margin: 8px 0; 
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px; 
      background: rgba(255,255,255,0.05); 
      color: #fff;
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-yellow);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 16px 0;
    }

    .stat-card {
      background: rgba(255,255,255,0.05);
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-yellow);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #ccc;
      margin-top: 4px;
    }

    .achievement-grid {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    .achievement-badge {
      background: var(--gradient-purple);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }

    @media (max-width: 480px) {
      .container {
        padding: 8px;
      }
      
      .nav-bar {
        padding: 8px 4px 16px;
      }
      
      .nav-btn {
        font-size: 0.7rem;
        min-width: 45px;
      }
      
      .game-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .section {
        padding: 16px;
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    @keyframes slideInUp {
      from { 
        transform: translateY(100%); 
        opacity: 0; 
      }
      to { 
        transform: translateY(0); 
        opacity: 1; 
      }
    }

    .slide-in {
      animation: slideInUp 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading Spinner -->
    <div class="spinner-overlay" id="global-spinner">
      <div class="spinner"></div>
    </div>

    <!-- Security Alert -->
    <div class="security-alert" id="security-alert">
      âš ï¸ Suspicious activity detected! Account temporarily restricted.
    </div>

    <!-- HEADER -->
    <header class="app-header slide-in">
      <button class="profile-btn" onclick="showPage('profile')">
        <span class="nav-icon">ğŸ‘¤</span>
        <span id="profile-username">Guest</span>
      </button>
      <div class="balance-display">
        <span id="balance">0.00</span> TON
      </div>
    </header>

    <!-- HOME -->
    <div id="home-page" class="page active">
      <div class="section slide-in">
        <h2 class="section-title">ğŸ Daily Bonus</h2>
        <p style="margin-bottom: 16px; color: #ccc;">
          Grab your daily reward and keep the momentum going!
        </p>
        <button class="btn" id="bonus-btn" onclick="claimDailyBonus()">
          ğŸ Claim 0.05 TON
        </button>
      </div>

      <div class="section slide-in">
        <h2 class="section-title">âš¡ Click & Earn</h2>
        <div class="click-area" onclick="earnFromClick()">
          <div class="click-text">TAP TO EARN</div>
        </div>
        <p style="text-align: center; margin-top: 12px; color: #ccc;">
          Clicks today: <span id="click-count" style="color: var(--primary-yellow); font-weight: bold;">0</span>/100
        </p>
      </div>

      <div class="section slide-in">
        <h2 class="section-title">ğŸ® Featured Games</h2>
        <div class="game-grid">
          <div class="game-card" onclick="launchGame('trivia')">
            <div class="game-icon">â“</div>
            <div class="game-name">Crypto Trivia</div>
          </div>
          <div class="game-card" onclick="launchGame('spin')">
            <div class="game-icon">ğŸ¡</div>
            <div class="game-name">Lucky Spin</div>
          </div>
          <div class="game-card" onclick="launchGame('clicker')">
            <div class="game-icon">ğŸ–±ï¸</div>
            <div class="game-name">TON Clicker</div>
          </div>
          <div class="game-card" onclick="launchGame('trex')">
            <div class="game-icon">ğŸ¦–</div>
            <div class="game-name">T-Rex Runner</div>
          </div>
        </div>
      </div>
    </div>

    <!-- WATCH ADS -->
    <div id="watch-page" class="page">
      <div class="section">
        <h2 class="section-title">ğŸ“º Watch & Earn</h2>
        <p style="margin-bottom: 16px; color: #ccc;">
          Watch video ads and boost your TON balance instantly!
        </p>
        <button class="btn" onclick="rewardedInterstitial()">
          â–¶ï¸ Watch Ad & Earn 0.003 TON
        </button>
        <div style="margin-top: 16px; padding: 12px; background: rgba(255,204,0,0.1); border-radius: 8px;">
          <small style="color: #ffcc00;">ğŸ’¡ Tip: Weekend ads give 20% bonus!</small>
        </div>
      </div>

      <!-- Ad Banner Space -->
      <div class="section" style="padding: 0; overflow: hidden; min-height: 200px;">
        <div style="width: 100%; height: 200px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
          <div style="text-align: center; color: #666;">
            <div style="font-size: 2rem; margin-bottom: 8px;">ğŸ“º</div>
            <div>Ad Banner Placeholder</div>
          </div>
        </div>
      </div>
    </div>

    <!-- WALLET -->
    <div id="wallet-page" class="page">
      <div class="section">
        <h2 class="section-title">ğŸ’° Your Wallet</h2>
        <div style="text-align: center; margin: 20px 0;">
          <div style="font-size: 3rem; font-weight: 700; color: var(--accent-green);">
            <span id="wallet-balance">0.00</span> TON
          </div>
          <div style="color: #888; margin-top: 8px;">Total Balance</div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
          <button class="btn btn-secondary" onclick="receive()">
            ğŸ“¥<br/>Receive
          </button>
          <button class="btn btn-secondary" onclick="send()">
            ğŸ“¤<br/>Send
          </button>
          <button class="btn btn-secondary" onclick="showPage('otc')">
            ğŸ’±<br/>Trade
          </button>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">ğŸ“ˆ Staking</h2>
        <div style="margin-bottom: 16px;">
          <p>Earn <span style="color: var(--accent-green); font-weight: bold;">8.5% APY</span> on deposits of 5+ TON</p>
          <small style="color: #888;">Rewards are distributed daily</small>
        </div>
        <button class="btn" onclick="stake()">
          ğŸ’° Start Staking (5 TON min)
        </button>
      </div>

      <div class="section">
        <h2 class="section-title">ğŸ“Š Stats</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="total-earned">0.00</div>
            <div class="stat-label">Total Earned</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="games-played">0</div>
            <div class="stat-label">Games Played</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="ads-watched">0</div>
            <div class="stat-label">Ads Watched</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="referrals-count">0</div>
            <div class="stat-label">Referrals</div>
          </div>
        </div>
      </div>
    </div>

    <!-- GAMES -->
    <div id="games-page" class="page">
      <div class="section">
        <h2 class="section-title">ğŸ® All Games</h2>
        <p style="margin-bottom: 20px; color: #ccc;">
          Play games, earn TON coins, and climb the leaderboards!
        </p>
        
        <div class="game-grid">
          <div class="game-card" onclick="launchGame('trivia')">
            <div class="game-icon">â“</div>
            <div class="game-name">Crypto Trivia</div>
            <small style="color: #888;">Test your knowledge</small>
          </div>
          
          <div class="game-card" onclick="launchGame('spin')">
            <div class="game-icon">ğŸ¡</div>
            <div class="game-name">Lucky Spin</div>
            <small style="color: #888;">Spin to win big</small>
          </div>
          
          <div class="game-card" onclick="launchGame('clicker')">
            <div class="game-icon">ğŸ–±ï¸</div>
            <div class="game-name">TON Clicker</div>
            <small style="color: #888;">Click for rewards</small>
          </div>
          
          <div class="game-card" onclick="launchGame('trex')">
            <div class="game-icon">ğŸ¦–</div>
            <div class="game-name">T-Rex Runner</div>
            <small style="color: #888;">Endless runner</small>
          </div>
          
          <div class="game-card" onclick="launchGame('edge-surf')">
            <div class="game-icon">ğŸ„</div>
            <div class="game-name">Edge Surf</div>
            <small style="color: #888;">Surf the web</small>
          </div>
          
          <div class="game-card" style="opacity: 0.6;">
            <div class="game-icon">ğŸ²</div>
            <div class="game-name">More Games</div>
            <small style="color: #888;">Coming soon</small>
          </div>
        </div>
      </div>
    </div>

    <!-- QUESTS -->
    <div id="quests-page" class="page">
      <div class="section">
        <h2 class="section-title">ğŸ“ Daily Quests</h2>
        <p style="margin-bottom: 16px; color: #ccc;">
          Complete daily tasks to earn bonus rewards!
        </p>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">âœ… Claim Daily Bonus</div>
            <small style="color: #888;">Reward: 0.05 TON</small>
          </div>
          <button class="btn btn-small" id="quest-bonus" disabled>Done</button>
        </div>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">ğŸ“º Watch 3 Ads</div>
            <small style="color: #888;">Progress: <span id="quest-ads">0</span>/3 | Reward: 0.02 TON</small>
          </div>
          <button class="btn btn-small btn-secondary" onclick="showPage('watch')">Watch</button>
        </div>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">ğŸ® Play 2 Games</div>
            <small style="color: #888;">Progress: <span id="quest-games">0</span>/2 | Reward: 0.03 TON</small>
          </div>
          <button class="btn btn-small btn-secondary" onclick="showPage('games')">Play</button>
        </div>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">ğŸ‘¥ Invite 1 Friend</div>
            <small style="color: #888;">Progress: <span id="quest-invite">0</span>/1 | Reward: 0.05 TON</small>
          </div>
          <button class="btn btn-small btn-secondary" onclick="showPage('referrals')">Invite</button>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">ğŸ† Weekly Challenges</h2>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">ğŸ”¥ 7-Day Streak</div>
            <small style="color: #888;">Login daily for a week | Reward: 0.5 TON</small>
          </div>
          <div style="color: var(--primary-yellow); font-weight: bold;">3/7</div>
        </div>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">ğŸ’¯ Score 1000+ Points</div>
            <small style="color: #888;">In any game | Reward: 0.1 TON</small>
          </div>
          <div style="color: #888;">0/1000</div>
        </div>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">ğŸ“± Share App</div>
            <small style="color: #888;">Share with 5 friends | Reward: 0.25 TON</small>
          </div>
          <button class="btn btn-small btn-secondary" onclick="shareMission()">Share</button>
        </div>
      </div>
    </div>

    <!-- OTC TRADING -->
    <div id="otc-page" class="page">
      <div class="section">
        <h2 class="section-title">ğŸ’± OTC Exchange</h2>
        <p style="margin-bottom: 20px; color: #ccc;">
          Trade your TON for fiat currencies instantly!
        </p>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Amount (TON)</label>
          <input type="number" id="otc-amount" placeholder="0.00" step="0.01" min="0.1" />
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Currency</label>
          <select id="otc-currency">
            <option value="USDT">USDT (Tether)</option>
            <option value="USD">USD (US Dollar)</option>
            <option value="KES">KES (Kenyan Shilling)</option>
            <option value="EUR">EUR (Euro)</option>
          </select>
        </div>
        
        <div id="conversion-preview" style="background: rgba(255,204,0,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;">
          <div style="color: var(--primary-yellow); font-weight: 600;">Conversion Preview:</div>
          <div id="conversion-text"></div>
          <small style="color: #888;">Fee: 3% (min $1.00)</small>
        </div>
        
        <button class="btn" onclick="swapTon()">
          ğŸ’± Start Exchange
        </button>
      </div>

      <div class="section">
        <h2 class="section-title">ğŸ’¹ Current Rates</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">$5.82</div>
            <div class="stat-label">1 TON = USD</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">750</div>
            <div class="stat-label">1 TON = KES</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">â‚¬5.32</div>
            <div class="stat-label">1 TON = EUR</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">5.80</div>
            <div class="stat-label">1 TON = USDT</div>
          </div>
        </div>
        <small style="color: #888; display: block; text-align: center; margin-top: 12px;">
          â° Rates updated every 5 minutes
        </small>
      </div>
    </div>

    <!-- REFERRALS -->
    <div id="referrals-page" class="page">
      <div class="referral-box">
        <h2>ğŸ‘¥ Invite & Earn</h2>
        <p style="margin: 12px 0;">Earn 20% of your friends' earnings forever!</p>
        <div class="referral-link" id="ref-link">
          https://t.me/CryptoGameMinerBot?start=ref-xyz123
        </div>
        <button class="btn" onclick="copyReferralLink()" style="background: rgba(255,255,255,0.2); color: white;">
          ğŸ“‹ Copy Invite Link
        </button>
      </div>

      <div class="section">
        <h2 class="section-title">ğŸ“Š Your Referral Stats</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="ref-count">0</div>
            <div class="stat-label">Friends Invited</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="ref-earnings">0.00</div>
            <div class="stat-label">Total Earned (TON)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="ref-active">0</div>
            <div class="stat-label">Active This Week</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="ref-level">1</div>
            <div class="stat-label">Referrer Level</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">ğŸ¯ Referral Milestones</h2>
        <div style="margin: 16px 0;">
          <div class="quest-item">
            <span>ğŸ¥‰ 3 referrals â†’ Bonus 0.01 TON</span>
            <span style="color: var(--accent-green);">âœ…</span>
          </div>
          <div class="quest-item">
            <span>ğŸ¥ˆ 10 referrals â†’ Bonus 0.05 TON</span>
            <span style="color: #888;">0/10</span>
          </div>
          <div class="quest-item">
            <span>ğŸ¥‡ 50 referrals â†’ Bonus 0.25 TON</span>
            <span style="color: #888;">0/50</span>
          </div>
          <div class="quest-item">
            <span>ğŸ’ 100 referrals â†’ Bonus 1.0 TON</span>
            <span style="color: #888;">0/100</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="profile-page" class="page">
      <div class="section">
        <h2 class="section-title">ğŸ‘¤ Profile</h2>
        <div style="text-align: center; margin: 20px 0;">
          <div style="width: 80px; height: 80px; background: var(--gradient-purple); border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
            ğŸ‘¤
          </div>
          <h3 id="profile-name">Guest</h3>
          <p style="color: #888;">Member since today</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; margin: 16px 0;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Current Balance:</span>
            <span style="color: var(--accent-green); font-weight: bold;"><span id="profile-balance">0.00</span> TON</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Total Earned:</span>
            <span style="color: var(--primary-yellow); font-weight: bold;">0.00 TON</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>Account Level:</span>
            <span style="color: #888;">Beginner</span>
          </div>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">ğŸ† Achievements</h2>
        <div class="achievement-grid">
          <div class="achievement-badge">ğŸ¯ First Click</div>
          <div class="achievement-badge">ğŸ“º Ad Watcher</div>
          <div class="achievement-badge" style="opacity: 0.5;">ğŸ® Game Master</div>
          <div class="achievement-badge" style="opacity: 0.5;">ğŸ’° Big Earner</div>
          <div class="achievement-badge" style="opacity: 0.5;">ğŸ‘¥ Influencer</div>
          <div class="achievement-badge" style="opacity: 0.5;">â­ VIP Member</div>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">âš™ï¸ Settings & Info</h2>
        <button class="btn btn-secondary" onclick="showHelp()">
          â“ Help & Support
        </button>
        <button class="btn btn-secondary" onclick="showAbout()">
          ğŸ“œ About CryptoGameMiner
        </button>
        <button class="btn btn-secondary" onclick="showTerms()">
          ğŸ“„ Terms of Service
        </button>
        <button class="btn btn-secondary" onclick="showPrivacy()">
          ğŸ”’ Privacy Policy
        </button>
      </div>
    </div>

  </div>

  <!-- NAVIGATION -->
  <nav class="nav-bar">
    <button class="nav-btn active" onclick="showPage('home')">
      <span class="nav-icon">ğŸ </span>
      <span>Home</span>
    </button>
    <button class="nav-btn" onclick="showPage('watch')">
      <span class="nav-icon">ğŸ“º</span>
      <span>Watch</span>
    </button>
    <button class="nav-btn" onclick="showPage('wallet')">
      <span class="nav-icon">ğŸ’°</span>
      <span>Wallet</span>
    </button>
    <button class="nav-btn" onclick="showPage('games')">
      <span class="nav-icon">ğŸ®</span>
      <span>Games</span>
    </button>
    <button class="nav-btn" onclick="showPage('quests')">
      <span class="nav-icon">ğŸ“</span>
      <span>Quests</span>
    </button>
    <button class="nav-btn" onclick="showPage('otc')">
      <span class="nav-icon">ğŸ’±</span>
      <span>Trade</span>
    </button>
    <button class="nav-btn" onclick="showPage('referrals')">
      <span class="nav-icon">ğŸ‘¥</span>
      <span>Invite</span>
    </button>
  </nav>

  <script>
    // Initialize Telegram WebApp
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      tg.enableClosingConfirmation();
    }

    // Application state
    let userData = {
      id: null,
      username: 'Guest',
      balance: 0,
      clicks: 0,
      referrals: 0,
      refEarnings: 0,
      bonusClaimed: false,
      adsWatched: 0,
      gamesPlayed: 0
    };

    let securityToken = null;
    let securityTimer = null;

    // Utility functions
    function generateSecurityToken() {
      const token = Math.random().toString(36).substring(2, 15);
      const timestamp = Math.floor(Date.now() / 1000);
      return btoa(`${userData.id || 'anon'}:${timestamp}`);
    }

    function showSpinner() {
      document.getElementById('global-spinner').style.display = 'flex';
    }

    function hideSpinner() {
      document.getElementById('global-spinner').style.display = 'none';
    }

    function showAlert(title, message) {
      if (tg && tg.showPopup) {
        tg.showPopup({
          title: title,
          message: message,
          buttons: [{ id: 'ok', type: 'ok' }]
        });
      } else {
        alert(`${title}: ${message}`);
      }
    }

    // API request helper
    async function apiRequest(endpoint, method = 'GET', body = null) {
      const headers = {
        'Content-Type': 'application/json',
        'X-Telegram-InitData': tg?.initData || '',
        'X-Security-Token': generateSecurityToken()
      };

      try {
        showSpinner();
        
        const options = { method, headers };
        if (body) {
          options.body = JSON.stringify(body);
        }

        const response = await fetch(endpoint, options);

        // Handle security restrictions
        if (response.status === 403) {
          document.getElementById('security-alert').style.display = 'block';
          showAlert('Account Restricted', 'Please contact support for assistance.');
          return null;
        }

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Request failed');
        }

        return await response.json();
      } catch (error) {
        console.error('API request failed:', error);
        showAlert('Error', error.message || 'Something went wrong');
        throw error;
      } finally {
        hideSpinner();
      }
    }

    // Update UI elements
    function updateUI() {
      // Update balance displays
      document.querySelectorAll('#balance, #wallet-balance, #profile-balance').forEach(el => {
        el.textContent = userData.balance.toFixed(2);
      });

      // Update click count
      document.getElementById('click-count').textContent = userData.clicks;

      // Update username displays
      document.querySelectorAll('#profile-username, #profile-name').forEach(el => {
        el.textContent = userData.username;
      });

      // Update referral stats
      document.getElementById('ref-count').textContent = userData.referrals;
      document.getElementById('ref-earnings').textContent = userData.refEarnings.toFixed(2);

      // Update quest progress
      document.getElementById('quest-ads').textContent = userData.adsWatched;
      document.getElementById('quest-games').textContent = userData.gamesPlayed;

      // Update bonus button
      const bonusBtn = document.getElementById('bonus-btn');
      if (bonusBtn) {
        if (userData.bonusClaimed) {
          bonusBtn.textContent = 'âœ… Bonus Claimed Today';
          bonusBtn.disabled = true;
          bonusBtn.style.background = '#666';
        } else {
          bonusBtn.textContent = 'ğŸ Claim 0.05 TON';
          bonusBtn.disabled = false;
          bonusBtn.style.background = 'var(--primary-yellow)';
        }
      }
    }

    // Load user data from API
    async function loadUserData() {
      try {
        const response = await apiRequest('/api/user/data');
        if (response && response.success) {
          userData.balance = response.balance || 0;
          userData.clicks = response.clicks_today || 0;
          userData.username = response.username || 'Guest';
          userData.bonusClaimed = response.bonus_claimed || false;
          updateUI();
        }
      } catch (error) {
        console.error('Failed to load user data:', error);
      }
    }

    // Security monitoring
    function startSecurityMonitoring() {
      securityTimer = setInterval(async () => {
        try {
          const response = await apiRequest('/api/security/check');
          if (response && response.restricted) {
            document.getElementById('security-alert').style.display = 'block';
          }
        } catch (error) {
          console.error('Security check failed:', error);
        }
      }, 30000); // Check every 30 seconds
    }

    // Page navigation
    function showPage(pageId) {
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });

      // Show selected page
      const targetPage = document.getElementById(`${pageId}-page`);
      if (targetPage) {
        targetPage.classList.add('active');
      }

      // Update navigation
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Find and activate corresponding nav button
      const navButtons = document.querySelectorAll('.nav-btn');
      const pages = ['home', 'watch', 'wallet', 'games', 'quests', 'otc', 'referrals'];
      const pageIndex = pages.indexOf(pageId);
      
      if (pageIndex !== -1 && navButtons[pageIndex]) {
        navButtons[pageIndex].classList.add('active');
      }
    }

    // Game functions
    function launchGame(gameName) {
      const gameNames = {
        'trivia': 'Crypto Trivia',
        'spin': 'Lucky Spin Wheel',
        'clicker': 'TON Clicker',
        'trex': 'T-Rex Runner',
        'edge-surf': 'Edge Surf'
      };

  

            // Get user data from Telegram WebApp
      const tg = window.Telegram?.WebApp;
      const userId = tg?.initDataUnsafe?.user?.id || 'guest';
      
      // Create simple token (timestamp-based)
      const token = btoa(`${userId}:${Date.now()}`);

      showAlert(
        'Launch Game',
        `Starting ${gameNames[gameName] || gameName}...`
      );
      
      // Launch game with user parameters
      const gameUrl = `/games/${gameName}?user_id=${userId}&token=${token}`;
      window.location.href = gameUrl;
      
    }
    
    // Core game actions
    async function claimDailyBonus() {
      try {
        const response = await apiRequest('/api/quests/claim_bonus', 'POST', {
          user_id: userData.id
        });

        if (response && response.success) {
          userData.balance = response.new_balance;
          userData.bonusClaimed = true;
          updateUI();
          
          showAlert('Bonus Claimed!', '+0.05 TON has been added to your balance!');
        } else {
          showAlert('Already Claimed', 'You have already claimed your daily bonus today.');
        }
      } catch (error) {
        console.error('Failed to claim bonus:', error);
      }
    }

    async function earnFromClick() {
      if (userData.clicks >= 100) {
        showAlert('Daily Limit Reached', 'Come back tomorrow for more clicks!');
        return;
      }

      try {
        const response = await apiRequest('/api/quests/record_click', 'POST', {
          user_id: userData.id
        });

        if (response && response.success) {
          userData.clicks = response.clicks;
          userData.balance = response.balance;
          updateUI();

          // Visual feedback
          const clickArea = document.querySelector('.click-area');
          if (clickArea) {
            clickArea.style.transform = 'scale(0.95)';
            setTimeout(() => {
              clickArea.style.transform = 'scale(1)';
            }, 150);
          }
        }
      } catch (error) {
        console.error('Failed to record click:', error);
      }
    }

    async function rewardedInterstitial() {
      try {
        // Show ad loading
        showAlert('Loading Ad', 'Please wait while we load your reward...');

        // Simulate ad viewing
        setTimeout(async () => {
          try {
            const response = await apiRequest('/api/ads/reward', 'POST', {
              user_id: userData.id,
              ad_id: 'monetag_9644715'
            });

            if (response && response.success) {
              userData.balance = response.new_balance;
              userData.adsWatched++;
              updateUI();

              const bonusText = response.weekend_boost ? ' (Weekend Bonus!)' : '';
              showAlert(
                'Ad Reward Earned!',
                `+${response.reward.toFixed(3)} TON has been added to your balance!${bonusText}`
              );
            }
          } catch (error) {
            console.error('Failed to process ad reward:', error);
          }
        }, 2000);
      } catch (error) {
        console.error('Failed to show ad:', error);
        showAlert('Ad Error', 'Failed to load ad. Please try again later.');
      }
    }

    // Wallet functions
    function receive() {
      showAlert('Receive TON', 'Connect your TON wallet to receive payments directly.');
    }

    function send() {
      showAlert('Send TON', 'Feature coming soon! You will be able to send TON to other users.');
    }

    function stake() {
      if (userData.balance < 5) {
        showAlert('Insufficient Balance', 'You need at least 5 TON to start staking.');
        return;
      }
      showAlert('Staking', 'Staking feature will be available soon! Earn 8.5% APY on your TON.');
    }

    // OTC functions
    function swapTon() {
      const amount = parseFloat(document.getElementById('otc-amount').value) || 0;
      const currency = document.getElementById('otc-currency').value;

      if (amount < 0.1) {
        showAlert('Invalid Amount', 'Minimum exchange amount is 0.1 TON.');
        return;
      }

      if (amount > userData.balance) {
        showAlert('Insufficient Balance', 'You do not have enough TON for this exchange.');
        return;
      }

      const rates = { USDT: 5.80, USD: 5.82, KES: 750, EUR: 5.32 };
      const converted = (amount * rates[currency]).toFixed(2);

      showAlert(
        'Exchange Initiated',
        `Exchanging ${amount} TON for ${converted} ${currency}. You will receive payment within 24 hours.`
      );
    }

    // Referral functions
    function copyReferralLink() {
      const link = document.getElementById('ref-link').textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
          showAlert('Link Copied', 'Your referral link has been copied to clipboard!');
        });
      } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = link;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showAlert('Link Copied', 'Your referral link has been copied!');
      }
    }

    function shareMission() {
      if (tg && tg.switchInlineQuery) {
        tg.switchInlineQuery('Join me on CryptoGameMiner and earn TON coins!');
      } else {
        showAlert('Share App', 'Share CryptoGameMiner with your friends to earn bonus rewards!');
      }
    }

    // Profile functions
    function showHelp() {
      showAlert(
        'Help & Support',
        'Need help? Contact our support team at support@cryptogameminer.com'
      );
    }

    function showAbout() {
      showAlert(
        'About CryptoGameMiner',
        'CryptoGameMiner v1.0 - Earn TON cryptocurrency by playing games, watching ads, and completing quests!'
      );
    }

    function showTerms() {
      showAlert(
        'Terms of Service',
        'Please read our full Terms of Service on our website. By using this app, you agree to our terms.'
      );
    }

    function showPrivacy() {
      showAlert(
        'Privacy Policy',
        'We respect your privacy. Read our full Privacy Policy on our website to learn how we protect your data.'
      );
    }

    // Input handlers for OTC
    document.addEventListener('DOMContentLoaded', () => {
      const amountInput = document.getElementById('otc-amount');
      const currencySelect = document.getElementById('otc-currency');
      const preview = document.getElementById('conversion-preview');
      const previewText = document.getElementById('conversion-text');

      function updateConversionPreview() {
        const amount = parseFloat(amountInput.value) || 0;
        const currency = currencySelect.value;
        
        if (amount > 0) {
          const rates = { USDT: 5.80, USD: 5.82, KES: 750, EUR: 5.32 };
          const converted = (amount * rates[currency]).toFixed(2);
          const fee = Math.max(amount * rates[currency] * 0.03, 1).toFixed(2);
          const final = (amount * rates[currency] - parseFloat(fee)).toFixed(2);
          
          previewText.innerHTML = `
            ${amount} TON â†’ ${converted} ${currency}<br>
            After fees: ${final} ${currency}
          `;
          preview.style.display = 'block';
        } else {
          preview.style.display = 'none';
        }
      }

      if (amountInput && currencySelect) {
        amountInput.addEventListener('input', updateConversionPreview);
        currencySelect.addEventListener('change', updateConversionPreview);
      }
    });

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Get user data from Telegram
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
          userData.id = tg.initDataUnsafe.user.id;
          userData.username = tg.initDataUnsafe.user.username || 
                             tg.initDataUnsafe.user.first_name || 
                             'Guest';
        }

        // Load user data from backend
        await loadUserData();

        // Start security monitoring
        startSecurityMonitoring();

        // Generate referral link
        if (userData.id) {
          document.getElementById('ref-link').textContent = 
            `https://t.me/CryptoGameMinerBot?start=ref-${userData.id}`;
        }

        // Show welcome message
        if (tg) {
          setTimeout(() => {
            showAlert(
              'Welcome to CryptoGameMiner!',
              `Start earning TON coins, ${userData.username}! ğŸ®ğŸ’°`
            );
          }, 1000);
        }

      } catch (error) {
        console.error('App initialization failed:', error);
        showAlert('Initialization Error', 'Failed to start the app. Please try refreshing.');
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (securityTimer) {
        clearInterval(securityTimer);
      }
    });
  </script>
</body>
</html>