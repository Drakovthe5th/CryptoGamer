<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🎮 CryptoGameMiner</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* All CSS from miniapp.html */
    :root {
      --bg-dark: #0d0d0d;
      --text-light: #f5f5f5;
      --primary-yellow: #ffcc00;
      --secondary-gray: #1a1a1a;
      --accent-green: #00e676;
      --gradient-purple: linear-gradient(135deg,#3f51b5,#9c27b0);
      --shadow-light: 0 2px 8px rgba(0,0,0,0.3);
      --shadow-heavy: 0 4px 12px rgba(0,0,0,0.5);
    }

    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }

    body {
      background: var(--bg-dark);
      color: var(--text-light);
      min-height: 100vh;
      padding-bottom: 80px;
      overflow-x: hidden;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 12px;
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--secondary-gray);
      border-top: 4px solid var(--primary-yellow);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .app-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      padding: 16px; 
      background: var(--secondary-gray);
      border-radius: 12px; 
      box-shadow: var(--shadow-heavy);
      margin-bottom: 16px;
    }

    .profile-btn {
      background: var(--gradient-purple);
      padding: 8px 12px; 
      border: none; 
      border-radius: 20px;
      color: #fff; 
      font-weight: 600; 
      cursor: pointer;
      display: flex; 
      align-items: center; 
      gap: 6px;
      box-shadow: var(--shadow-light);
      transition: transform 0.2s ease;
    }

    .profile-btn:hover, .profile-btn:active { 
      transform: scale(1.05); 
    }

    .balance-display {
      background: var(--accent-green); 
      padding: 8px 16px;
      border-radius: 20px; 
      font-weight: 700; 
      color: #000;
      box-shadow: var(--shadow-light);
      font-size: 1.1rem;
    }

    .wallet-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: rgba(0, 230, 118, 0.1);
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid var(--accent-green);
    }

    .wallet-status.disconnected {
      background: rgba(255, 68, 68, 0.1);
      border-color: #ff4444;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
    }

    .status-indicator.disconnected {
      background: #ff4444;
    }

    .security-alert {
      background: linear-gradient(135deg, #ff4444, #cc0000);
      color: white;
      padding: 12px;
      text-align: center;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
      font-weight: 600;
      box-shadow: var(--shadow-heavy);
    }

    .page { 
      display: none; 
      padding: 8px 0; 
      animation: fadeIn 0.3s ease-in; 
    }

    .page.active { 
      display: block; 
    }

    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    .section {
      background: var(--secondary-gray);
      border-radius: 12px; 
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-heavy);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .section-title {
      font-size: 1.4rem; 
      margin-bottom: 12px;
      background: var(--gradient-purple);
      -webkit-background-clip: text; 
      background-clip: text;
      color: transparent;
      font-weight: 700;
    }

    .btn {
      background: var(--primary-yellow);
      color: #000; 
      border: none; 
      border-radius: 10px;
      padding: 14px 20px; 
      font-weight: 700; 
      font-size: 1rem;
      width: 100%; 
      cursor: pointer; 
      margin: 8px 0;
      box-shadow: var(--shadow-light);
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn:hover, .btn:active {
      transform: translateY(-2px);
      box-shadow: var(--shadow-heavy);
      background: #ffdd33;
    }

    .btn:disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
      transform: none;
      box-shadow: var(--shadow-light);
    }

    .btn-secondary {
      background: transparent; 
      color: var(--primary-yellow);
      border: 2px solid var(--primary-yellow);
    }

    .btn-secondary:hover, .btn-secondary:active {
      background: var(--primary-yellow);
      color: #000;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
      width: auto;
      display: inline-block;
    }

    .withdrawal-form {
      display: none;
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 12px;
      margin-top: 16px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .withdrawal-form.active {
      display: block;
    }

    .input-group {
      margin-bottom: 16px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-light);
    }

    .click-area {
      background: linear-gradient(135deg, #111, #222);
      border: 3px dashed var(--primary-yellow);
      height: 180px; 
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer; 
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .click-area::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,204,0,0.2), transparent);
      transition: left 0.5s;
    }

    .click-area:hover::before {
      left: 100%;
    }

    .click-area:hover { 
      background: linear-gradient(135deg, #222, #333);
      transform: scale(1.02);
    }

    .click-area:active {
      transform: scale(0.98);
    }

    .click-text { 
      color: var(--primary-yellow); 
      font-size: 1.8rem; 
      font-weight: 800; 
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      z-index: 1;
    }

    .game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }

    .game-card {
      background: var(--secondary-gray);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .game-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-heavy);
      border-color: var(--primary-yellow);
    }

    .game-icon {
      width: 60px;
      height: 60px;
      background: var(--gradient-purple);
      border-radius: 50%;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .game-name {
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .nav-bar {
      position: fixed; 
      bottom: 0; 
      left: 0; 
      right: 0;
      background: var(--secondary-gray); 
      display: flex;
      justify-content: space-around; 
      padding: 12px 8px 20px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.5);
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .nav-btn {
      background: none; 
      border: none; 
      color: #888;
      display: flex; 
      flex-direction: column; 
      align-items: center;
      font-size: 0.75rem; 
      cursor: pointer; 
      transition: all 0.2s ease;
      padding: 8px 4px;
      border-radius: 8px;
      min-width: 50px;
    }

    .nav-btn.active { 
      color: var(--primary-yellow);
      background: rgba(255,204,0,0.1);
    }

    .nav-btn:hover:not(.active) {
      color: #ccc;
    }

    .nav-icon {
      font-size: 1.2rem;
      margin-bottom: 4px;
    }

    .quest-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .quest-item:last-child {
      border-bottom: none;
    }

    .referral-box {
      background: var(--gradient-purple); 
      padding: 20px;
      border-radius: 12px; 
      text-align: center; 
      color: #fff;
      box-shadow: var(--shadow-heavy);
      margin-bottom: 16px;
    }

    .referral-link {
      background: rgba(0,0,0,0.3); 
      color: var(--primary-yellow);
      padding: 12px; 
      border-radius: 8px; 
      margin: 12px 0;
      display: block; 
      word-break: break-all;
      font-family: monospace;
      font-size: 0.9rem;
      border: 1px solid rgba(255,204,0,0.3);
    }

    input, select {
      width: 100%; 
      padding: 12px; 
      margin: 8px 0; 
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px; 
      background: rgba(255,255,255,0.05); 
      color: #fff;
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-yellow);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 16px 0;
    }

    .stat-card {
      background: rgba(255,255,255,0.05);
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-yellow);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #ccc;
      margin-top: 4px;
    }

    .achievement-grid {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    .achievement-badge {
      background: var(--gradient-purple);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .transaction-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .transaction-type {
      font-weight: 600;
      color: var(--text-light);
    }

    .transaction-amount {
      font-weight: 700;
    }

    .transaction-amount.positive {
      color: var(--accent-green);
    }

    .transaction-amount.negative {
      color: #ff4444;
    }

    @media (max-width: 480px) {
      .container {
        padding: 8px;
      }
      
      .nav-bar {
        padding: 8px 4px 16px;
      }
      
      .nav-btn {
        font-size: 0.7rem;
        min-width: 45px;
      }
      
      .game-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .section {
        padding: 16px;
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    @keyframes slideInUp {
      from { 
        transform: translateY(100%); 
        opacity: 0; 
      }
      to { 
        transform: translateY(0); 
        opacity: 1; 
      }
    }

    .slide-in {
      animation: slideInUp 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading Spinner -->
    <div class="spinner-overlay" id="global-spinner">
      <div class="spinner"></div>
    </div>

    <!-- Security Alert -->
    <div class="security-alert" id="security-alert">
      ⚠️ Suspicious activity detected! Account temporarily restricted.
    </div>

    <!-- HEADER -->
    <header class="app-header slide-in">
      <button class="profile-btn" onclick="showPage('profile')">
        <span class="nav-icon">👤</span>
        <span id="profile-username">Guest</span>
      </button>
      <div class="balance-display">
        <span id="balance">0.000000</span> TON
      </div>
    </header>

    <!-- Wallet Status -->
    <div class="wallet-status" id="wallet-status">
      <div class="status-indicator" id="status-indicator"></div>
      <span id="wallet-status-text">Connecting to TON network...</span>
    </div>

    <!-- HOME -->
    <div id="home-page" class="page active">
      <div class="section slide-in">
        <h2 class="section-title">🎁 Daily Bonus</h2>
        <p style="margin-bottom: 16px; color: #ccc;">
          Grab your daily reward and keep the momentum going!
        </p>
        <button class="btn" id="bonus-btn" onclick="claimDailyBonus()">
          🎁 Claim Daily Bonus
        </button>
      </div>

      <div class="section slide-in">
        <h2 class="section-title">⚡ Click & Earn</h2>
        <div class="click-area" onclick="earnFromClick()">
          <div class="click-text">TAP TO EARN</div>
        </div>
        <p style="text-align: center; margin-top: 12px; color: #ccc;">
          Clicks today: <span id="click-count" style="color: var(--primary-yellow); font-weight: bold;">0</span>/100
        </p>
      </div>

      <div class="section slide-in">
        <h2 class="section-title">🎮 Featured Games</h2>
        <div class="game-grid">
          <div class="game-card" onclick="launchGame('trivia')">
            <div class="game-icon">❓</div>
            <div class="game-name">Crypto Trivia</div>
          </div>
          <div class="game-card" onclick="launchGame('spin')">
            <div class="game-icon">🎡</div>
            <div class="game-name">Lucky Spin</div>
          </div>
          <div class="game-card" onclick="launchGame('clicker')">
            <div class="game-icon">🖱️</div>
            <div class="game-name">TON Clicker</div>
          </div>
          <div class="game-card" onclick="launchGame('trex')">
            <div class="game-icon">🦖</div>
            <div class="game-name">T-Rex Runner</div>
          </div>
        </div>
      </div>
    </div>

    <!-- WATCH ADS -->
    <div id="watch-page" class="page">
      <div class="section">
        <h2 class="section-title">📺 Watch & Earn</h2>
        <p style="margin-bottom: 16px; color: #ccc;">
          Watch video ads and boost your TON balance instantly!
        </p>
        <button class="btn" onclick="rewardedInterstitial()">
          ▶️ Watch Ad & Earn TON
        </button>
        <div style="margin-top: 16px; padding: 12px; background: rgba(255,204,0,0.1); border-radius: 8px;">
          <small style="color: #ffcc00;">💡 Tip: Weekend ads give 20% bonus!</small>
        </div>
      </div>

      <!-- Ad Banner Space -->
      <div class="section" style="padding: 0; overflow: hidden; min-height: 200px;">
        <div style="width: 100%; height: 200px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
          <div style="text-align: center; color: #666;">
            <div style="font-size: 2rem; margin-bottom: 8px;">📺</div>
            <div>Ad Banner Placeholder</div>
          </div>
        </div>
      </div>
    </div>

    <!-- WALLET -->
    <div id="wallet-page" class="page">
      <div class="section">
        <h2 class="section-title">💰 Your Wallet</h2>
        <div style="text-align: center; margin: 20px 0;">
          <div style="font-size: 3rem; font-weight: 700; color: var(--accent-green);">
            <span id="wallet-balance">0.000000</span> TON
          </div>
          <div style="color: #888; margin-top: 8px;">Total Balance</div>
          <div style="font-size: 0.8rem; color: #666; margin-top: 4px;" id="wallet-address">
            Wallet: Loading...
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
          <button class="btn btn-secondary" onclick="showWithdrawalForm()">
            📤<br/>Withdraw
          </button>
          <button class="btn btn-secondary" onclick="showTransactionHistory()">
            📋<br/>History
          </button>
          <button class="btn btn-secondary" onclick="showPage('otc')">
            💱<br/>Trade
          </button>
        </div>

        <!-- Withdrawal Form -->
        <div class="withdrawal-form" id="withdrawal-form">
          <h3 style="margin-bottom: 16px; color: var(--primary-yellow);">Withdraw TON</h3>
          
          <div class="input-group">
            <label for="withdraw-address">TON Wallet Address</label>
            <input type="text" id="withdraw-address" placeholder="EQxxxxx..." />
          </div>
          
          <div class="input-group">
            <label for="withdraw-amount">Amount (TON)</label>
            <input type="number" id="withdraw-amount" placeholder="0.000000" step="0.000001" min="0.1" />
            <small style="color: #888;">Minimum withdrawal: 0.1 TON</small>
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" onclick="hideWithdrawalForm()">Cancel</button>
            <button class="btn" onclick="processWithdrawal()">Withdraw</button>
          </div>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">📈 Staking</h2>
        <div style="margin-bottom: 16px;">
          <p>Earn <span style="color: var(--accent-green); font-weight: bold;">8.5% APY</span> on deposits of 5+ TON</p>
          <small style="color: #888;">Rewards are distributed daily</small>
        </div>
        <button class="btn" onclick="startStaking()">
          💰 Start Staking (5 TON min)
        </button>
      </div>

      <div class="section">
        <h2 class="section-title">📊 Stats</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="total-earned">0.000000</div>
            <div class="stat-label">Total Earned</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="games-played">0</div>
            <div class="stat-label">Games Played</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="ads-watched">0</div>
            <div class="stat-label">Ads Watched</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="referrals-count">0</div>
            <div class="stat-label">Referrals</div>
          </div>
        </div>
      </div>

      <!-- Transaction History -->
      <div class="section" id="transaction-history" style="display: none;">
        <h2 class="section-title">📋 Recent Transactions</h2>
        <div id="transaction-list">
          <!-- Transactions will be loaded here -->
        </div>
      </div>
    </div>

    <!-- GAMES -->
    <div id="games-page" class="page">
      <div class="section">
        <h2 class="section-title">🎮 All Games</h2>
        <p style="margin-bottom: 20px; color: #ccc;">
          Play games, earn TON coins, and climb the leaderboards!
        </p>
        
        <div class="game-grid">
          <div class="game-card" onclick="launchGame('trivia')">
            <div class="game-icon">❓</div>
            <div class="game-name">Crypto Trivia</div>
            <small style="color: #888;">Test your knowledge</small>
          </div>
          
          <div class="game-card" onclick="launchGame('spin')">
            <div class="game-icon">🎡</div>
            <div class="game-name">Lucky Spin</div>
            <small style="color: #888;">Spin to win big</small>
          </div>
          
          <div class="game-card" onclick="launchGame('clicker')">
            <div class="game-icon">🖱️</div>
            <div class="game-name">TON Clicker</div>
            <small style="color: #888;">Click for rewards</small>
          </div>
          
          <div class="game-card" onclick="launchGame('trex')">
            <div class="game-icon">🦖</div>
            <div class="game-name">T-Rex Runner</div>
            <small style="color: #888;">Endless runner</small>
          </div>
          
          <div class="game-card" onclick="launchGame('edge-surf')">
            <div class="game-icon">🏄</div>
            <div class="game-name">Edge Surf</div>
            <small style="color: #888;">Surf the web</small>
          </div>
          
          <div class="game-card" style="opacity: 0.6;">
            <div class="game-icon">🎲</div>
            <div class="game-name">More Games</div>
            <small style="color: #888;">Coming soon</small>
          </div>
        </div>
      </div>
    </div>

    <!-- QUESTS -->
    <div id="quests-page" class="page">
      <div class="section">
        <h2 class="section-title">📝 Daily Quests</h2>
        <p style="margin-bottom: 16px; color: #ccc;">
          Complete daily tasks to earn bonus rewards!
        </p>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">✅ Claim Daily Bonus</div>
            <small style="color: #888;">Reward: <span id="quest-bonus-reward">0.01</span> TON</small>
          </div>
          <button class="btn btn-small" id="quest-bonus" onclick="claimDailyBonus()">Claim</button>
        </div>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">📺 Watch 3 Ads</div>
            <small style="color: #888;">Progress: <span id="quest-ads">0</span>/3 | Reward: <span id="quest-ads-reward">0.009</span> TON</small>
          </div>
          <button class="btn btn-small btn-secondary" onclick="showPage('watch')">Watch</button>
        </div>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">🎮 Play 2 Games</div>
            <small style="color: #888;">Progress: <span id="quest-games">0</span>/2 | Reward: <span id="quest-games-reward">0.006</span> TON</small>
          </div>
          <button class="btn btn-small btn-secondary" onclick="showPage('games')">Play</button>
        </div>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">👥 Invite 1 Friend</div>
            <small style="color: #888;">Progress: <span id="quest-invite">0</span>/1 | Reward: <span id="quest-invite-reward">0.05</span> TON</small>
          </div>
          <button class="btn btn-small btn-secondary" onclick="showPage('referrals')">Invite</button>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">🏆 Weekly Challenges</h2>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">🔥 7-Day Streak</div>
            <small style="color: #888;">Login daily for a week | Reward: 0.5 TON</small>
          </div>
          <div style="color: var(--primary-yellow); font-weight: bold;" id="daily-streak">0/7</div>
        </div>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">💯 Score 1000+ Points</div>
            <small style="color: #888;">In any game | Reward: 0.1 TON</small>
          </div>
          <div style="color: #888;" id="high-score">0/1000</div>
        </div>
        
        <div class="quest-item">
          <div>
            <div style="font-weight: 600;">📱 Share App</div>
            <small style="color: #888;">Share with 5 friends | Reward: 0.25 TON</small>
          </div>
          <button class="btn btn-small btn-secondary" onclick="shareMission()">Share</button>
        </div>
      </div>
    </div>

    <!-- OTC TRADING -->
    <div id="otc-page" class="page">
      <div class="section">
        <h2 class="section-title">💱 OTC Exchange</h2>
        <p style="margin-bottom: 20px; color: #ccc;">
          Trade your TON for fiat currencies instantly!
        </p>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Amount (TON)</label>
          <input type="number" id="otc-amount" placeholder="0.000000" step="0.000001" min="0.1" />
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Currency</label>
          <select id="otc-currency">
            <option value="USDT">USDT (Tether)</option>
            <option value="USD">USD (US Dollar)</option>
            <option value="KES">KES (Kenyan Shilling)</option>
            <option value="EUR">EUR (Euro)</option>
          </select>
        </div>
        
        <div id="conversion-preview" style="background: rgba(255,204,0,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;">
          <div style="color: var(--primary-yellow); font-weight: 600;">Conversion Preview:</div>
          <div id="conversion-text"></div>
          <small style="color: #888;" id="fee-text">Fee: 3% (min $1.00)</small>
        </div>
        
        <button class="btn" onclick="swapTon()">
          💱 Start Exchange
        </button>
      </div>

      <div class="section">
        <h2 class="section-title">💹 Current Rates</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="rate-usd">$6.80</div>
            <div class="stat-label">1 TON = USD</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="rate-kes">950</div>
            <div class="stat-label">1 TON = KES</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="rate-eur">€6.20</div>
            <div class="stat-label">1 TON = EUR</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="rate-usdt">6.75</div>
            <div class="stat-label">1 TON = USDT</div>
          </div>
        </div>
        <small style="color: #888; display: block; text-align: center; margin-top: 12px;">
          ⏰ Rates updated every 5 minutes
        </small>
      </div>
    </div>

    <!-- REFERRALS -->
    <div id="referrals-page" class="page">
      <div class="referral-box">
        <h2>👥 Invite & Earn</h2>
        <p style="margin: 12px 0;">Earn 20% of your friends' earnings forever!</p>
        <div class="referral-link" id="ref-link">
          https://t.me/CryptoGameMinerBot?start=ref-xyz123
        </div>
        <button class="btn" onclick="copyReferralLink()" style="background: rgba(255,255,255,0.2); color: white;">
          📋 Copy Invite Link
        </button>
      </div>

      <div class="section">
        <h2 class="section-title">📊 Your Referral Stats</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="ref-count">0</div>
            <div class="stat-label">Friends Invited</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="ref-earnings">0.000000</div>
            <div class="stat-label">Total Earned (TON)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="ref-active">0</div>
            <div class="stat-label">Active This Week</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="ref-level">1</div>
            <div class="stat-label">Referrer Level</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">🎯 Referral Milestones</h2>
        <div style="margin: 16px 0;">
          <div class="quest-item">
            <span>🥉 3 referrals → Bonus 0.01 TON</span>
            <span style="color: var(--accent-green);" id="milestone-3">0/3</span>
          </div>
          <div class="quest-item">
            <span>🥈 10 referrals → Bonus 0.05 TON</span>
            <span style="color: #888;" id="milestone-10">0/10</span>
          </div>
          <div class="quest-item">
            <span>🥇 50 referrals → Bonus 0.25 TON</span>
            <span style="color: #888;" id="milestone-50">0/50</span>
          </div>
          <div class="quest-item">
            <span>💎 100 referrals → Bonus 1.0 TON</span>
            <span style="color: #888;" id="milestone-100">0/100</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="profile-page" class="page">
      <div class="section">
        <h2 class="section-title">👤 Profile</h2>
        <div style="text-align: center; margin: 20px 0;">
          <div style="width: 80px; height: 80px; background: var(--gradient-purple); border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
            👤
          </div>
          <h3 id="profile-name">Guest</h3>
          <p style="color: #888;" id="member-since">Member since today</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; margin: 16px 0;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Current Balance:</span>
            <span style="color: var(--accent-green); font-weight: bold;"><span id="profile-balance">0.000000</span> TON</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Total Earned:</span>
            <span style="color: var(--primary-yellow); font-weight: bold;"><span id="profile-total-earned">0.000000</span> TON</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>Account Level:</span>
            <span style="color: #888;" id="account-level">Beginner</span>
          </div>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">🏆 Achievements</h2>
        <div class="achievement-grid" id="achievements-list">
          <div class="achievement-badge">🎯 First Click</div>
          <div class="achievement-badge">📺 Ad Watcher</div>
          <div class="achievement-badge" style="opacity: 0.5;">🎮 Game Master</div>
          <div class="achievement-badge" style="opacity: 0.5;">💰 Big Earner</div>
          <div class="achievement-badge" style="opacity: 0.5;">👥 Influencer</div>
          <div class="achievement-badge" style="opacity: 0.5;">⭐ VIP Member</div>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">⚙️ Settings & Info</h2>
        <button class="btn btn-secondary" onclick="showHelp()">
          ❓ Help & Support
        </button>
        <button class="btn btn-secondary" onclick="showAbout()">
          📜 About CryptoGameMiner
        </button>
        <button class="btn btn-secondary" onclick="showTerms()">
          📄 Terms of Service
        </button>
        <button class="btn btn-secondary" onclick="showPrivacy()">
          🔒 Privacy Policy
        </button>
      </div>
    </div>

  </div>

  <!-- NAVIGATION -->
  <nav class="nav-bar">
    <button class="nav-btn active" onclick="showPage('home')">
      <span class="nav-icon">🏠</span>
      <span>Home</span>
    </button>
    <button class="nav-btn" onclick="showPage('watch')">
      <span class="nav-icon">📺</span>
      <span>Watch</span>
    </button>
    <button class="nav-btn" onclick="showPage('wallet')">
      <span class="nav-icon">💰</span>
      <span>Wallet</span>
    </button>
    <button class="nav-btn" onclick="showPage('games')">
      <span class="nav-icon">🎮</span>
      <span>Games</span>
    </button>
    <button class="nav-btn" onclick="showPage('quests')">
      <span class="nav-icon">📝</span>
      <span>Quests</span>
    </button>
    <button class="nav-btn" onclick="showPage('otc')">
      <span class="nav-icon">💱</span>
      <span>Trade</span>
    </button>
    <button class="nav-btn" onclick="showPage('referrals')">
      <span class="nav-icon">👥</span>
      <span>Invite</span>
    </button>
  </nav>

  <script>
    // Initialize Telegram WebApp
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      tg.enableClosingConfirmation();
    }

    // Configuration from backend
    const CONFIG = {
      MIN_WITHDRAWAL: 0.1,
      DAILY_WITHDRAWAL_LIMIT: 10.0,
      USER_DAILY_WITHDRAWAL_LIMIT: 100.0,
      OTC_RATES: {
        USD: 6.80,
        EUR: 6.20,
        KES: 950,
        USDT: 6.75
      },
      OTC_FEE_PERCENT: 3.0,
      MIN_OTC_FEE: 1.0,
      REWARDS: {
        faucet: 0.01,
        trivia_correct: 0.005,
        trivia_incorrect: 0.001,
        spin_win: 0.02,
        spin_loss: 0.001,
        ad_view: 0.003,
        referral: 0.05,
        quest: 0.03
      }
    };

    // Application state
    let userData = {
      id: null,
      username: 'Guest',
      balance: 0,
      clicks: 0,
      referrals: 0,
      refEarnings: 0,
      bonusClaimed: false,
      adsWatched: 0,
      gamesPlayed: 0,
      totalEarned: 0,
      walletAddress: null,
      memberSince: new Date().toLocaleDateString()
    };

    let walletStatus = {
      connected: false,
      healthy: false,
      address: null,
      network: 'mainnet'
    };

    // Utility functions
    function formatTON(amount) {
      return parseFloat(amount || 0).toFixed(6);
    }

    function generateSecurityToken() {
    const timestamp = Math.floor(Date.now() / 1000);
    const data = `${userData.id || 'anon'}:${timestamp}`;
    return btoa(data)
        .replace(/\+/g, '-')  // URL-safe encoding
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    function showSpinner() {
      document.getElementById('global-spinner').style.display = 'flex';
    }

    function hideSpinner() {
      document.getElementById('global-spinner').style.display = 'none';
    }

    function showAlert(title, message) {
      if (tg && tg.showPopup) {
        tg.showPopup({
          title: title,
          message: message,
          buttons: [{ id: 'ok', type: 'ok' }]
        });
      } else {
        alert(`${title}: ${message}`);
      }
    }

    function showConfirm(title, message, callback) {
      if (tg && tg.showPopup) {
        tg.showPopup({
          title: title,
          message: message,
          buttons: [
            { id: 'cancel', type: 'cancel' },
            { id: 'ok', type: 'ok' }
          ]
        }, (buttonId) => {
          if (buttonId === 'ok') callback();
        });
      } else {
        if (confirm(`${title}: ${message}`)) callback();
      }
    }

    // API request helper with TON-specific error handling
    async function apiRequest(endpoint, method = 'GET', body = null) {
      const headers = {
        'Content-Type': 'application/json',
        'X-Telegram-User-ID': userData.id || '',
        'X-Telegram-InitData': tg?.initData || '',
        'X-Security-Token': generateSecurityToken()
      };

      try {
        showSpinner();
        
        const options = { method, headers };
        if (body) {
          options.body = JSON.stringify(body);
        }

        const response = await fetch(endpoint, options);

        // Handle specific TON-related errors
        if (response.status === 403) {
          document.getElementById('security-alert').style.display = 'block';
          showAlert('Account Restricted', 'Please contact support for assistance.');
          return null;
        }

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Request failed');
        }

        return await response.json();
      } catch (error) {
        console.error('API request failed:', error);
        
        // Handle specific TON errors
        if (error.message.includes('insufficient')) {
          showAlert('Insufficient Balance', 'You do not have enough TON for this operation.');
        } else if (error.message.includes('invalid address')) {
          showAlert('Invalid Address', 'Please check the TON wallet address format.');
        } else if (error.message.includes('daily limit')) {
          showAlert('Daily Limit', 'Daily withdrawal limit exceeded. Try again tomorrow.');
        } else {
          showAlert('Error', error.message || 'Something went wrong');
        }
        throw error;
      } finally {
        hideSpinner();
      }
    }

    // Update wallet status
    function updateWalletStatus() {
      const statusEl = document.getElementById('wallet-status');
      const indicatorEl = document.getElementById('status-indicator');
      const textEl = document.getElementById('wallet-status-text');

      if (walletStatus.connected && walletStatus.healthy) {
        statusEl.classList.remove('disconnected');
        indicatorEl.classList.remove('disconnected');
        textEl.textContent = `Connected to TON ${walletStatus.network}`;
      } else {
        statusEl.classList.add('disconnected');
        indicatorEl.classList.add('disconnected');
        textEl.textContent = 'TON wallet connection issues';
      }
    }

    // Update UI elements
    function updateUI() {
      // Update balance displays with proper TON formatting
      document.querySelectorAll('#balance, #wallet-balance, #profile-balance').forEach(el => {
        el.textContent = formatTON(userData.balance);
      });

      // Update wallet address
      const walletAddressEl = document.getElementById('wallet-address');
      if (walletAddressEl && walletStatus.address) {
        const shortAddr = `${walletStatus.address.slice(0, 6)}...${walletStatus.address.slice(-6)}`;
        walletAddressEl.textContent = `Wallet: ${shortAddr}`;
      }

      // Update other displays
      document.getElementById('click-count').textContent = userData.clicks;
      document.getElementById('total-earned').textContent = formatTON(userData.totalEarned);
      document.getElementById('profile-total-earned').textContent = formatTON(userData.totalEarned);

      // Update username displays
      document.querySelectorAll('#profile-username, #profile-name').forEach(el => {
        el.textContent = userData.username;
      });

      // Update referral stats
      document.getElementById('ref-count').textContent = userData.referrals;
      document.getElementById('ref-earnings').textContent = formatTON(userData.refEarnings);

      // Update quest progress
      document.getElementById('quest-ads').textContent = userData.adsWatched;
      document.getElementById('quest-games').textContent = userData.gamesPlayed;

      // Update quest rewards from config
      document.getElementById('quest-bonus-reward').textContent = formatTON(CONFIG.REWARDS.faucet);
      document.getElementById('quest-ads-reward').textContent = formatTON(CONFIG.REWARDS.ad_view * 3);
      document.getElementById('quest-games-reward').textContent = formatTON(CONFIG.REWARDS.quest * 0.2);
      document.getElementById('quest-invite-reward').textContent = formatTON(CONFIG.REWARDS.referral);

      // Update bonus button
      const bonusBtn = document.getElementById('bonus-btn');
      if (bonusBtn) {
        if (userData.bonusClaimed) {
          bonusBtn.textContent = '✅ Bonus Claimed Today';
          bonusBtn.disabled = true;
          bonusBtn.style.background = '#666';
        } else {
          bonusBtn.textContent = `🎁 Claim ${formatTON(CONFIG.REWARDS.faucet)} TON`;
          bonusBtn.disabled = false;
          bonusBtn.style.background = 'var(--primary-yellow)';
        }
      }

      // Update OTC rates
      document.getElementById('rate-usd').textContent = `${CONFIG.OTC_RATES.USD}`;
      document.getElementById('rate-eur').textContent = `€${CONFIG.OTC_RATES.EUR}`;
      document.getElementById('rate-kes').textContent = CONFIG.OTC_RATES.KES;
      document.getElementById('rate-usdt').textContent = CONFIG.OTC_RATES.USDT;

      // Update member since
      document.getElementById('member-since').textContent = `Member since ${userData.memberSince}`;
    }

    // Load user data and wallet status
    async function loadUserData() {
      try {
        const response = await apiRequest('/api/user/data');
        if (response) {
          userData.balance = response.balance || 0;
          userData.clicks = response.clicks_today || 0;
          userData.username = response.username || 'Guest';
          userData.bonusClaimed = response.bonus_claimed || false;
          userData.adsWatched = response.ads_watched || 0;
          userData.gamesPlayed = response.games_played || 0;
          userData.totalEarned = response.total_earned || 0;
          userData.referrals = response.referrals || 0;
          userData.refEarnings = response.ref_earnings || 0;
          userData.memberSince = response.member_since || new Date().toLocaleDateString();
          updateUI();
        }
      } catch (error) {
        console.error('Failed to load user data:', error);
      }
    }

    // Load wallet status
    async function loadWalletStatus() {
      try {
        const response = await apiRequest('/api/wallet/status');
        if (response) {
          walletStatus.connected = response.initialized || false;
          walletStatus.healthy = response.healthy || false;
          walletStatus.address = response.address || null;
          walletStatus.network = response.network || 'mainnet';
          updateWalletStatus();
        }
      } catch (error) {
        console.error('Failed to load wallet status:', error);
        walletStatus.connected = false;
        walletStatus.healthy = false;
        updateWalletStatus();
      }
    }

    // Page navigation
    function showPage(pageId) {
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });

      // Show selected page
      const targetPage = document.getElementById(`${pageId}-page`);
      if (targetPage) {
        targetPage.classList.add('active');
      }

      // Update navigation
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Find and activate corresponding nav button
      const navButtons = document.querySelectorAll('.nav-btn');
      const pages = ['home', 'watch', 'wallet', 'games', 'quests', 'otc', 'referrals'];
      const pageIndex = pages.indexOf(pageId);
      
      if (pageIndex !== -1 && navButtons[pageIndex]) {
        navButtons[pageIndex].classList.add('active');
      }

      // Load page-specific data
      if (pageId === 'wallet') {
        loadWalletStatus();
      }
    }

    // Game functions
    function launchGame(gameName) {
      const gameNames = {
        'trivia': 'Crypto Trivia',
        'spin': 'Lucky Spin Wheel',
        'clicker': 'TON Clicker',
        'trex': 'T-Rex Runner',
        'edge-surf': 'Edge Surf'
      };

      const userId = userData.id || 'guest';
      const token = generateSecurityToken();

      showAlert(
        'Launch Game',
        `Starting ${gameNames[gameName] || gameName}...`
      );
      
      // Initialize game session
      apiRequest('/api/game/init', 'POST', {
        user_id: userId,
        game_name: gameName
      }).then(() => {
        const gameUrl = `/games/${gameName}?user_id=${userId}&token=${token}`;
        window.location.href = gameUrl;
      }).catch(error => {
        console.error('Failed to initialize game:', error);
      });
    }

    // Core game actions
    async function claimDailyBonus() {
      try {
        const response = await apiRequest('/api/bonus/claim', 'POST', {
          user_id: userData.id
        });

        if (response && response.success) {
          userData.balance = response.new_balance;
          userData.bonusClaimed = true;
          userData.totalEarned += CONFIG.REWARDS.faucet;
          updateUI();
          
          showAlert('Bonus Claimed!', `+${formatTON(CONFIG.REWARDS.faucet)} TON has been added to your balance!`);
        } else {
          showAlert('Already Claimed', 'You have already claimed your daily bonus today.');
        }
      } catch (error) {
        console.error('Failed to claim bonus:', error);
      }
    }

    async function earnFromClick() {
      if (userData.clicks >= 100) {
        showAlert('Daily Limit Reached', 'Come back tomorrow for more clicks!');
        return;
      }

      try {
        const response = await apiRequest('/api/click', 'POST', {
          user_id: userData.id
        });

        if (response && response.success) {
          userData.clicks = response.clicks;
          userData.balance = response.balance;
          userData.totalEarned += response.reward || 0.001;
          updateUI();

          // Visual feedback
          const clickArea = document.querySelector('.click-area');
          if (clickArea) {
            clickArea.style.transform = 'scale(0.95)';
            setTimeout(() => {
              clickArea.style.transform = 'scale(1)';
            }, 150);
          }
        }
      } catch (error) {
        console.error('Failed to record click:', error);
      }
    }

    async function rewardedInterstitial() {
      try {
        showAlert('Loading Ad', 'Please wait while we load your reward...');

        setTimeout(async () => {
          try {
            const response = await apiRequest('/api/ads/reward', 'POST', {
              user_id: userData.id
            });

            if (response && response.success) {
              userData.balance = response.new_balance;
              userData.adsWatched++;
              userData.totalEarned += response.reward;
              updateUI();

              const bonusText = response.weekend_boost ? ' (Weekend Bonus!)' : '';
              showAlert(
                'Ad Reward Earned!',
                `+${formatTON(response.reward)} TON has been added to your balance!${bonusText}`
              );
            }
          } catch (error) {
            console.error('Failed to process ad reward:', error);
          }
        }, 2000);
      } catch (error) {
        console.error('Failed to show ad:', error);
        showAlert('Ad Error', 'Failed to load ad. Please try again later.');
      }
    }

    // Wallet functions
    function showWithdrawalForm() {
      document.getElementById('withdrawal-form').classList.add('active');
    }

    function hideWithdrawalForm() {
      document.getElementById('withdrawal-form').classList.remove('active');
    }

    async function processWithdrawal() {
      const address = document.getElementById('withdraw-address').value.trim();
      const amount = parseFloat(document.getElementById('withdraw-amount').value) || 0;

      if (!address) {
        showAlert('Invalid Address', 'Please enter a valid TON wallet address.');
        return;
      }

      if (amount < CONFIG.MIN_WITHDRAWAL) {
        showAlert('Invalid Amount', `Minimum withdrawal is ${CONFIG.MIN_WITHDRAWAL} TON.`);
        return;
      }

      if (amount > userData.balance) {
        showAlert('Insufficient Balance', 'You do not have enough TON for this withdrawal.');
        return;
      }

      showConfirm(
        'Confirm Withdrawal',
        `Withdraw ${formatTON(amount)} TON to ${address.slice(0, 10)}...?`,
        async () => {
          try {
            const response = await apiRequest('/api/withdraw', 'POST', {
              method: 'ton',
              amount: amount,
              address: address
            });

            if (response && response.success) {
              userData.balance -= amount;
              updateUI();
              hideWithdrawalForm();
              
              showAlert(
                'Withdrawal Submitted!',
                `Your withdrawal of ${formatTON(amount)} TON is being processed. TX: ${response.tx_hash || 'Processing'}`
              );
            }
          } catch (error) {
            console.error('Withdrawal failed:', error);
          }
        }
      );
    }

    async function showTransactionHistory() {
      try {
        const response = await apiRequest('/api/transactions');
        const historySection = document.getElementById('transaction-history');
        const transactionList = document.getElementById('transaction-list');

        if (response && response.transactions) {
          transactionList.innerHTML = '';
          
          response.transactions.forEach(tx => {
            const txEl = document.createElement('div');
            txEl.className = 'transaction-item';
            
            const isPositive = tx.type === 'incoming' || tx.amount > 0;
            const amountClass = isPositive ? 'positive' : 'negative';
            const sign = isPositive ? '+' : '-';
            
            txEl.innerHTML = `
              <div>
                <div class="transaction-type">${tx.type || 'Transaction'}</div>
                <small style="color: #888;">${new Date(tx.timestamp * 1000).toLocaleDateString()}</small>
              </div>
              <div class="transaction-amount ${amountClass}">
                ${sign}${formatTON(Math.abs(tx.value || tx.amount))} TON
              </div>
            `;
            
            transactionList.appendChild(txEl);
          });
          
          historySection.style.display = 'block';
        } else {
          transactionList.innerHTML = '<p style="color: #888; text-align: center;">No transactions found</p>';
          historySection.style.display = 'block';
        }
      } catch (error) {
        console.error('Failed to load transaction history:', error);
      }
    }

    async function startStaking() {
      if (userData.balance < 5) {
        showAlert('Insufficient Balance', 'You need at least 5 TON to start staking.');
        return;
      }

      showConfirm(
        'Start Staking',
        'Stake your TON to earn 8.5% APY. Minimum stake is 5 TON. Continue?',
        async () => {
          try {
            const response = await apiRequest('/api/staking/create', 'POST', {
              amount: 5,
              user_id: userData.id
            });

            if (response && response.success) {
              userData.balance -= 5;
              updateUI();
              showAlert('Staking Started!', `Successfully staked 5 TON. Contract: ${response.contract_address || 'Processing'}`);
            }
          } catch (error) {
            console.error('Staking failed:', error);
          }
        }
      );
    }

    // OTC functions
    function updateConversionPreview() {
      const amount = parseFloat(document.getElementById('otc-amount').value) || 0;
      const currency = document.getElementById('otc-currency').value;
      const preview = document.getElementById('conversion-preview');
      const previewText = document.getElementById('conversion-text');
      const feeText = document.getElementById('fee-text');
      
      if (amount > 0 && CONFIG.OTC_RATES[currency]) {
        const rate = CONFIG.OTC_RATES[currency];
        const converted = (amount * rate).toFixed(2);
        const fee = Math.max(amount * rate * (CONFIG.OTC_FEE_PERCENT / 100), CONFIG.MIN_OTC_FEE).toFixed(2);
        const final = (amount * rate - parseFloat(fee)).toFixed(2);
        
        previewText.innerHTML = `
          ${formatTON(amount)} TON → ${converted} ${currency}<br>
          After fees: ${final} ${currency}
        `;
        feeText.textContent = `Fee: ${CONFIG.OTC_FEE_PERCENT}% (min ${CONFIG.MIN_OTC_FEE})`;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    }

    async function swapTon() {
      const amount = parseFloat(document.getElementById('otc-amount').value) || 0;
      const currency = document.getElementById('otc-currency').value;

      if (amount < 0.1) {
        showAlert('Invalid Amount', 'Minimum exchange amount is 0.1 TON.');
        return;
      }

      if (amount > userData.balance) {
        showAlert('Insufficient Balance', 'You do not have enough TON for this exchange.');
        return;
      }

      const rate = CONFIG.OTC_RATES[currency];
      const converted = (amount * rate).toFixed(2);

      showConfirm(
        'Confirm Exchange',
        `Exchange ${formatTON(amount)} TON for ${converted} ${currency}?`,
        async () => {
          try {
            const response = await apiRequest('/api/otc/exchange', 'POST', {
              amount: amount,
              currency: currency,
              user_id: userData.id
            });

            if (response && response.success) {
              userData.balance -= amount;
              updateUI();
              
              showAlert(
                'Exchange Initiated',
                `Exchanging ${formatTON(amount)} TON for ${converted} ${currency}. You will receive payment within 24 hours.`
              );
            }
          } catch (error) {
            console.error('OTC exchange failed:', error);
          }
        }
      );
    }

    // Referral functions
    function copyReferralLink() {
      const link = document.getElementById('ref-link').textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
          showAlert('Link Copied', 'Your referral link has been copied to clipboard!');
        });
      } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = link;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showAlert('Link Copied', 'Your referral link has been copied!');
      }
    }

    function shareMission() {
      if (tg && tg.switchInlineQuery) {
        tg.switchInlineQuery('Join me on CryptoGameMiner and earn TON coins!');
      } else {
        showAlert('Share App', 'Share CryptoGameMiner with your friends to earn bonus rewards!');
      }
    }

    // Profile functions
    function showHelp() {
      showAlert(
        'Help & Support',
        'Need help? Contact our support team at support@cryptogameminer.com or join our Telegram support group.'
      );
    }

    function showAbout() {
      showAlert(
        'About CryptoGameMiner',
        'CryptoGameMiner v2.0 - Earn real TON cryptocurrency by playing games, watching ads, and completing quests! Powered by TON blockchain.'
      );
    }

    function showTerms() {
      showAlert(
        'Terms of Service',
        'Please read our full Terms of Service on our website. By using this app, you agree to our terms and TON blockchain policies.'
      );
    }

    function showPrivacy() {
      showAlert(
        'Privacy Policy',
        'We respect your privacy and protect your TON wallet data. Read our full Privacy Policy on our website.'
      );
    }

    // Security monitoring
    let securityTimer = null;
    function startSecurityMonitoring() {
      securityTimer = setInterval(async () => {
        try {
          const response = await apiRequest('/api/security/check');
          if (response && response.restricted) {
            document.getElementById('security-alert').style.display = 'block';
          }
        } catch (error) {
          console.error('Security check failed:', error);
        }
      }, 30000); // Check every 30 seconds
    }

    // Input handlers for OTC
    document.addEventListener('DOMContentLoaded', () => {
      const amountInput = document.getElementById('otc-amount');
      const currencySelect = document.getElementById('otc-currency');

      if (amountInput && currencySelect) {
        amountInput.addEventListener('input', updateConversionPreview);
        currencySelect.addEventListener('change', updateConversionPreview);
      }

      // Withdrawal form validation
      const withdrawAddress = document.getElementById('withdraw-address');
      const withdrawAmount = document.getElementById('withdraw-amount');

      if (withdrawAddress) {
        withdrawAddress.addEventListener('input', (e) => {
          const address = e.target.value.trim();
          if (address && !address.match(/^[UE]Q[A-Za-z0-9_-]{46}$/)) {
            e.target.style.borderColor = '#ff4444';
          } else {
            e.target.style.borderColor = 'var(--primary-yellow)';
          }
        });
      }

      if (withdrawAmount) {
        withdrawAmount.addEventListener('input', (e) => {
          const amount = parseFloat(e.target.value) || 0;
          if (amount < CONFIG.MIN_WITHDRAWAL || amount > userData.balance) {
            e.target.style.borderColor = '#ff4444';
          } else {
            e.target.style.borderColor = 'var(--primary-yellow)';
          }
        });
      }
    });

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Get user data from Telegram
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
          userData.id = tg.initDataUnsafe.user.id;
          userData.username = tg.initDataUnsafe.user.username || 
                             tg.initDataUnsafe.user.first_name || 
                             'Guest';
        }

        // Load user data and wallet status from backend
        await Promise.all([
          loadUserData(),
          loadWalletStatus()
        ]);

        // Start security monitoring
        startSecurityMonitoring();

        // Generate referral link
        if (userData.id) {
          document.getElementById('ref-link').textContent = 
            `https://t.me/CryptoGameMinerBot?start=ref-${userData.id}`;
        }

        // Update referral milestones
        updateReferralMilestones();

        // Show welcome message
        if (tg && !sessionStorage.getItem('welcomed')) {
          setTimeout(() => {
            showAlert(
              'Welcome to CryptoGameMiner!',
              `Start earning real TON cryptocurrency, ${userData.username}! 🎮💰`
            );
            sessionStorage.setItem('welcomed', 'true');
          }, 1000);
        }

        // Check for low balance alert
        if (userData.balance < 0.01) {
          setTimeout(() => {
            showAlert(
              'Get Started!',
              'Claim your daily bonus and start clicking to earn your first TON coins!'
            );
          }, 3000);
        }

      } catch (error) {
        console.error('App initialization failed:', error);
        showAlert('Initialization Error', 'Failed to start the app. Please try refreshing.');
      }
    });

    // Update referral milestones based on current referral count
    function updateReferralMilestones() {
      const milestones = [
        { id: 'milestone-3', target: 3 },
        { id: 'milestone-10', target: 10 },
        { id: 'milestone-50', target: 50 },
        { id: 'milestone-100', target: 100 }
      ];

      milestones.forEach(milestone => {
        const el = document.getElementById(milestone.id);
        if (el) {
          const current = Math.min(userData.referrals, milestone.target);
          el.textContent = `${current}/${milestone.target}`;
          
          if (current >= milestone.target) {
            el.style.color = 'var(--accent-green)';
            el.textContent = '✅';
          }
        }
      });
    }

    // Periodic data refresh
    setInterval(async () => {
      try {
        await loadUserData();
        if (document.querySelector('.nav-btn.active')?.textContent.includes('Wallet')) {
          await loadWalletStatus();
        }
      } catch (error) {
        console.error('Periodic refresh failed:', error);
      }
    }, 30000); // Refresh every 30 seconds

    // Handle TON network events
    window.addEventListener('tonconnect-ui-connection-restoring-started', () => {
      walletStatus.connected = false;
      updateWalletStatus();
    });

    window.addEventListener('tonconnect-ui-connection-restoring-completed', () => {
      loadWalletStatus();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (securityTimer) {
        clearInterval(securityTimer);
      }
    });

    // Handle Telegram WebApp theme changes
    if (tg) {
      tg.onEvent('themeChanged', () => {
        // Update CSS variables based on Telegram theme
        const theme = tg.colorScheme;
        if (theme === 'light') {
          document.documentElement.style.setProperty('--bg-dark', '#ffffff');
          document.documentElement.style.setProperty('--text-light', '#000000');
          document.documentElement.style.setProperty('--secondary-gray', '#f0f0f0');
        }
      });

      // Handle main button
      tg.MainButton.setText('Open Game');
      tg.MainButton.onClick(() => {
        showPage('games');
      });
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.altKey) {
        switch(e.key) {
          case '1': showPage('home'); break;
          case '2': showPage('watch'); break;
          case '3': showPage('wallet'); break;
          case '4': showPage('games'); break;
          case '5': showPage('quests'); break;
          case '6': showPage('otc'); break;
          case '7': showPage('referrals'); break;
        }
      }
    });

    // Export functions for debugging
    window.CryptoGameMiner = {
      userData,
      walletStatus,
      CONFIG,
      apiRequest,
      loadUserData,
      loadWalletStatus,
      showPage
    };
  </script>
</body>
</html>